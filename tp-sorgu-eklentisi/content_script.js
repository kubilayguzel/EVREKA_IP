// TP - Marka Dosya Sorgu (content script) ‚Äî opts.turkpatent.gov.tr i√ßin
// v2.0 - Daha g√ºvenilir ve debug friendly

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

console.log('[TP Eklenti] Content script y√ºklendi');
console.log('[TP Eklenti] URL:', window.location.href);
console.log('[TP Eklenti] Zaman:', new Date().toLocaleTimeString());

// React kontroll√º inputlara g√ºvenli deƒüer yaz
function setReactInputValue(input, value) {
  const nativeInputValueSetter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value')?.set;
  if (nativeInputValueSetter) {
    nativeInputValueSetter.call(input, value);
  } else {
    input.value = value;
  }
  
  // React event'lerini tetikle
  input.dispatchEvent(new Event('input', { bubbles: true }));
  input.dispatchEvent(new Event('change', { bubbles: true }));
}

// Elementin DOM'da g√∂r√ºnmesini bekle
async function waitFor(selectorOrFn, timeout = 12000) {
  const startTime = Date.now();
  
  while (Date.now() - startTime < timeout) {
    try {
      const el = typeof selectorOrFn === 'function' 
        ? selectorOrFn() 
        : document.querySelector(selectorOrFn);
      
      if (el) return el;
    } catch (e) {
      console.warn('[TP Eklenti] waitFor hata:', e);
    }
    
    await sleep(250);
  }
  
  throw new Error(`Timeout: ${selectorOrFn}`);
}

// MUI buton enable olmasƒ±nƒ± bekle
async function waitForEnabled(btn, timeout = 12000) {
  const t0 = Date.now();
  let attempts = 0;
  
  while (Date.now() - t0 < timeout) {
    const disabledAttr = btn.hasAttribute('disabled');
    const hasMuiDisabled = (btn.className || '').includes('Mui-disabled');
    
    if (!disabledAttr && !hasMuiDisabled) {
      console.log('[TP Eklenti] ‚úì Buton enable oldu');
      return true;
    }
    
    if (attempts % 5 === 0) {
      const elapsed = Math.floor((Date.now() - t0) / 1000);
      console.log(`[TP Eklenti] ‚è≥ Buton disabled... (${elapsed}s)`);
    }
    
    attempts++;
    await sleep(300);
  }
  
  console.log('[TP Eklenti] ‚úó Buton timeout');
  return false;
}

// URL hash'inden bn al
function getBNFromHash() {
  try {
    const raw = (location.hash || "").replace(/^#/, "");
    const m = raw.match(/(?:^|[&#;])bn=([^&#;]+)/i);
    return m ? decodeURIComponent(m[1]) : "";
  } catch { 
    return ""; 
  }
}

// Ba≈üvuru numarasƒ±nƒ± doldur ve sorgula - ANA FONKSƒ∞YON
async function fillAndSearch(bn) {
  if (!bn) {
    console.error('[TP Eklenti] ‚úó Ba≈üvuru numarasƒ± bo≈ü!');
    return false;
  }
  
  console.log('[TP Eklenti] ========================================');
  console.log('[TP Eklenti] ƒ∞≈ûLEM BA≈ûLIYOR');
  console.log('[TP Eklenti] Ba≈üvuru No:', bn);
  console.log('[TP Eklenti] ========================================');

  try {
    // 1) Sayfa y√ºklensin diye bekle
    console.log('[TP Eklenti] 1Ô∏è‚É£ Sayfa y√ºkleme bekleniyor...');
    await sleep(2000);
    
    // 2) Input alanƒ±nƒ± bul
    console.log('[TP Eklenti] 2Ô∏è‚É£ Input alanƒ± aranƒ±yor...');
    
    let input = null;
    
    try {
      input = await waitFor(() => {
        // Y√∂ntem 1: Placeholder
        let inp = document.querySelector('input[placeholder="Ba≈üvuru numarasƒ±"]');
        if (inp) return inp;
        
        // Y√∂ntem 2: Placeholder (case insensitive)
        inp = document.querySelector('input[placeholder*="ba≈üvuru" i]');
        if (inp) return inp;
        
        // Y√∂ntem 3: MUI input class + placeholder kontrol√º
        const muiInputs = document.querySelectorAll('input.MuiInputBase-input');
        for (const i of muiInputs) {
          const ph = (i.getAttribute('placeholder') || '').toLowerCase();
          if (ph.includes('ba≈üvuru')) {
            return i;
          }
        }
        
        return null;
      }, 10000);
    } catch (e) {
      console.error('[TP Eklenti] ‚úó Input bulma timeout:', e);
      return false;
    }

    if (!input) {
      console.error('[TP Eklenti] ‚úó Input bulunamadƒ±!');
      return false;
    }

    console.log('[TP Eklenti] ‚úì Input bulundu');

    // 3) Deƒüeri yaz
    console.log('[TP Eklenti] 3Ô∏è‚É£ Deƒüer yazƒ±lƒ±yor...');
    
    input.focus();
    await sleep(200);
    
    setReactInputValue(input, '');
    await sleep(150);
    
    setReactInputValue(input, bn);
    console.log('[TP Eklenti] ‚úì Deƒüer yazƒ±ldƒ±:', input.value);
    await sleep(300);
    
    // Validation i√ßin blur
    input.blur();
    await sleep(500);
    
    console.log('[TP Eklenti] ‚úì Input deƒüeri:', input.value);

    // 4) Sorgula butonunu bul
    console.log('[TP Eklenti] 4Ô∏è‚É£ Sorgula butonu aranƒ±yor...');
    
    let btn = null;
    
    try {
      btn = await waitFor(() => {
        // MUI contained primary button + "Sorgula" i√ßeriƒüi
        const buttons = document.querySelectorAll('button.MuiButton-contained');
        for (const b of buttons) {
          const text = (b.textContent || '').trim();
          if (text.includes('Sorgula')) {
            return b;
          }
        }
        return null;
      }, 8000);
    } catch (e) {
      console.error('[TP Eklenti] ‚úó Buton bulma timeout:', e);
      
      // Enter ile dene
      console.log('[TP Eklenti] üí° Enter tu≈üu g√∂nderiliyor...');
      input.focus();
      input.dispatchEvent(new KeyboardEvent('keydown', {key:'Enter', code:'Enter', keyCode:13, bubbles:true}));
      input.dispatchEvent(new KeyboardEvent('keyup', {key:'Enter', code:'Enter', keyCode:13, bubbles:true}));
      return true;
    }

    if (!btn) {
      console.error('[TP Eklenti] ‚úó Buton bulunamadƒ±!');
      return false;
    }

    console.log('[TP Eklenti] ‚úì Buton bulundu');

    // 5) Butonun enable olmasƒ±nƒ± bekle
    console.log('[TP Eklenti] 5Ô∏è‚É£ Butonun enable olmasƒ± bekleniyor...');
    
    const ready = await waitForEnabled(btn, 12000);
    
    if (!ready) {
      console.log('[TP Eklenti] üí° Buton enable olmadƒ±, Enter deneniyor...');
      input.focus();
      input.dispatchEvent(new KeyboardEvent('keydown', {key:'Enter', code:'Enter', keyCode:13, bubbles:true}));
      input.dispatchEvent(new KeyboardEvent('keyup', {key:'Enter', code:'Enter', keyCode:13, bubbles:true}));
      return true;
    }

    // 6) Butona tƒ±kla
    console.log('[TP Eklenti] 6Ô∏è‚É£ Butona tƒ±klanƒ±yor...');
    await sleep(300);
    
    btn.click();
    
    console.log('[TP Eklenti] ========================================');
    console.log('[TP Eklenti] ‚úì‚úì‚úì ƒ∞≈ûLEM TAMAMLANDI ‚úì‚úì‚úì');
    console.log('[TP Eklenti] ========================================');
    
    return true;
    
  } catch (error) {
    console.error('[TP Eklenti] ‚úó‚úó‚úó HATA:', error);
    return false;
  }
}

// Ana otomasyon fonksiyonu
async function runAutomation() {
  console.log('[TP Eklenti] üöÄ Otomasyon ba≈üladƒ±');
  
  const url = new URL(location.href);
  console.log('[TP Eklenti] Domain:', url.hostname);
  console.log('[TP Eklenti] Path:', url.pathname);

  // Hash'ten bn al
  const bn = getBNFromHash();
  
  if (!bn) {
    console.log('[TP Eklenti] ‚ö†Ô∏è Hash\'te ba≈üvuru numarasƒ± yok');
    return;
  }

  console.log('[TP Eklenti] ‚úì Hash\'ten alƒ±ndƒ±:', bn);

  // opts.turkpatent.gov.tr/trademark sayfasƒ±ndayƒ±z
  if (url.hostname === "opts.turkpatent.gov.tr" && url.pathname === "/trademark") {
    await fillAndSearch(bn);
  } else {
    console.log('[TP Eklenti] ‚ö†Ô∏è Beklenmeyen sayfa');
  }
}

// Sayfa y√ºklendiƒüinde otomatik √ßalƒ±≈ütƒ±r
(async () => {
  console.log('[TP Eklenti] ‚è≥ Ba≈ülangƒ±√ß bekleme... (2 saniye)');
  await sleep(2000);
  runAutomation();
})();