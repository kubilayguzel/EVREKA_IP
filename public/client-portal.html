<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müvekkil Portalı - Anasayfa</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        /* === Genel ve Koyu Tema Stilleri (Varsayılan) === */
        body.dark-mode {
            font-family: 'Poppins', sans-serif; 
            background-color: #2b2d31; 
            color: #e0e0e0; 
            transition: background-color 0.5s, color 0.5s;
        }
        .dark-mode #sidebar { 
            background-color: #36393e; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        .dark-mode #sidebar .nav-link { 
            color: #b0b8c0;
        }
        /* Hover yumuşak, aktif belirgin */
        .dark-mode #sidebar .nav-link:hover {
            background-color: #3a3f45;
            color: #b0b8c0;
            transform: translateX(3px);
        }
        .dark-mode #sidebar .nav-link.active {
            background-color: #40444b;
            color: #4da6ff; 
            transform: translateX(5px);
        }

        .dark-mode .header-title { 
            color: #f8f9fa;
        }
        .dark-mode .lead { 
            color: #b0b8c0; 
        }
        .dark-mode .card { 
            background-color: #36393e; 
            color: #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
        }
        .dark-mode .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }
        .dark-mode .card-header {
            background-color: #40444b;
            border-bottom: 1px solid #585b63;
            color: #f8f9fa;
        }
        .dark-mode .stat-label { color: #b0b8c0; }
        .dark-mode .table-responsive {
            background-color: #36393e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .dark-mode .table { color: #e0e0e0; }
        .dark-mode .table thead th { border-bottom: 2px solid #585b63; color: #f8f9fa; font-weight: 600; }
        .dark-mode .table tbody tr:hover { background-color: #40444b; }
        /* Koyu temada hover'da metin siyahlaşmasın */
        .dark-mode .table-hover tbody tr:hover {
        color: #e0e0e0 !important;        /* temel metin */
        background-color: #40444b !important;
        }

        /* Linkler de görünür kalsın */
        .dark-mode .table-hover tbody tr:hover a {
        color: #4da6ff !important;        /* koyu temadaki link rengiyle uyumlu */
        text-decoration: none;
        }

        /* Hücre içindekiler rengi miras alsın */
        .dark-mode .table-hover tbody tr:hover td,
        .dark-mode .table-hover tbody tr:hover th,
        .dark-mode .table-hover tbody tr:hover span,
        .dark-mode .table-hover tbody tr:hover small {
        color: inherit !important;
        }

        /* Badge’ler zaten kendi zıt renklerini kullanıyor; yine de zorlanırsa: */
        .dark-mode .table-hover tbody tr:hover .badge {
        filter: none;                      /* renkleri bozulmasın */
        color: inherit;                    /* badge iç yazı okunur kalsın */
        }

        .dark-mode .badge-filed { background-color: #4da6ff; color: #1e3c72; }
        .dark-mode .badge-registered { background-color: #5cb85c; color: #1a3b1c; }
        .dark-mode .badge-objection { background-color: #f0ad4e; color: #4e351b; }
        .dark-mode .badge-rejected { background-color: #d9534f; color: #3d1b1a; }
        .dark-mode .modal-content {
            background-color: #36393e;
            color: #e0e0e0;
            border: 1px solid #585b63;
        }
        .dark-mode .modal-header { border-bottom: 1px solid #585b63; }
        .dark-mode .modal-footer { border-top: 1px solid #585b63; }
        .dark-mode .close { color: #fff !important; opacity: 1 !important; }
        .dark-mode .nav-tabs { border-bottom: 1px solid #585b63; }
        .dark-mode .nav-tabs .nav-link { color: #b0b8c0; background-color: #3a3f45; }
        .dark-mode .nav-tabs .nav-item .nav-link.active {
            background-color: #30343a !important; 
            color: #4da6ff !important;
            border-color: #585b63 #585b63 #30343a;
        }
        .dark-mode .tab-content-card { background-color: #30343a; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 30px; }
        .dark-mode .task-card {
            background-color: #36393e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .dark-mode .task-card .task-title { color: #4da6ff; }
        .dark-mode .task-card .task-description { color: #b0b8c0; }
        .dark-mode .task-card .task-meta { color: #f0ad4e; }
        .dark-mode .form-control { background-color: #40444b; border-color: #585b63; color: #e0e0e0; }

        /* === Beyaz Tema Stilleri === */
        body.light-mode {
            background-color: #f0f2f5; 
            color: #333;
        }
        .light-mode #sidebar { 
            background-color: #ffffff; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .light-mode #sidebar .nav-link { 
            color: #555; 
        }
        .light-mode #sidebar .nav-link:hover, .light-mode #sidebar .nav-link.active {
            background-color: #e3f2fd;
            color: #1e88e5; 
        }
        .light-mode .header-title { 
            color: #1e3c72;
        }
        .light-mode .lead { 
            color: #777; 
        }
        .light-mode .card { 
            background-color: #ffffff; 
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            color: #1e3c72;
        }
        .light-mode .stat-label { color: #777; }
        .light-mode .table-responsive {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode .table { color: #333; }
        .light-mode .table thead th { border-bottom: 2px solid #e9ecef; color: #1e3c72; }
        .light-mode .table tbody tr:hover { background-color: #f8f9fa; }
        .light-mode .badge-filed { background-color: #e3f2fd; color: #1e88e5; }
        .light-mode .badge-registered { background-color: #d4edda; color: #43a047; }
        .light-mode .badge-objection { background-color: #fff3e0; color: #fb8c00; }
        .light-mode .badge-rejected { background-color: #f8d7da; color: #e53935; }
        .light-mode .modal-content {
            background-color: #ffffff;
            color: #333;
            border: 1px solid #dee2e6;
        }
        .light-mode .modal-header { border-bottom: 1px solid #dee2e6; }
        .light-mode .modal-footer { border-top: 1px solid #dee2e6; }
        .light-mode .close { color: #555 !important; opacity: 1 !important; }
        .light-mode .nav-tabs { border-bottom: 1px solid #dee2e6; }
        .light-mode .nav-tabs .nav-link { color: #555; background-color: #f8f9fa; margin-right: 5px; }
        .light-mode .nav-tabs .nav-item .nav-link.active {
            background-color: #ffffff !important; 
            color: #1e3c72 !important;
            border-color: #dee2e6 #dee2e6 #ffffff;
        }
        .light-mode .tab-content-card { background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .light-mode .task-card {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode .task-card .task-title { color: #1e3c72; }
        .light-mode .task-card .task-description { color: #555; }
        .light-mode .task-card .task-meta { color: #fb8c00; }
        .light-mode .form-control { background-color: #fff; border-color: #ccc; color: #333; }

        /* === Genel Stiller (Temadan bağımsız) === */
        body { 
            font-family: 'Poppins', sans-serif; 
            transition: background-color 0.5s, color 0.5s;
        }
        #sidebar { 
            height: 100vh; 
            width: 250px; 
            position: fixed; 
            top: 0; 
            left: 0; 
            padding-top: 20px; 
        }
        #sidebar .nav-link { 
            font-weight: 500; 
            padding: 12px 15px; 
            margin-bottom: 5px; 
            border-radius: 8px; 
            transition: all 0.3s;
            transform-origin: left;
        }
        #sidebar .nav-link:hover, #sidebar .nav-link.active {
            transform: translateX(5px);
        }
        .content { 
            margin-left: 250px; 
            padding: 40px; 
        }
        .header-title { font-weight: 700; }
        .card { 
            border-radius: 12px; 
            border: none; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-8px);
        }
        .stat-icon { font-size: 2.5em; }
        .stat-value { font-size: 2.2em; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 1em; }
        .table-responsive {
            border-radius: 12px;
            padding: 20px;
        }
        .table { font-size: 0.95rem; }
        .table thead th { border-bottom: 2px solid; font-weight: 600; }
        .table tbody tr:hover { cursor: pointer; }
        .modal-content { border-radius: 12px; }
        .nav-tabs .nav-link { border-radius: 8px 8px 0 0; font-weight: 600; }
        .btn-action { margin-right: 5px; transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-2px); }

        /* Yeni Eklenenler */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .task-card {
            border-left: 5px solid;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .task-card:hover {
            transform: translateY(-5px);
        }
        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .task-card:hover::before {
            opacity: 1;
        }
        .task-card .task-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .task-card .task-description {
            margin-bottom: 15px;
        }
        .task-card .task-meta {
            font-size: 0.9rem;
        }
        .task-card-success { border-color: #5cb85c; }
        .task-card-warning { border-color: #f0ad4e; }
        .task-card-danger { border-color: #d9534f; }
        
        .tab-content-card .nav-tabs .nav-link,
        .modal-content .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
        }
        .tab-content-card .nav-tabs .nav-link.active,
        .modal-content .nav-tabs .nav-link.active {
            border-bottom-color: transparent !important;
        }
        
        /* Akordeon stilleri */
        .accordion-item {
            background-color: inherit;
            border: none;
        }
        .accordion-header-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header-row:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        .accordion-body-content {
            background-color: #3f444a;
            color: #e0e0e0;
            padding: 0 15px;
        }
        .table .accordion-body-row:hover {
            background-color: #495057;
        }
        .accordion-table td {
            border-top: 1px solid;
            text-align: center;
        }
        .accordion-table thead tr {
            display: table-row;
        }
        .accordion-table th {
            border-bottom: 2px solid;
            font-weight: 600;
            text-align: center; /* Kolon başlıklarını ortala */
        }
        
        /* Top bar styles */
        .top-header {
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: 0;
            left: 250px; /* Sidebar width */
            z-index: 1000;
            display: flex;
            justify-content: space-between; /* İki tarafı ayır */
            align-items: center;
            padding: 10px 20px;
            height: 60px;
            transition: all 0.5s;
        }
        .dark-mode .top-header {
            background-color: #36393e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #1e3c72;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .user-name, .user-role {
            font-weight: 500;
        }
        .user-role {
            color: #888;
            font-size: 0.8rem;
        }
        .dark-mode .user-role {
            color: #b0b8c0;
        }
        .logout-btn {
            background-color: #d9534f;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #c9302c;
        }
        .content-with-topbar {
            margin-top: 60px; /* Height of the top bar */
        }
    
/* === Client Portal | Marka listesi kolon dağılımı === */
#marka-list table { table-layout: auto; }
#marka-list th.col-index, #marka-list td.col-index { width: 56px; white-space: nowrap; }
#marka-list th.col-brand, #marka-list td.col-brand { width: 28%; }
#marka-list th.col-sample, #marka-list td.col-sample { width: 120px; text-align:center; }
#marka-list th.col-appno, #marka-list td.col-appno { width: 12%; white-space: nowrap; }
#marka-list th.col-regno, #marka-list td.col-regno { width: 12%; white-space: nowrap; }
#marka-list th.col-appdate, #marka-list td.col-appdate { width: 12%; white-space: nowrap; }
#marka-list th.col-status, #marka-list td.col-status { width: 10%; white-space: nowrap; }
#marka-list th.col-classes, #marka-list td.col-classes { 
    width: 16%; 
    white-space: normal; /* nowrap yerine normal */
    word-wrap: break-word;
    line-height: 1.4;
}
#marka-list td, #marka-list th { vertical-align: middle; }
</style>

<style>
/* Portföyüm alt menüsü kaldırıldı */
#portfoy-accordion { display: none !important; }
</style>


<style>
#portfolioTabsBar .nav-tabs .nav-link { white-space: nowrap; }
@media (max-width: 576px){
  #portfolioTabsBar { gap: .5rem; }
}
</style>


<style>
/* İşlem Geçmişi: Açıklama kolonunu sola yasla */
#modal-islemler table thead th:nth-child(2),
#modal-islemler table tbody td:nth-child(2){
  text-align: left !important;
}

/* İşlem Geçmişi: Akordeon alt (child) girdiler daha küçük puntoda */
#modal-islemler .accordion-table th,
#modal-islemler .accordion-table td{
  font-size: 0.875rem; /* ~14px */
  line-height: 1.35;
}
</style>


<style>
/* Tabs sola yaslansın, filtre yanında boşlukla dursun */
#portfolioTabsBar{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* sola yasla */
  flex-wrap:wrap;
  gap:.5rem 1rem; /* satırlar ve sütunlar arası boşluk */
  margin-bottom:.5rem;
}
#portfolioTabsBar #portfolioTopTabs{
  margin-bottom:0 !important;
}
#portfolioTabsBar #portfolioFilters{
  margin-left:1rem; /* tabların yanında boşluk */
}
/* Küçük ekranlarda filtre tabların altına geçebilir, boşlukları koru */
@media (max-width:576px){
  #portfolioTabsBar{ gap: .5rem; }
  #portfolioTabsBar #portfolioFilters{ margin-left:0; }
}
</style>


<style>
/* Portföy sekmeleri sola yaslı ve filtre yanında */
#portfolioTabsBar{
  display:flex !important;
  align-items:center !important;
  justify-content:flex-start !important; /* sola hizala */
  flex-wrap:wrap;
  width:100%;
}
#portfolioTabsBar #portfolioTopTabs{
  flex-grow:0;
  margin-right:1rem; /* sekmeler ile filtre arasında boşluk */
}
#portfolioTabsBar #portfolioFilters{
  flex-grow:0;
}
</style>


<style>
/* Force tabs to left; filter sits next with small space */
#portfolioTabsBar{
  display:flex !important;
  align-items:center !important;
  justify-content:flex-start !important;
  flex-wrap:wrap;
  gap:.5rem 1rem;
}
#portfolioTopTabs{
  margin:0 !important;
  margin-right:1rem !important; /* small gap before filter */
}
#portfolioFilters{
  margin:0 !important;
}
/* neutralize any justify-content utilities that might be applied */
#portfolioTabsBar .nav-tabs{
  justify-content:flex-start !important;
}
</style>


<style>
/* Menşe filtresi tabs listesinin sonunda nav-item olarak yer alır */
#portfolioTopTabs {
  display:flex;
  align-items:center;
}
#portfolioTopTabs #portfolioFiltersNavItem label{
  white-space: nowrap;
}
#portfolioTopTabs #portfolioFiltersNavItem select{
  min-height: calc(1.5em + .5rem + 2px);
}
/* Marka Örneği hover efekti */
#marka-list img.brand-thumb {
    height: 128px !important;
    width: auto;
    border-radius: 6px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

#marka-list img.brand-thumb:hover {
    transform: scale(2.2);
    z-index: 999;
    position: relative;
}

/* Görselin kendi hizası */
#marka-list td.col-sample {
  text-align: center;         /* İçindeki metin/görseli yatay ortala */
  vertical-align: middle;     /* İçeriği dikey ortala (Zaten default olabilir ama emin olmak için) */
  /* display: flex; ve align-items: center; satırlarını kaldır! */
}

/* Görselin kendi hizası */
#marka-list img.brand-thumb {
  display: block;
  margin: 0 auto;             /* Görseli yatay ortala */
}

/* Akordeon ok animasyonu */
.accordion-header-row .fa-chevron-right {
    transition: transform 0.3s;
}
.accordion-header-row[aria-expanded="true"] .fa-chevron-right {
    transform: rotate(90deg);
}
/* Yeni eklenen iş kartları için Dashboard stili */
#task-main-cards .card,
#task-detail-cards .card { 
    border-radius: 12px; 
    border: none; 
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
}
#task-main-cards .card:hover,
#task-detail-cards .card:hover {
    transform: translateY(-8px);
    cursor: pointer;
}
/* Koyu Tema uyumu */
.dark-mode #task-main-cards .card:hover,
.dark-mode #task-detail-cards .card:hover {
    box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}
.dark-mode #task-main-cards .card,
.dark-mode #task-detail-cards .card { 
    background-color: #36393e; 
    color: #e0e0e0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

</style>

</head>
<body>
    <header class="top-header">
        <div class="theme-toggle custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="themeSwitch">
            <label class="custom-control-label" for="themeSwitch" style="color: #b0b8c0;">Koyu Tema</label>
        </div>
        <div class="user-section">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-info">
                <div class="user-name" id="userName">Yükleniyor...</div>
                <div class="user-role" id="userRole">Kullanıcı</div>
            </div>
            <button class="logout-btn" id="logoutBtn">Çıkış</button>
        </div>
    </header>

    <div id="sidebar">
        <h4 class="header-title text-center mb-4">Evreka Portalı</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="#dashboard" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="dashboard"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a></li>
            <li class="nav-item">
                <a class="nav-link" href="#portfolio-content" data-toggle="tab" role="tab" aria-selected="false" data-toggle="tab" role="tab" aria-controls="portfolio-content">
                    <i class="fas fa-folder-open mr-2"></i>Portföyüm
                </a>
                </li>
            <li class="nav-item"><a class="nav-link" href="#tasks" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="tasks"><i class="fas fa-tasks mr-2"></i>İşlerim</a></li>
            <li class="nav-item"><a class="nav-link" href="#invoices" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="invoices"><i class="fas fa-file-invoice-dollar mr-2"></i>Faturalarım</a></li>
            <li class="nav-item"><a class="nav-link" href="#reports" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="reports"><i class="fas fa-chart-bar mr-2"></i>Raporlar</a></li>
        </ul>
    </div>

    <div class="content content-with-topbar">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="dashboard">
                <h1 class="header-title">Hoş Geldiniz, <span id="welcomeUserName">Müvekkil Adı</span></h1>
                <p class="lead">Portalınızda portföyünüzü, işlerinizi ve finansal bilgilerinizi yönetebilirsiniz.</p>
                <div class="row mt-5">
                    <div class="col-md-12 mb-4" id="card-portfolio" data-target-tab="portfolio-content">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-folder-open stat-icon text-info mr-4"></i>
                            <div>
                                <div id="dashPortfolio" class="stat-value">0</div>
                                <div class="stat-label">Portföy Kaydım</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4" id="card-tasks" data-target-tab="tasks">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-tasks stat-icon text-warning mr-4"></i>
                            <div>
                                <div id="dashPendingApprovals" class="stat-value">0</div>
                                <div class="stat-label">Onay Bekleyen İşlem</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4" id="card-invoices" data-target-tab="invoices">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-file-invoice-dollar stat-icon text-success mr-4"></i>
                            <div>
                                <div id="dashUnpaidInvoices" class="stat-value">0</div>
                                <div class="stat-label">Ödenmemiş Fatura</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>          
            <div class="tab-pane fade" id="portfolio-content">
                <h1 class="header-title">Portföyüm</h1>
                <p class="lead">Tüm portföy kayıtlarınızın detaylı listesi.</p>
                
                <div class="card p-4 mb-4">
                    <h5 class="card-title">Filtreleme ve Arama</h5>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="basvuruNo" class="text-muted">Başvuru No</label>
                            <input type="text" class="form-control" id="basvuruNo" placeholder="Örn: 2023/12345">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="durum" class="text-muted">Durum</label>
                            <select id="durum" class="form-control">
                                <option selected>Tümü</option>
                                <option>Başvuru</option>
                                <option>Tescilli</option>
                                <option>İtiraz</option>
                                <option>Reddedildi</option>
                            </select>
                        </div>
                        
                        <div class="form-group col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary btn-block">Filtrele</button>
                        </div>
                    </div>
                    <div class="form-row mt-3">
                        <div class="col-md-12 d-flex justify-content-end">
                            <button class="btn btn-secondary btn-sm mr-2"><i class="fas fa-file-excel mr-1"></i>Excel'e Aktar</button>
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-file-pdf mr-1"></i>PDF'e Aktar</button>
                        </div>
                    </div>
                </div>

                

<div class="d-flex align-items-center justify-content-between flex-wrap mb-2" id="portfolioTabsBar">
<ul class="nav nav-tabs mb-2 mb-sm-0" id="portfolioTopTabs" role="tablist">
<li class="nav-item">
      <a class="nav-link active" id="tab-marka" data-toggle="tab" href="#marka-list" role="tab" aria-controls="marka-list" aria-selected="true">Marka</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-patent" data-toggle="tab" href="#patent-list" role="tab" aria-controls="patent-list" aria-selected="false">Patent</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-tasarim" data-toggle="tab" href="#tasarim-list" role="tab" aria-controls="tasarim-list" aria-selected="false">Tasarım</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-dava" data-toggle="tab" href="#dava-itiraz-list" role="tab" aria-controls="dava-itiraz-list" aria-selected="false">Dava/İtiraz</a>
    </li>
    <li class="nav-item d-flex align-items-center pl-2" id="portfolioFiltersNavItem" style="margin-left: .75rem;">
      <label for="menseFilter" class="mb-0 mr-2">Menşe:</label>
        <select id="menseFilter" class="form-control form-control-sm" style="max-width:220px">
        <option value="HEPSI">Hepsi</option>
        <option value="TÜRKPATENT" selected>TÜRKPATENT</option>
        <option value="YURTDISI">Yurtdışı</option>
        </select>
</li>
</ul>
</div>
<div class="tab-content table-responsive mt-3">
                    <div class="tab-pane fade show active" id="marka-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="col-index">#</th>
                                    <th class="col-origin">Menşe</th>
                                    <th class="col-sample text-center">Marka Örneği</th>
                                    <th class="col-brand">Marka</th>
                                    <th class="col-appno">Başvuru No</th>
                                    <th class="col-regno">Tescil No</th>
                                    <th class="col-appdate">Başvuru Tarihi</th>
                                    <th class="col-status">Durum</th>
                                    <th class="col-classes">Sınıflar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 1 (TR)</a></td>
                                    <td>2023/12345</td>
                                    <td><span class="badge badge-primary">Başvuru</span></td>
                                    <td>09, 35, 42</td>
                                    <td>25.10.2023</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 2 (TR)</a></td>
                                    <td>2023/11223</td>
                                    <td><span class="badge badge-success">Tescilli</span></td>
                                    <td>41</td>
                                    <td>01.07.2023</td>
                                </tr>
                                <tr class="accordion-header-row" data-toggle="collapse" data-target="#accordion-yurtdisi-1" aria-expanded="false" aria-controls="accordion-yurtdisi-1">
                                    <td><i class="fas fa-chevron-down mr-2"></i>3</td>
                                    <td><a href="#">Marka Adı 3 (WIPO)</a></td>
                                    <td>2023/IR001</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>09, 35</td>
                                    <td>15.08.2023</td>
                                </tr>
                                <tr>
                                    <td colspan="6" class="p-0">
                                        <div class="collapse" id="accordion-yurtdisi-1">
                                            <table class="table mb-0 accordion-table">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Marka Adı</th>
                                                        <th>Başvuru No</th>
                                                        <th>Durum</th>
                                                        <th>Sınıflar</th>
                                                        <th>Son İşlem</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>3.1</td>
                                                        <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 3 (Almanya)</a></td>
                                                        <td>2023/IR001</td>
                                                        <td><span class="badge badge-warning">İtiraz</span></td>
                                                        <td>09, 35</td>
                                                        <td>15.08.2023</td>
                                                    </tr>
                                                    <tr>
                                                        <td>3.2</td>
                                                        <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 3 (Çin)</a></td>
                                                        <td>2023/IR001</td>
                                                        <td><span class="badge badge-primary">Başvuru</span></td>
                                                        <td>09, 35</td>
                                                        <td>10.07.2023</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="markaPagination" class="mt-3"></div>
                    </div>
                    <div class="tab-pane fade" id="patent-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Patent Adı 1 (TR)</a></td>
                                    <td>2023/54321</td>
                                    <td><span class="badge badge-success">Tescilli</span></td>
                                    <td>-</td>
                                    <td>20.09.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="tasarim-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Tasarım Adı 1 (TR)</a></td>
                                    <td>2023/98765</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>25</td>
                                    <td>15.08.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="dava-itiraz-list">
                         <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Dava Adı 1 (TR)</a></td>
                                    <td>2023/98765</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>25</td>
                                    <td>15.08.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tasks">
                <h1 class="header-title" id="tasksHeaderTitle">İşlerim</h1>
                <p class="lead" id="tasksLeadText">Lütfen incelemek istediğiniz fikri mülkiyet türünü seçin.</p>
                
                <div class="row mt-5" id="task-main-cards">
                    
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="marka-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-registered stat-icon text-info mb-3"></i>
                            <div class="stat-label">Marka İşlemleri</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="patent-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-microchip stat-icon text-warning mb-3"></i>
                            <div class="stat-label">Patent İşlemleri</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="tasarim-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-palette stat-icon text-success mb-3"></i>
                            <div class="stat-label">Tasarım İşlemleri</div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4 task-card-link" data-target-area="dava-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-gavel stat-icon text-danger mb-3"></i>
                            <div class="stat-label">Dava & İtiraz</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-5" id="task-detail-cards" style="display: none;">
                    <div class="col-12 mb-4">
                        <button id="backToMainTasks" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left mr-1"></i> Geri</button>
                    </div>
                    
                    <div class="col-md-4 mb-4 detail-card-link" data-task-type="pending-approval" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-tasks stat-icon text-warning mb-3"></i>
                            <div class="stat-label">Onay Bekleyen İşler</div>
                            <div class="stat-value" id="taskCount-pending-approval">0</div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4 detail-card-link" data-task-type="renewal-approval" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-sync-alt stat-icon text-info mb-3"></i>
                            <div class="stat-label">Yenileme Onayları</div>
                            <div class="stat-value" id="taskCount-renewal-approval">0</div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4 detail-card-link" data-task-type="bulletin-watch" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-eye stat-icon text-primary mb-3"></i>
                            <div class="stat-label">Bülten İzleme Bildirim Onayları</div>
                            <div class="stat-value" id="taskCount-bulletin-watch">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4" id="task-list-details" style="display: none;">
                    <div class="col-12 mb-4">
                        <button id="backToDetailCards" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left mr-1"></i> Geri</button>
                    </div>
                    <div class="col-12" id="task-list-container">
                        </div>
                </div>
            </div>

            <div class="tab-pane fade" id="invoices">
                <h1 class="header-title">Faturalarım</h1>
                <p class="lead">Geçmiş ve ödenmemiş faturalarınızın listesi.</p>
                <div class="table-responsive mt-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fatura No</th>
                                <th>Tarih</th>
                                <th>Açıklama</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Aksiyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>INV-2023-001</td>
                                <td>25.10.2023</td>
                                <td>Marka tescil başvuru hizmet bedeli</td>
                                <td>1.500 TL</td>
                                <td><span class="badge badge-warning">Ödenmemiş</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
                                    <button class="btn btn-success btn-sm btn-action"><i class="fas fa-lira-sign"></i> Öde</button>
                                </td>
                            </tr>
                            <tr>
                                <td>INV-2023-002</td>
                                <td>10.09.2023</td>
                                <td>Yıllık marka takip hizmeti</td>
                                <td>800 TL</td>
                                <td><span class="badge badge-success">Ödendi</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="reports">
                <h1 class="header-title">Raporlar</h1>
                <p class="lead">Portföyünüzle ilgili detaylı raporlara buradan ulaşabilirsiniz.</p>
                <div class="row mt-4">
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-chart-line mr-2"></i>Portföy Değerlendirme Raporu</h5>
                            <p class="text-muted">Portföyünüzdeki tüm varlıkların güncel durumunu ve gelecek süreçlerini içeren rapor.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-file-pdf mr-2"></i>Finansal Durum Raporu</h5>
                            <p class="text-muted">Ödenmiş ve bekleyen tüm tahakkuk ve faturalarınızın özeti.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-history mr-2"></i>İşlem Geçmişi Dökümü</h5>
                            <p class="text-muted">Tüm portföyünüzdeki tamamlanmış ve bekleyen işlemlerin detaylı listesi.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="portfolioDetailModal" tabindex="-1" role="dialog" aria-labelledby="portfolioDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title header-title" id="portfolioDetailModalLabel">Marka Adı 1 Detayları</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Marka</div>
                        <div class="card-body text-center">
                            <img src="https://via.placeholder.com/150" alt="Marka Örneği" style="max-width: 100%; height: auto; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Varlık Detayları</div>
                        <div class="card-body">
                            <p><strong>Tür:</strong> Marka</p>
                            <p><strong>Başvuru No:</strong> 2023/12345</p>
                            <p><strong>Tescil No:</strong> -</p>
                            <p><strong>Sınıf:</strong> 09, 35, 42</p>
                            <p><strong>Durum:</strong> <span class="badge badge-primary">Başvuru</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Tarihler / Durum</div>
                        <div class="card-body">
                            <p><strong>Başvuru Tarihi:</strong> 25.10.2023</p>
                            <p><strong>Tescil Tarihi:</strong> -</p>
                            <p><strong>Yenileme Tarihi:</strong> -</p>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item"><a class="nav-link active" id="islemler-tab" data-toggle="tab" href="#modal-islemler" role="tab" aria-controls="modal-islemler" aria-selected="true">İşlemler</a></li>
              <li class="nav-item"><a class="nav-link" id="esya-tab" data-toggle="tab" href="#modal-esya" role="tab" aria-controls="modal-esya" aria-selected="false">Eşya Listesi</a></li>
              <li class="nav-item"><a class="nav-link" id="tahakkuklar-tab" data-toggle="tab" href="#modal-tahakkuklar" role="tab" aria-controls="modal-tahakkuklar" aria-selected="false">Tahakkuklar ve Faturalar</a></li>
              <li class="nav-item"><a class="nav-link" id="belgeler-tab" data-toggle="tab" href="#modal-belgeler" role="tab" aria-controls="modal-belgeler" aria-selected="false">Belgeler</a></li>
            </ul>
            <div class="tab-content tab-content-card mt-3">
              <div class="tab-pane fade" id="modal-islemler" role="tabpanel">
                <h5 class="header-title">İşlem Geçmişi</h5>
                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>İşlem Açıklaması</th>
                                        <th>Tarih</th>
                                        <th>Evrak</th>
                                    </tr>
                                </thead>
                        <tbody>
                            <tr class="accordion-header-row" data-toggle="collapse" data-target="#islem-1" aria-expanded="false" aria-controls="islem-1">
                                <td><i class="fas fa-chevron-down mr-2"></i>1</td>
                                <td>Marka Başvurusu Hazırlığı</td>
                                <td><span class="badge badge-success">Tamamlandı</span></td>
                                <td>15.01.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="islem-1">
                                        <table class="table mb-0 accordion-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>İşlem Açıklaması</th>
                                                    <th>Durum</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>1.1</td>
                                                    <td>Evrakların Toplanması</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>10.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                                <tr>
                                                    <td>1.2</td>
                                                    <td>Başvuru Formunun Doldurulması</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>12.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr class="accordion-header-row" data-toggle="collapse" data-target="#islem-2" aria-expanded="false" aria-controls="islem-2">
                                <td><i class="fas fa-chevron-down mr-2"></i>2</td>
                                <td>Marka Tescil Başvurusu</td>
                                <td><span class="badge badge-primary">Devam Ediyor</span></td>
                                <td>20.01.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="islem-2">
                                        <table class="table mb-0 accordion-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>İşlem Açıklaması</th>
                                                    <th>Durum</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>2.1</td>
                                                    <td>TÜRKPATENT'e Bildirim</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>21.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                                <tr>
                                                    <td>2.2</td>
                                                    <td>İnceleme Aşaması</td>
                                                    <td><span class="badge badge-primary">Beklemede</span></td>
                                                    <td>25.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>

                            <tr class="accordion-header-row">
                                <td>3</td>
                                <td>Yenileme Hizmet Bedeli Tahakkuku</td>
                                <td><span class="badge badge-warning">Onay Bekliyor</span></td>
                                <td>10.03.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
              <div class="tab-pane fade" id="modal-esya" role="tabpanel">
                <h5 class="header-title">Mal ve Hizmet Sınıfları</h5>
                <div id="esyaListesiContent" class="mt-3">
                  <p class="text-muted">Yükleniyor...</p>
                </div>
              </div>
              <div class="tab-pane fade" id="modal-tahakkuklar" role="tabpanel">
                <h5 class="header-title">Tahakkuk ve Fatura Bilgileri</h5>
                <p>İlgili tahakkuklar ve faturalar burada listelenecektir.</p>
              </div>
              <div class="tab-pane fade" id="modal-belgeler" role="tabpanel">
                <h5 class="header-title">Dosya ve Belgeler</h5>
                <p>Bu kayda ait belgeler burada gösterilecektir.</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">Yeni İşlem Ekle</button>
          </div>
        </div>
      </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { authService, db } from './firebase-config.js';
import { doc, getDoc, collection, getDocs, getDocsFromServer, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import Pagination from './js/pagination.js';

// --- Dashboard sayaç kontrolü ---
// Destek varsa cache yerine sunucudan oku:
const runGetDocs = (typeof getDocsFromServer === 'function') ? getDocsFromServer : getDocs;

// Sayfa ilk yüklenirken tüm sayaçları 0'a çek
function setDashboardZeros() {
  const map = {
    // Bu id'leri projendeki gerçek id'lerle eşleştir:
    '#dashPortfolio': 0,            // Toplam portföy
    '#dashPendingApprovals': 0,     // Onay bekleyen işlem
    '#dashUnpaidInvoices': 0        // Ödenmemiş fatura
  };
  Object.entries(map).forEach(([sel, val]) => {
    const el = document.querySelector(sel) || document.querySelector(`[data-dash-key="${sel.replace('#dash','').toLowerCase()}"]`);
    if (el) el.textContent = val;
  });
}

// Veriler tamamlanmadan gelen "erken" güncellemeleri yok saymak için
let DASH_LOADING = true;
function setDashboardLoading(v){ DASH_LOADING = !!v; }

// populateDashboardNumbers içinde güvenli yazım
function writeDashSafe(selector, value) {
  if (DASH_LOADING) return;  // erken çağrıları görmezden gel
  const el = document.querySelector(selector) || document.querySelector(`[data-dash-key="${selector.replace('#dash','').toLowerCase()}"]`);
  if (el) el.textContent = value;
}

// Kullanıcı bilgilerini üst çubuğa yerleştirme
function populateUserInfo() {
    const user = authService.getCurrentUser();
    if (user) {
        document.getElementById('userName').textContent = user.displayName || user.email;
        document.getElementById('userRole').textContent = (user.role ? user.role.toUpperCase() : 'CLIENT');
        document.getElementById('userAvatar').textContent = (user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase());
        document.getElementById('welcomeUserName').textContent = user.displayName || user.email;
    }
}

// Çıkış işlevi
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await authService.signOut();
});

// Tema yönetimi
function initTheme() {
    const themeSwitch = document.getElementById('themeSwitch');
    const body = document.body;
    const toggleLabel = document.querySelector('.theme-toggle .custom-control-label');
    const savedTheme = localStorage.getItem('theme') || 'dark';

    if (savedTheme === 'light') {
        body.classList.add('light-mode');
        themeSwitch.checked = false;
        toggleLabel.textContent = 'Beyaz Tema';
    } else {
        body.classList.add('dark-mode');
        themeSwitch.checked = true;
        toggleLabel.textContent = 'Koyu Tema';
    }

    themeSwitch.addEventListener('change', function () {
        if (this.checked) {
            body.classList.remove('light-mode');
            body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            toggleLabel.textContent = 'Koyu Tema';
        } else {
            body.classList.remove('dark-mode');
            body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
            toggleLabel.textContent = 'Beyaz Tema';
        }
    });
}

/**
 * Verilen HTML tablosunu, çekilen portföy verileriyle doldurur.
 * @param {string} tableId Doldurulacak tablonun ID'si (#marka-list, #patent-list vb.)
 * @param {Array<Object>} portfolioData Gösterilecek portföy verileri.
 */
// Global fonksiyon olarak sakla (pagination için)
window.__originalPopulate = populatePortfolioTable;

function populatePortfolioTable(tableId, portfolioData) {
    const tableBody = document.querySelector(`${tableId} tbody`);
    if (!tableBody) return;
    tableBody.innerHTML = '';

    portfolioData.forEach((item, index) => {
        const mainRow = document.createElement('tr');

        const originRaw = (item.origin || 'TÜRKPATENT').toString().trim();
        const originUpper = originRaw.toUpperCase();

console.log('📍 Origin Debug:', item.title || 'İsimsiz', 'origin:', item.origin, 'raw:', originRaw, 'upper:', originUpper);

        const originBucket = (originUpper === 'TÜRKPATENT' || originUpper === 'TURKPATENT')
        ? 'TÜRKPATENT'
        : 'YURTDISI';

        // Parent-child ilişkisini transactionHierarchy'den belirle
        const isParent = item.transactionHierarchy === 'parent';
        const isChild = item.transactionHierarchy === 'child';
        
        // Child kayıtları hiç render etme
        if (isChild) {
            return; // Bu kayıt için hiçbir şey yapma, bir sonraki kayda geç
        }
        
        // Parent ise, child kayıtlarını bul (tüm listeden)
        let childRecords = [];
        if (isParent && window.markaPaginationData && window.markaPaginationData.allDataUnfiltered) {
            childRecords = window.markaPaginationData.allDataUnfiltered.filter(p => 
                p.parentId === item.id || 
                (p.transactionHierarchy === 'child' && p.title === item.title)
            );
        }
        
        const isInternational = isParent && childRecords.length > 0;
        
        mainRow.setAttribute('data-origin', originBucket);
        
        // Child kayıtları gizle (sadece parent'ın altında göstereceğiz)
        if (isChild) {
            mainRow.style.display = 'none';
            mainRow.setAttribute('data-is-child', 'true');
        }

        // Veritabanından gelen gerçek veri yapısına göre düzelt
        const title = item.title || item.brandText || 'İsimsiz';
        const appNumber = item.applicationNumber || item.applicationNo || '-';
        const statusText = item.status || item.statusText || 'Bilinmiyor';
        const classes = (() => {
            if (Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length) {
                try {
                    const arr = item.goodsAndServicesByClass
                        .map(c => parseInt(c.classNo,10))
                        .filter(n => !isNaN(n));
                    const uniq = Array.from(new Set(arr)).sort((a,b)=>a-b);
                    return uniq.join(', ');
                } catch(_) { /* fallthrough */ }
            }
            if (item.classes) {
                const norm = Array.isArray(item.classes) ? item.classes : String(item.classes).split(',');
                const uniq = Array.from(new Set(norm.map(x=>parseInt(String(x).trim(),10)).filter(n=>!isNaN(n)))).sort((a,b)=>a-b);
                return uniq.length ? uniq.join(', ') : '-';
            }
            return '-';
        })();
        const applicationDate = (() => {
            const rawDate = item.applicationDate || item.application_date || '';
            if (!rawDate || rawDate === '-') return '-';
            
            try {
                // Tarihi parse et (YYYY-MM-DD formatından)
                const date = new Date(rawDate);
                if (isNaN(date.getTime())) return rawDate; // Geçersiz tarihse orijinalini döndür
                
                // dd/mm/yyyy formatına çevir
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (error) {
                return rawDate; // Hata durumunda orijinal değeri döndür
            }
        })();
        // Menşe hesaplama
        const originDisplay = (() => {
            if (originBucket === 'TÜRKPATENT') {
                return 'TÜRKPATENT';
            } else if (item.origin === 'Yurtdışı Ulusal') {
                const countryCode = item.country || '';
                return window.countriesMap && window.countriesMap[countryCode] 
                    ? window.countriesMap[countryCode] 
                    : countryCode;
            } else {
                return item.origin || 'Bilinmiyor';
            }
        })();
        const badgeClass = {
            'Başvuru': 'primary',
            'application_filed': 'primary', 
            'Tescilli': 'success',
            'registered': 'success',
            'İtiraz': 'warning',
            'objection': 'warning',
            'Reddedildi': 'danger',
            'rejected': 'danger'
        }[statusText] || 'secondary';

        const brandImg = item.brandImageUrl || item.brandImage || '';
        const imgHtml = brandImg ? `<img src="${brandImg}" alt="marka" class="brand-thumb" style="height:128px !important;width:auto;border-radius:6px;object-fit:contain;"/>` : '-';
        const regNumber = item.registrationNumber || item.registrationNo || '-';
        
        const rowHtml = `
        <td class="col-index">${isInternational ? `<i class="fas fa-chevron-right mr-2"></i>` : ''}${index + 1}</td>
        <td class="col-origin">${originDisplay}</td>
        <td class="col-sample">${imgHtml}</td>
        <td class="col-brand"><a href="#" class="portfolio-detail-link" data-item-id="${item.id}" data-toggle="modal" data-target="#portfolioDetailModal">${title}</a></td>
        <td class="col-appno">${appNumber}</td>
        <td class="col-regno">${regNumber}</td>
        <td class="col-appdate">${applicationDate}</td>
        <td class="col-status"><span class="badge badge-${badgeClass}">${statusText}</span></td>
        <td class="col-classes">${classes}</td>
        `;

        mainRow.innerHTML = rowHtml;

        if (isInternational) {
        mainRow.classList.add('accordion-header-row');
        mainRow.setAttribute('data-toggle', 'collapse');
        mainRow.setAttribute('data-target', `#accordion-yurtdisi-${item.id}`);
        mainRow.setAttribute('aria-expanded', 'false');
        mainRow.setAttribute('aria-controls', `accordion-yurtdisi-${item.id}`);
        }

        tableBody.appendChild(mainRow);
        
        if (isInternational && childRecords.length > 0) {
            const detailRow = document.createElement('tr');
            detailRow.setAttribute('data-origin', originBucket);
            detailRow.innerHTML = `
                <td colspan="9" class="p-0">
                    <div class="collapse" id="accordion-yurtdisi-${item.id}">
                        <table class="table mb-0 accordion-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Menşe</th>
                                    <th>Başvuru No</th>
                                    <th>Tescil No</th>
                                    <th>Başvuru Tarihi</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${childRecords.map((subItem, subIndex) => {
                                    const subClasses = (() => {
                                        if (Array.isArray(subItem.goodsAndServicesByClass) && subItem.goodsAndServicesByClass.length) {
                                            const arr = subItem.goodsAndServicesByClass.map(c => parseInt(c.classNo,10)).filter(n => !isNaN(n));
                                            return Array.from(new Set(arr)).sort((a,b)=>a-b).join(', ');
                                        }
                                        return '-';
                                    })();
                                    
                                    const subAppDate = (() => {
                                        const rawDate = subItem.applicationDate || '';
                                        if (!rawDate || rawDate === '-') return '-';
                                        try {
                                            const date = new Date(rawDate);
                                            if (isNaN(date.getTime())) return rawDate;
                                            const day = String(date.getDate()).padStart(2, '0');
                                            const month = String(date.getMonth() + 1).padStart(2, '0');
                                            const year = date.getFullYear();
                                            return `${day}/${month}/${year}`;
                                        } catch (error) {
                                            return rawDate;
                                        }
                                    })();
                                    
                                    const subStatus = subItem.status || 'Bilinmiyor';
                                    const subBadgeClass = {
                                        'Başvuru': 'primary',
                                        'application_filed': 'primary', 
                                        'Tescilli': 'success',
                                        'registered': 'success',
                                        'İtiraz': 'warning',
                                        'objection': 'warning',
                                        'Reddedildi': 'danger',
                                        'rejected': 'danger'
                                    }[subStatus] || 'secondary';
                                    
                                    const childOrigin = window.countriesMap && window.countriesMap[subItem.country] 
                                        ? window.countriesMap[subItem.country] 
                                        : (subItem.country || 'Bilinmiyor');
                                    
                                    const subRegNo = subItem.registrationNumber || subItem.registrationNo || '-';                                  
                                    return `
                                        <tr>
                                            <td>${index + 1}.${subIndex + 1}</td>
                                            <td>${childOrigin}</td>
                                            <td>${subItem.applicationNumber || '-'}</td>
                                            <td>${subRegNo}</td>
                                            <td>${subAppDate}</td>
                                            <td><span class="badge badge-${subBadgeClass}">${subStatus}</span></td>
                                            <td>${subClasses}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            tableBody.appendChild(detailRow);
        }
    });
}

/**
 * Kullanıcı kimliğine göre portföy verilerini çeker ve tabloyu doldurur.
 */
async function fetchAndDisplayPortfolio() {
    const user = authService.getCurrentUser();
    const userId = user ? user.uid : null;
    
    if (!userId) {
        console.log("Kullanıcı giriş yapmamış veya UID alınamadı.");
        return;
    }
    
    if (!db) {
        console.error("Firestore başlatılamadı. firebase-config.js içindeki getFirestore kurulumunu kontrol edin.");
        return;
    }


    try {
        // 1. Kullanıcının kendi belgesini UID'si ile çekme
        const userDocRef = doc(db, "users", userId);
        const userSnapshot = await getDoc(userDocRef);

        if (!userSnapshot.exists()) {
            console.log("Kullanıcıya ait veri bulunamadı.");
            return;
        }

        const userData = userSnapshot.data();
        const linkedPersonIds = userData.linkedPersonIds;

        if (!linkedPersonIds || linkedPersonIds.length === 0) {
            console.log("Kullanıcı ile ilişkili müvekkil bulunamadı.");
            return;
        }
        // Ülke verilerini çek
        const countriesDoc = await getDoc(doc(db, "common", "countries"));
        if (countriesDoc.exists()) {
            const countriesData = countriesDoc.data();
            // Array'i map'e çevir: {code: name}
            window.countriesMap = {};
            if (countriesData.list && Array.isArray(countriesData.list)) {
                countriesData.list.forEach(country => {
                    if (country.code && country.name) {
                        window.countriesMap[country.code] = country.name;
                    }
                });
            }
            console.log('✅ Ülkeler yüklendi:', Object.keys(window.countriesMap).length, 'ülke');
        } else {
            window.countriesMap = {};
            console.warn('⚠️ Ülke verileri bulunamadı');
        }
        // 2. İlgili müvekkillere ait tüm portföy verilerini çekme
        const portfolioRef = collection(db, "ipRecords");
        let allPortfolios = [];

        console.log("Portföy verilerini çekme başladı...", {
            linkedPersonIds,
            linkedPersonCount: linkedPersonIds.length
        });
        setDashboardLoading(true);
        setDashboardZeros();

        // Strateji 1: personsRelatedIds ile hızlı query dene (muhtemelen boş dönecek)
        try {
            const q1 = query(
                portfolioRef,
                where("personsRelatedIds", "array-contains-any", linkedPersonIds)
            );
            const snap1 = await runGetDocs(q1);
            snap1.forEach(doc => {
                allPortfolios.push({ id: doc.id, ...doc.data() });
            });
            
            console.log("✅ personsRelatedIds ile bulunan:", allPortfolios.length);
        } catch (error) {
            console.warn("❌ personsRelatedIds query hatası:", error.message);
        }

        // Ana strateji: applicants array'i ile client-side filtering
        console.log("🔄 Applicants array'i ile filtreleme başlatılıyor...");

        const allIpQuery = query(collection(db, "ipRecords"));
        const allIpSnap = await runGetDocs(allIpQuery);

        console.log(`📥 Toplam ${allIpSnap.size} ipRecord çekildi, filtreleme başlıyor...`);

        allIpSnap.forEach(doc => {
            const data = doc.data();
            
            // applicants array'ini kontrol et
            if (data.applicants && Array.isArray(data.applicants)) {
                const hasMatch = data.applicants.some(applicant => {
                    // applicant objesinin id'sini linkedPersonIds ile karşılaştır
                    return applicant && applicant.id && linkedPersonIds.includes(applicant.id);
                });
                
                if (hasMatch) {
                    allPortfolios.push({ id: doc.id, ...data });
                }
            }
        });

        console.log("📊 Final portföy istatistikleri:", {
            totalFound: allPortfolios.length,
            sampleTitles: allPortfolios.slice(0, 3).map(p => p.title || p.brandText || 'İsimsiz')
        });

        // Duplicate temizleme
        const seen = new Set();
        allPortfolios = allPortfolios.filter(p => {
            if (seen.has(p.id)) return false;
            seen.add(p.id);
            return true;
        });

        console.log("✅ Temizleme sonrası final:", allPortfolios.length);

        // 3. Doğru type değerleri ile filtreleme (veritabanında İngilizce değerler kullanılıyor)
        const markaList = allPortfolios.filter(p => 
            p.type === 'trademark' || p.type === 'Marka' || p.type === 'marka'
        );
        const patentList = allPortfolios.filter(p => 
            p.type === 'patent' || p.type === 'Patent'
        );
        const tasarimList = allPortfolios.filter(p => 
            p.type === 'design' || p.type === 'Tasarım' || p.type === 'tasarim'
        );
        const davaIItirazList = allPortfolios.filter(p => 
            p.type === 'litigation' || p.type === 'objection' || 
            p.type === 'Dava/İtiraz' || p.type === 'dava' || p.type === 'itiraz'
        );

        console.log("✅ Kategori dağılımı:", {
            marka: markaList.length,
            patent: patentList.length,
            tasarim: tasarimList.length,
            davaItiraz: davaIItirazList.length
        });

        // 4. Her bir sekmeyi kendi verisiyle doldurma
        console.log('🔍 Marka listesi origin dağılımı:', markaList.map(m => ({
            title: m.title || 'İsimsiz',
            origin: m.origin
        })).slice(0, 10));

        const __markaData = Array.isArray(markaList) ? markaList : [];

        // İlk önce tüm veriyi global olarak sakla
        window.markaPaginationData = window.markaPaginationData || {};
        window.markaPaginationData.allDataUnfiltered = __markaData;
        window.markaPaginationData.allData = __markaData;
        window.markaPaginationData.currentPage = 1;
        window.markaPaginationData.itemsPerPage = 10;

        const __markaPag = new Pagination({
        itemsPerPage: 10,
        containerId: 'markaPagination',
        onPageChange: (page, perPage) => {
            const start = (page - 1) * perPage;
            const end   = start + perPage;
            // allData kullan (filtrelenmiş veri)
            const slice = window.markaPaginationData.allData.slice(start, end);
            populatePortfolioTable('#marka-list', slice);
            // Filtre tekrar uygula
            setTimeout(() => {
                if (typeof applyMenseFilterToActivePane === 'function') {
                    var $activePane = $(".tab-content > .tab-pane.show.active");
                    if ($activePane.attr("id") === 'marka-list') {
                        filterPaneByMense("#marka-list", $("#menseFilter").val() || 'TÃœRKPATENT');
                    }
                }
            }, 50);
        }
        });

        __markaPag.update(__markaData.length);
        populatePortfolioTable('#marka-list', __markaData.slice(0, 10));
        
        // İlk yüklemede filtreyi uygula
        setTimeout(() => {
            if (typeof window.applyMenseFilterToActivePane === 'function') {
                window.applyMenseFilterToActivePane();
            } else {
                // Fonksiyon henüz tanımlanmadıysa, default TÜRKPATENT filtresi uygula
                const val = 'TÜRKPATENT';
                const filteredData = __markaData.filter(item => {
                    var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
                    return orig === 'TÜRKPATENT' || orig === 'TURKPATENT' || orig === '';
                });
                window.markaPaginationData.allData = filteredData;
                window.markaPaginationData.totalPages = Math.ceil(filteredData.length / window.markaPaginationData.itemsPerPage);
                populatePortfolioTable('#marka-list', filteredData.slice(0, 10));
            }
        }, 500);

        populatePortfolioTable('#patent-list', patentList);
        populatePortfolioTable('#tasarim-list', tasarimList);
        populatePortfolioTable('#dava-itiraz-list', davaIItirazList);
        setDashboardLoading(false);

        // Dashboard sayaçlarını doldur
        await populateDashboardNumbers(linkedPersonIds, allPortfolios);

        // İşlerim sekmesini doldur
        await fetchAndDisplayTasks(linkedPersonIds);

        // Faturalarım sekmesini doldur
        await fetchAndDisplayInvoices(linkedPersonIds);

    } catch (error) {
        console.error("Portföy verileri çekilirken bir hata oluştu:", error);
    }
}

async function populateDashboardNumbers(linkedPersonIds, allPortfolios){
    const portfolioCount = allPortfolios.length;
    const taskQ = query(collection(db, "tasks"), where("personsRelatedIds", "array-contains-any", linkedPersonIds), where("status","==","müvekkil onayı bekliyor"));
    const taskSnap = await runGetDocs(taskQ);
    const pendingTasks = taskSnap.size;
    const accrualQ = query(collection(db, "accruals"), where("personsRelatedIds", "array-contains-any", linkedPersonIds), where("isPaid","==", false));
    const accrualSnap = await runGetDocs(accrualQ);
    const unpaidInvoices = accrualSnap.size;
    writeDashSafe('#dashPortfolio',        portfolioCount);
    writeDashSafe('#dashPendingApprovals', pendingTasks);
    writeDashSafe('#dashUnpaidInvoices',   unpaidInvoices);
}

// Sayfa yüklendiğinde tüm fonksiyonları başlat
document.addEventListener('DOMContentLoaded', function () {
    initTheme();
    populateUserInfo();
    fetchAndDisplayPortfolio();

// --- Sidebar tab click kontrolü ---
    const $ = window.jQuery; // bootstrap.bundle yüklü; jQuery globalde mevcut
    if ($) {
        // Sidebar içindeki tab linklerine tıklandığında sadece biri aktif kalsın
        $('#sidebar a[data-toggle="tab"]').on('show.bs.tab', function (e) {
            $('#sidebar .nav-link').removeClass('active');
            $(e.target).addClass('active');
        });
        
        // Portföy tab'ına her tıklandığında veriyi yenile
        $('#sidebar a[href="#portfolio-content"]').on('shown.bs.tab', function (e) {
            setTimeout(() => {
                // Marka tab'ını aktif yap
                $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                
                // Filtreyi uygula
                if (typeof window.applyMenseFilterToActivePane === 'function') {
                    window.applyMenseFilterToActivePane();
                }
                
                // Pagination'ı yenile
                if (window.markaPaginationData && window.markaPaginationData.allData.length > 0) {
                    if (window.renderMarkaPagination) {
                        window.renderMarkaPagination();
                    }
                }
            }, 100);
        });
    }
});

// Diğer tüm scriptler
(function(){

function getRowOrigin($row){
  // populate sırasında data-origin zaten kovaya çevrildi: 'TÜRKPATENT' | 'YURTDISI'
  var v = ($row.attr('data-origin') || '').toString().toUpperCase().trim();
  if (v === 'TÜRKPATENT' || v === 'TURKPATENT') return 'TÜRKPATENT';
  // Boş veya farklı her değer yabancı muamelesi görsün
  return 'YURTDISI';
}

  function toggleWipoGroup($headerRow, show){
    var $detailRow = $headerRow.next('tr');
    if(show){
      $headerRow.show();
      $detailRow.show();
    }else{
      var collapseId = $headerRow.attr('data-target');
      if(collapseId){ try { $(collapseId).collapse('hide'); } catch(e){} }
      $headerRow.hide();
      $detailRow.hide();
    }
  }

function filterPaneByMense(paneSelector, menseValue){
    var $tbody = $(paneSelector + " tbody");
    if($tbody.length === 0) return;
    var $rows = $tbody.children("tr");

    var isTR = (menseValue === 'TÜRKPATENT');
    var isYD = (menseValue === 'YURTDISI');
    var isALL = (menseValue === 'HEPSI');

    console.log('=== FILTER BAŞLADI ===');
    console.log('Seçilen menşe:', menseValue);
    console.log('Toplam satır sayısı:', $rows.length);

    $rows.each(function(){
        var $tr = $(this);
        var dataOriginAttr = $tr.attr('data-origin');
        var rowOrigin = getRowOrigin($tr);
        
        console.log('Satır:', {
            text: $tr.find('td:eq(2)').text().substring(0, 30),
            dataOriginAttr: dataOriginAttr,
            rowOrigin: rowOrigin,
            hasAccordionClass: $tr.hasClass('accordion-header-row')
        });

        // Basit mantık: TÜRKPATENT ise true, değilse false
        var isTurkpatent = (rowOrigin === 'TÜRKPATENT');
        var isYurtdisi = (rowOrigin && rowOrigin !== 'TÜRKPATENT');
    


        if($tr.hasClass('accordion-header-row')){
            // Akordeon Başlıklarını Yönet
            if (isALL) {
                toggleWipoGroup($tr, true);
            } else if (isTR) {
                toggleWipoGroup($tr, isTurkpatent);
            } else if (isYD) {
                toggleWipoGroup($tr, isYurtdisi);
            }
        } else {
            // Normal Satırları Yönet
            if (isALL) {
                $tr.show();
            } else if (isTR) {
                if (isTurkpatent) {
                    $tr.show();
                } else {
                    $tr.hide();
                }
            } else if (isYD) {
                if (isYurtdisi) {
                    $tr.show();
                } else {
                    $tr.hide();
                }
            }
        }
    });
        // Menşe kolonunu göster/gizle
    var $originHeaders = $(paneSelector + " th.col-origin");
    var $originCells = $(paneSelector + " td.col-origin");
    
    if (isTR) {
        $originHeaders.hide();
        $originCells.hide();
    } else {
        $originHeaders.show();
        $originCells.show();
    }
}

window.applyMenseFilterToActivePane = function(){
    var val = $("#menseFilter").val() || 'TÜRKPATENT'; // Türkçe karakterler bazen bozulabilir, kontrol edin.
    var $activePane = $(".tab-content > .tab-pane.show.active");
    
    if($activePane.length){
        var paneId = $activePane.attr("id");

        // Mense Filtresi sadece Portföyüm sekmesi açıkken çalışmalıdır.
        if (paneId !== 'portfolio-content') {
            // Aktif sekme portföy değilse, bu fonksiyondan çık.
            // Bu, 'tasks' veya 'dashboard' açıkken 'markaPaginationData' erişim hatasını engeller.
            return;
        }
        
        // Aktif olan Portföy alt sekmesini bul (marka-list, patent-list vb.)
        var $activePortfolioTab = $('#portfolioTopTabs a.nav-link.active').attr('href');
        var activeTabId = $activePortfolioTab ? $activePortfolioTab.substring(1) : 'marka-list';
        
        // Önce DOM filtrelemesini uygula (Her zaman)
        filterPaneByMense("#" + activeTabId, val);
        
        // Eğer marka listesindeyse ve pagination aktifse, veriyi yeniden filtrele ve pagination'ı güncelle
        if (activeTabId === 'marka-list' && window.markaPaginationData && window.markaPaginationData.allDataUnfiltered) {
            var allData = window.markaPaginationData.allDataUnfiltered;
            var filteredData;
            
            if (val === 'HEPSI') {
                filteredData = allData;
            } else if (val === 'TÜRKPATENT') {
                // Not: Orijinal kodunuzda 'TÜRKPATENT' karakterleri bozuk görünüyor (TÃœRKPATENT),
                // burada temiz bir değer kullanıyorum. Eğer veritabanında bozuksa, ona uygun düzeltme yapmanız gerekebilir.
                filteredData = allData.filter(item => {
                    var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
                    return orig === 'TÜRKPATENT' || orig === 'TURKPATENT' || orig === '';
                });
            } else if (val === 'YURTDISI') {
                filteredData = allData.filter(item => {
                    var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
                    // Buradaki kontrolünüz de muhtemelen karakter hatasından etkileniyordu:
                    return orig !== 'TÜRKPATENT' && orig !== 'TURKPATENT' && orig !== '';
                });
                console.log('✅ Yurtdışı filtreleme sonucu:', filteredData.length, 'kayıt bulundu');
            }
            
            window.markaPaginationData.allData = filteredData;
            window.markaPaginationData.currentPage = 1;
            window.markaPaginationData.totalPages = Math.ceil(filteredData.length / window.markaPaginationData.itemsPerPage);
            
            var firstPage = filteredData.slice(0, window.markaPaginationData.itemsPerPage);
            if (window.__originalPopulate) {
                window.__originalPopulate('#marka-list', firstPage);
            }
            if (window.renderMarkaPagination) {
                window.renderMarkaPagination();
            }
        }
    }
};

// --- Olay Yöneticileri (Bu kısım zaten doğruydu, sadece bağlam için ekledim) ---

$(document).on('change', '#menseFilter', function(){
    applyMenseFilterToActivePane();
});

$(document).on('shown.bs.tab', '#portfolioTopTabs a[data-toggle="tab"]', function (e) {
    applyMenseFilterToActivePane();
});

$(function(){
    // Sayfa yüklendiğinde varsayılan filtreyi uygula
    applyMenseFilterToActivePane();
});

// Client Portal menü aktif durumu yönetimi
$(document).ready(function() {
    // Ana menü linklerine click event ekle (İşlerim, Faturalarım, Raporlar)
    $('.nav-link[data-toggle="tab"]:not(#portfoy-accordion .nav-link)').on('click', function() {
        // Tüm ana menü nav-link'lerden active sınıfını kaldır
        $('.sidebar .nav-link').removeClass('active');
        // Tıklanan linke active sınıfını ekle
        $(this).addClass('active');
    });
    
    // Portföyüm dropdown için özel yönetim
    $('a[data-target="#portfoy-accordion"]').on('click', function() {
        // Tüm ana menü nav-link'lerden active sınıfını kaldır
        $('.sidebar .nav-link').removeClass('active');
        // Portföyüm linkine active sınıfını ekle
        $(this).addClass('active');
        
        // Portfolio content'i göster
        $('.tab-pane').removeClass('show active');
        $('#portfolio-content').addClass('show active');
        
        // İlk tab'ı (Marka) aktif yap
        setTimeout(() => {
            $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
        }, 100);
        
        // Menşe filtresi uygula
        if (typeof applyMenseFilterToActivePane === 'function') {
          try { applyMenseFilterToActivePane(); } catch(_) {}
        }
    });
    
    // Portföy alt menüsü linklerine tıklandığında
    $('#portfoy-accordion a[data-toggle="tab"]').on('click', function() {
        // Ana portföyüm linkinin active durumunu koru
        $('a[data-target="#portfoy-accordion"]').addClass('active');
    });

    // Dashboard'daki kartlara tıklama işlevselliği ekleme
    $('[data-target-tab]').on('click', function() {
        const targetTabId = $(this).data('target-tab');

        // 1. Sidebar'daki ilgili linki bul ve içeriği göster
        const $targetLink = $(`a[href="#${targetTabId}"]`); // #sidebar ihtiyacı yok, href'e göre bulması yeterli

        if ($targetLink.length) {
            $targetLink.tab('show');

            // 2. Tıkladıktan sonra sidebar'daki aktiflik durumunu güncelle
            $('#sidebar .nav-link').removeClass('active');
            
            // Eğer Portföyüm ise portföy linkini, değilse direkt kartın hedefini aktif yap
            if (targetTabId === 'portfolio-content') {
                $('a[data-target="#portfoy-accordion"]').addClass('active');
            } else {
                $targetLink.addClass('active');
            }
            
            // Portföyüm sekmesine gidiliyorsa, içindeki Marka tab'ını da aktif et
            if (targetTabId === 'portfolio-content') {
                 // İlk tab'ı (Marka) aktif yap
                setTimeout(() => {
                    $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                }, 100);
            }
        }
    });
});

async function fetchAndDisplayTasks(linkedPersonIds){
    const q = query(collection(db, "tasks"), where("personsRelatedIds", "array-contains-any", linkedPersonIds));
    const snap = await runGetDocs(q);
    const container = document.querySelector('#tasks .row');
    container.innerHTML = '';
    snap.forEach(docSnap => {
        const t = docSnap.data();
        const card = document.createElement('div');
        card.className = 'col-md-12 mb-4';
        card.innerHTML = `
          <div class="task-card task-card-warning">
            <h5 class="task-title">${t.title || 'İş'}</h5>
            <p class="task-description">${t.description || ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small class="task-meta"><i class="fas fa-clock mr-1"></i>Son Onay Tarihi: ${t.dueDate || '-'}</small>
              <div>
                <button class="btn btn-success btn-sm btn-action"><i class="fas fa-check"></i> Onayla</button>
                <button class="btn btn-danger btn-sm btn-action"><i class="fas fa-times"></i> Reddet</button>
                <button class="btn btn-info btn-sm btn-action"><i class="fas fa-eye"></i> İncele</button>
              </div>
            </div>
          </div>`;
        container.appendChild(card);
    });
}

async function fetchAndDisplayInvoices(linkedPersonIds){
    const q = query(collection(db, "accruals"), where("personsRelatedIds", "array-contains-any", linkedPersonIds));
    const snap = await runGetDocs(q);
    const tableBody = document.querySelector('#invoices table tbody');
    tableBody.innerHTML = '';
    snap.forEach(d => {
        const a = d.data();
        const statusBadge = a.isPaid ? `<span class="badge badge-success">Ödendi</span>` : `<span class="badge badge-warning">Ödenmemiş</span>`;
        const actions = a.isPaid
          ? `<button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>`
          : `<button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
             <button class="btn btn-success btn-sm btn-action"><i class="fas fa-lira-sign"></i> Öde</button>`;
        tableBody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${a.invoiceNo || '-'}</td>
            <td>${a.date || '-'}</td>
            <td>${a.description || '-'}</td>
            <td>${a.amount || '-'}</td>
            <td>${statusBadge}</td>
            <td>${actions}</td>
          </tr>
        `);
    });
}

// Modal açıldığında verileri set et
$(document).on('show.bs.modal', '#portfolioDetailModal', async function (e) {
    // Ana sayfanın mevcut durumunu kaydet
    window._savedPortfolioState = {
        activeTab: $('.tab-content > .tab-pane.show.active').attr('id'),
        sidebarActive: $('#sidebar .nav-link.active').attr('href')
    };
    
    const triggerLink = $(e.relatedTarget);
    const itemId = triggerLink.data('item-id');
    
    if (!itemId) return;
    
    // Tüm verilerden ilgili kaydı bul
    const allData = window.markaPaginationData?.allDataUnfiltered || [];
    const item = allData.find(p => p.id === itemId);
    
    if (!item) return;
    
    // Modal başlığını set et
    $('#portfolioDetailModalLabel').text((item.title || item.brandText || 'Detaylar'));
    
    // Marka görseli
    const brandImg = item.brandImageUrl || item.brandImage || 'https://via.placeholder.com/150';
    $('#portfolioDetailModal .card-body img').attr('src', brandImg);
    
    // Varlık Detayları
    const type = item.type === 'trademark' ? 'Marka' : 
                 item.type === 'patent' ? 'Patent' : 
                 item.type === 'design' ? 'Tasarım' : 'Diğer';
    const appNo = item.applicationNumber || item.applicationNo || '-';
    const regNo = item.registrationNumber || item.registrationNo || '-';
    const classes = (() => {
        if (Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length) {
            const arr = item.goodsAndServicesByClass.map(c => parseInt(c.classNo,10)).filter(n => !isNaN(n));
            return Array.from(new Set(arr)).sort((a,b)=>a-b).join(', ');
        }
        return item.classes || '-';
    })();
    const status = item.status || item.statusText || 'Bilinmiyor';
    const badgeClass = {
        'Başvuru': 'primary',
        'application_filed': 'primary',
        'Tescilli': 'success',
        'registered': 'success',
        'İtiraz': 'warning',
        'objection': 'warning',
        'Reddedildi': 'danger',
        'rejected': 'danger'
    }[status] || 'secondary';
    
    // Tarihleri formatla
    const formatDate = (dateStr) => {
        if (!dateStr || dateStr === '-') return '-';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        } catch (error) {
            return dateStr;
        }
    };
    
    const appDate = formatDate(item.applicationDate || item.application_date);
    const regDate = formatDate(item.registrationDate || item.registration_date);
    const renewalDate = formatDate(item.renewalDate || item.renewal_date);

    // Varlık Detayları kartını güncelle
    const detailsCard = $('#portfolioDetailModal .row .col-md-4:eq(1) .card-body');
    detailsCard.html(`
        <p><strong>Tür:</strong> ${type}</p>
        <p><strong>Başvuru No:</strong> ${appNo}</p>
        <p><strong>Tescil No:</strong> ${regNo}</p>
        <p><strong>Sınıf:</strong> ${classes}</p>
    `);
    
// Tarihler/Durum kartını güncelle
    const datesCard = $('#portfolioDetailModal .row .col-md-4:eq(2) .card-body');
    datesCard.html(`
        <p><strong>Başvuru Tarihi:</strong> ${appDate}</p>
        <p><strong>Tescil Tarihi:</strong> ${regDate}</p>
        <p><strong>Yenileme Tarihi:</strong> ${renewalDate}</p>
        <p><strong>Durum:</strong> <span class="badge badge-${badgeClass}">${status}</span></p>
    `);
    
// Eşya Listesi (Mal ve Hizmet Sınıfları)
    const esyaContent = $('#esyaListesiContent');
    if (item.goodsAndServicesByClass && Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length > 0) {
        let esyaHtml = '';
        item.goodsAndServicesByClass.forEach(cls => {
            const classNo = cls.classNo || '-';
            
            // items array'ini kontrol et ve birleştir
            let description = 'Açıklama yok';
            if (cls.items && Array.isArray(cls.items) && cls.items.length > 0) {
                description = cls.items.join('; ');
            }
            
            esyaHtml += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Sınıf ${classNo}</strong>
                    </div>
                    <div class="card-body">
                        <p>${description}</p>
                    </div>
                </div>
            `;
        });
        esyaContent.html(esyaHtml);
    } else {
        esyaContent.html('<p class="text-muted">Mal ve hizmet bilgisi bulunamadı.</p>');
    }
    
// İşlemler sekmesini doldur (transactions koleksiyonundan)
    await loadTransactions(item.id);
    
    // Modal açıldığında tab'ları sıfırla ve ilk tab'ı aktif yap
    $('#portfolioDetailModal #myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
    $('#portfolioDetailModal .tab-content .tab-pane').removeClass('show active');
    
    // İlk tab'ı aktif yap
    $('#myTab a[href="#modal-islemler"]').addClass('active').attr('aria-selected', 'true');
    $('#modal-islemler').addClass('show active');
});

// Modal kapatıldığında temizlik yap
$(document).on('hidden.bs.modal', '#portfolioDetailModal', function (e) {
    // Modal içindeki tab'ları sıfırla
    $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
    $('#portfolioDetailModal .tab-pane').removeClass('show active');
    
    // İlk tab'ı hazır hale getir (bir sonraki açılış için)
    $('#myTab a[href="#modal-islemler"]').addClass('active').attr('aria-selected', 'true');
    $('#modal-islemler').addClass('show active');
    
    // Ana sayfayı kayıtlı duruma geri yükle
    setTimeout(() => {
        if (window._savedPortfolioState) {
            const savedTab = window._savedPortfolioState.activeTab;
            const savedSidebar = window._savedPortfolioState.sidebarActive;
            
            // Ana content tab'larını sıfırla
            $('.content > .tab-content > .tab-pane').removeClass('show active');
            
            // Kaydedilmiş tab'ı aktif yap
            if (savedTab) {
                $('#' + savedTab).addClass('show active');
            }
            
            // Sidebar'ı güncelle
            $('#sidebar .nav-link').removeClass('active');
            if (savedSidebar) {
                $(`#sidebar a[href="${savedSidebar}"]`).addClass('active');
            }
            
            // Portföy içindeyse, marka listesini ve filtreleri yenile
            if (savedTab === 'portfolio-content') {
                setTimeout(() => {
                    $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                    
                    if (typeof window.applyMenseFilterToActivePane === 'function') {
                        window.applyMenseFilterToActivePane();
                    }
                    
                    if (window.renderMarkaPagination) {
                        window.renderMarkaPagination();
                    }
                }, 50);
            }
            
            // State'i temizle
            delete window._savedPortfolioState;
        }
    }, 50);
});

// Transactions yükleme fonksiyonu
async function loadTransactions(ipRecordId) {
    const transactionsRef = collection(db, 'ipRecords', ipRecordId, 'transactions');
    const q = query(transactionsRef);
    const snapshot = await getDocs(q);
    
    const transactions = [];
    snapshot.forEach(doc => {
        transactions.push({ id: doc.id, ...doc.data() });
    });
    
    // Transaction type'ın alias değerini al (fonksiyonu döngü dışında tanımla)
    const getTransactionTypeAlias = async (typeId) => {
        if (!typeId) return 'İşlem';
        try {
            const typeDoc = await getDoc(doc(db, 'transactionTypes', String(typeId)));
            if (typeDoc.exists()) {
                return typeDoc.data().alias || typeDoc.data().name || 'İşlem';
            }
        } catch (e) {
            console.warn('Type alias alınamadı:', e);
        }
        return 'İşlem';
    };
    
    // Tarih formatla (fonksiyonu döngü dışında tanımla)
    const formatDate = (timestamp) => {
        if (!timestamp) return '-';
        try {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        } catch (e) {
            return '-';
        }
    };
    
    // Parent transactions'ları filtrele
    const parentTransactions = transactions.filter(t => t.transactionHierarchy === 'parent');
    
    // Tabloyu doldur
    const tableBody = $('#modal-islemler table tbody');
    tableBody.empty();
    
    let rowIndex = 1;
    
    // forEach yerine for...of kullan (await çalışması için)
    for (const parent of parentTransactions) {
        // Child transactions'ları bul
        const children = transactions.filter(t => 
            t.transactionHierarchy === 'child' && t.parentId === parent.id
        );
        
        const hasChildren = children.length > 0;
        const accordionId = `transaction-${parent.id}`;
        
        const transactionAlias = await getTransactionTypeAlias(parent.type);
        
        // Parent satırı
        const parentRow = `
            <tr class="${hasChildren ? 'accordion-header-row' : ''}" ${hasChildren ? `data-toggle="collapse" data-target="#${accordionId}" aria-expanded="false" aria-controls="${accordionId}"` : ''}>
                <td>${hasChildren ? '<i class="fas fa-chevron-right mr-2"></i>' : ''}${rowIndex}</td>
                <td>${transactionAlias}</td>
                <td>${formatDate(parent.timestamp)}</td>
                <td><a href="#" class="btn btn-sm btn-info" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
            </tr>
        `;
        
        tableBody.append(parentRow);
        
        // Child satırları (akordeon içinde)
        if (hasChildren) {
            let childTableHtml = `
                <tr>
                    <td colspan="4" class="p-0">
                        <div class="collapse" id="${accordionId}">
                            <table class="table mb-0 accordion-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>İşlem Açıklaması</th>
                                        <th>Tarih</th>
                                        <th>Evrak</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            for (const [idx, child] of children.entries()) {
                const childAlias = await getTransactionTypeAlias(child.type);
                childTableHtml += `
                    <tr>
                        <td>${rowIndex}.${idx + 1}</td>
                        <td>${childAlias}</td>
                        <td>${formatDate(child.timestamp)}</td>
                        <td><a href="#" class="btn btn-sm btn-info" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                    </tr>
                `;
            }
            
            childTableHtml += `
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            `;
            
            tableBody.append(childTableHtml);
        }
        
        rowIndex++;
    }
}

    // Modal tab'ları için event handler (sadece bir kez tanımla)
    $(document).ready(function() {
    // Tab tıklamalarını düzelt
    $(document).on('click', '#myTab a[data-toggle="tab"]', function (e) {
        e.preventDefault();
        
        // Önce tüm tab'ları pasif yap
        $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
        $('#portfolioDetailModal .tab-pane').removeClass('show active');
        
        // Tıklanan tab'ı aktif yap
        $(this).addClass('active').attr('aria-selected', 'true');
        const target = $(this).attr('href');
        $(target).addClass('show active');
    });
    
    // Tab gösterildiğinde aria attribute'larını güncelle
    $(document).on('shown.bs.tab', '#myTab a[data-toggle="tab"]', function (e) {
        $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
        $(e.target).addClass('active').attr('aria-selected', 'true');
    });
});

</script>
<script>
// Basit pagination implementasyonu - module import sorunu için
window.markaPaginationData = {
    allData: [],
    currentPage: 1,
    itemsPerPage: 10,
    totalPages: 0
};

window.renderMarkaPagination = function() {
    const data = window.markaPaginationData;
    const container = document.getElementById('markaPagination');
    
    if (!container || data.allData.length === 0) return;
    
    data.totalPages = Math.ceil(data.allData.length / data.itemsPerPage);
    
    let html = '<div class="pagination-wrapper" style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:rgba(255,255,255,0.9); border-radius:12px; margin-top:20px;">';
    
    // Sayfa bilgisi
    const start = (data.currentPage - 1) * data.itemsPerPage + 1;
    const end = Math.min(data.currentPage * data.itemsPerPage, data.allData.length);
    html += `<div style="font-size:14px; color:#555;">Toplam ${data.allData.length} kayıt (${start}-${end} arası gösteriliyor)</div>`;
    
    // Pagination butonları
    if (data.totalPages > 1) {
        html += '<div style="display:flex; gap:5px;">';
        
        // İlk sayfa
        html += `<button onclick="window.goToMarkaPage(1)" ${data.currentPage === 1 ? 'disabled' : ''} style="padding:8px 12px; border:1px solid #ddd; background:white; color:#333; border-radius:6px; cursor:pointer;">İlk</button>`;
        
        // Önceki
        html += `<button onclick="window.goToMarkaPage(${data.currentPage - 1})" ${data.currentPage === 1 ? 'disabled' : ''} style="padding:8px 12px; border:1px solid #ddd; background:white; color:#333; border-radius:6px; cursor:pointer;">Önceki</button>`;
        
        // Sayfa numaraları
        const startPage = Math.max(1, data.currentPage - 2);
        const endPage = Math.min(data.totalPages, data.currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === data.currentPage;
            html += `<button onclick="window.goToMarkaPage(${i})" style="padding:8px 12px; border:1px solid ${isActive ? '#007bff' : '#ddd'}; background:${isActive ? '#007bff' : 'white'}; color:${isActive ? 'white' : '#333'}; border-radius:6px; cursor:pointer; font-weight:${isActive ? '600' : 'normal'};">${i}</button>`;
        }
        
        // Sonraki
        html += `<button onclick="window.goToMarkaPage(${data.currentPage + 1})" ${data.currentPage === data.totalPages ? 'disabled' : ''} style="padding:8px 12px; border:1px solid #ddd; background:white; color:#333; border-radius:6px; cursor:pointer;">Sonraki</button>`;
        
        // Son sayfa
        html += `<button onclick="window.goToMarkaPage(${data.totalPages})" ${data.currentPage === data.totalPages ? 'disabled' : ''} style="padding:8px 12px; border:1px solid #ddd; background:white; color:#333; border-radius:6px; cursor:pointer;">Son</button>`;
        
        html += '</div>';
    }
    
    html += '</div>';
    container.innerHTML = html;
};

window.goToMarkaPage = function(page) {
    const data = window.markaPaginationData;
    if (page < 1 || page > data.totalPages || page === data.currentPage) return;
    
    data.currentPage = page;
    
    // Mevcut sayfadaki verileri render et
    const start = (page - 1) * data.itemsPerPage;
    const end = start + data.itemsPerPage;
    const pageData = data.allData.slice(start, end);
    
    if (window.__originalPopulate) {
        window.__originalPopulate('#marka-list', pageData);
    }
    
    window.renderMarkaPagination();
};

// --- Sidebar / Top-level tab behavior ---
(function(){
  var $ = window.jQuery;
  if (!$) return;
  // Click: show tab via Bootstrap and prevent default anchor jump scroll
  $('#sidebar a[data-toggle="tab"]').on('click', function(e){
    e.preventDefault();
    $(this).tab('show');
  });
  // When a top-level tab is shown, mark only it as active and update hash
  $('#sidebar a[data-toggle="tab"]').on('shown.bs.tab', function(e){
    $('#sidebar .nav-link').removeClass('active');
    $(e.target).addClass('active');
    var href = $(e.target).attr('href');
    if (href && href.startsWith('#')) {
      history.replaceState(null, '', href);
    }
  });
  // Open tab from URL hash on load / hashchange
  function openHashTab(){
    var hash = window.location.hash;
    if (hash && $('#sidebar a[data-toggle="tab"][href="'+hash+'"]').length) {
      $('#sidebar a[data-toggle="tab"][href="'+hash+'"]').tab('show');
    }
  }
  $(window).on('hashchange', openHashTab);
  // Initial: if no hash, show dashboard
  if (window.location.hash) openHashTab();
  else $('#sidebar a[data-toggle="tab"][href="#dashboard"]').tab('show');
})();
// --- İşlerim Sayfası Navigasyon Mantığı ---

const $tasksMain = $('#task-main-cards');
const $tasksDetail = $('#task-detail-cards');
const $tasksList = $('#task-list-details');
const $tasksHeader = $('#tasksHeaderTitle');
const $tasksLead = $('#tasksLeadText');

// Geri Butonu: Detay Kartlardan Ana Kartlara Dönüş
$(document).on('click', '#backToMainTasks', function() {
    $tasksMain.show();
    $tasksDetail.hide();
    $tasksList.hide();
    $tasksHeader.text('İşlerim');
    $tasksLead.text('Lütfen incelemek istediğiniz fikri mülkiyet türünü seçin.');
});

// Geri Butonu: Detay Listeden Detay Kartlara Dönüş
$(document).on('click', '#backToDetailCards', function() {
    $tasksMain.hide();
    $tasksDetail.show();
    $tasksList.hide();
    $tasksHeader.text('Marka İşlemleri'); // Bu, en son seçilen IP türüne göre değişmeli
    $tasksLead.text('İncelemek istediğiniz işlem türünü seçin.');
    // Liste alanını temizle
    $('#task-list-container').empty();
});

// Ana Kart Tıklaması: Marka, Patent, Tasarım, Dava
$(document).on('click', '.task-card-link', function() {
    const targetArea = $(this).data('target-area');
    
    // Başlığı ve açıklamayı güncelle
    const headerText = $(this).find('.stat-label').text();
    $tasksHeader.text(headerText);
    $tasksLead.text('İncelemek istediğiniz işlem türünü seçin.');
    
    // Sadece Marka'nın alt kartlarını gösteriyoruz (şimdilik)
    if (targetArea === 'marka-tasks') {
        $tasksMain.hide();
        $tasksDetail.show();
        $tasksList.hide();
        // İlgili kartların sayılarını güncelle (Bu kısım Firebase sorgularıyla yapılmalı)
        // updateTaskDetailCounts(linkedPersonIds, 'marka');
    } else {
        // Diğer kartlar için de aynı mantığı uygulayabilirsiniz
        // Şimdilik sadece uyarı verelim
        $tasksHeader.text(headerText + ' - Yapım Aşamasında');
        $tasksLead.text('Bu kategoriye ait alt işlemler henüz tanımlanmadı. Lütfen Marka İşlemleri sekmesini kullanın.');
    }
});

// Detay Kart Tıklaması: Onay Bekleyen İşler, Yenileme Onayları vb.
$(document).on('click', '.detail-card-link', function() {
    const taskType = $(this).data('task-type');
    
    // Görünümü Detay İş Listesi'ne geçir
    $tasksDetail.hide();
    $tasksList.show();
    
    // Başlığı, tıklanan karta göre güncelle
    const headerText = $(this).find('.stat-label').text();
    $tasksHeader.text('Detaylı İş Listesi: ' + headerText);
    $tasksLead.text('Aşağıda seçtiğiniz iş türüne ait tüm işlemler listelenmiştir.');
    
    // İlgili işleri yükleme fonksiyonunu çağır
    // fetchAndDisplayTasks(linkedPersonIds, taskType);
    // Şimdilik statik veriyi çağırıyoruz:
    loadSampleTaskDetails(taskType);
});

// Test/Geliştirme amaçlı örnek listeyi yükleme fonksiyonu
function loadSampleTaskDetails(taskType) {
    const container = document.getElementById('task-list-container');
    container.innerHTML = '';
    
    let sampleTasks = [];
    if (taskType === 'pending-approval') {
        sampleTasks = [
            { title: 'Marka Tescil Başvurusu - "Evreka"', description: 'Belgeleri inceleyin.', dueDate: '15.11.2025' },
            { title: 'Marka Başvurusu Devir İşlemi', description: 'Taslak belgeleri onaylayın.', dueDate: '01.12.2025' },
        ];
    } else if (taskType === 'renewal-approval') {
        sampleTasks = [
            { title: 'Yenileme Onayı - Marka XYZ', description: 'Marka yenileme ücreti ve süreci onayı.', dueDate: '20.10.2025' }
        ];
    } else if (taskType === 'bulletin-watch') {
        sampleTasks = [
            { title: 'Bülten Bildirimi - İtiraz Değerlendirmesi', description: 'Benzer marka tespit edildi, itiraz onayı.', dueDate: '05.11.2025' }
        ];
    }
    
    if (sampleTasks.length === 0) {
         container.innerHTML = '<p class="lead text-muted text-center mt-5">Bu kategoride onay bekleyen iş bulunmamaktadır.</p>';
         return;
    }
    
    sampleTasks.forEach(t => {
        const card = document.createElement('div');
        card.className = 'col-md-12 mb-4';
        card.innerHTML = `
          <div class="task-card task-card-warning">
            <h5 class="task-title">${t.title}</h5>
            <p class="task-description">${t.description}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small class="task-meta"><i class="fas fa-clock mr-1"></i>Son Onay Tarihi: ${t.dueDate}</small>
              <div>
                <button class="btn btn-success btn-sm btn-action"><i class="fas fa-check"></i> Onayla</button>
                <button class="btn btn-danger btn-sm btn-action"><i class="fas fa-times"></i> Reddet</button>
                <button class="btn btn-info btn-sm btn-action"><i class="fas fa-eye"></i> İncele</button>
              </div>
            </div>
          </div>`;
        container.appendChild(card);
    });
}
</script>
</body>
</html>