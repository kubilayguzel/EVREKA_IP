<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müvekkil Portalı - Anasayfa</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        /* === Genel ve Koyu Tema Stilleri (Varsayılan) === */
        body.dark-mode {
            font-family: 'Poppins', sans-serif; 
            background-color: #2b2d31; 
            color: #e0e0e0; 
            transition: background-color 0.5s, color 0.5s;
        }
        .dark-mode #sidebar { 
            background-color: #36393e; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        .dark-mode #sidebar .nav-link { 
            color: #b0b8c0;
        }
        /* Hover yumuşak, aktif belirgin */
        .dark-mode #sidebar .nav-link:hover {
            background-color: #3a3f45;
            color: #b0b8c0;
            transform: translateX(3px);
        }
        .dark-mode #sidebar .nav-link.active {
            background-color: #40444b;
            color: #4da6ff; 
            transform: translateX(5px);
        }

        .dark-mode .header-title { 
            color: #f8f9fa;
        }
        .dark-mode .lead { 
            color: #b0b8c0; 
        }
        .dark-mode .card { 
            background-color: #36393e; 
            color: #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
        }
        .dark-mode .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
        }
        .dark-mode .card-header {
            background-color: #40444b;
            border-bottom: 1px solid #585b63;
            color: #f8f9fa;
        }
        .dark-mode .stat-label { color: #b0b8c0; }
        .dark-mode .table-responsive {
            background-color: #36393e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .dark-mode .table { color: #e0e0e0; }
        .dark-mode .table thead th { border-bottom: 2px solid #585b63; color: #f8f9fa; font-weight: 600; }
        .dark-mode .table tbody tr:hover { background-color: #40444b; }
        /* Koyu temada hover'da metin siyahlaşmasın */
        .dark-mode .table-hover tbody tr:hover {
        color: #e0e0e0 !important;        /* temel metin */
        background-color: #40444b !important;
        }

        /* Linkler de görünür kalsın */
        .dark-mode .table-hover tbody tr:hover a {
        color: #4da6ff !important;        /* koyu temadaki link rengiyle uyumlu */
        text-decoration: none;
        }

        /* Hücre içindekiler rengi miras alsın */
        .dark-mode .table-hover tbody tr:hover td,
        .dark-mode .table-hover tbody tr:hover th,
        .dark-mode .table-hover tbody tr:hover span,
        .dark-mode .table-hover tbody tr:hover small {
        color: inherit !important;
        }

        /* Badge’ler zaten kendi zıt renklerini kullanıyor; yine de zorlanırsa: */
        .dark-mode .table-hover tbody tr:hover .badge {
        filter: none;                      /* renkleri bozulmasın */
        color: inherit;                    /* badge iç yazı okunur kalsın */
        }

        .dark-mode .badge-filed { background-color: #4da6ff; color: #1e3c72; }
        .dark-mode .badge-registered { background-color: #5cb85c; color: #1a3b1c; }
        .dark-mode .badge-objection { background-color: #f0ad4e; color: #4e351b; }
        .dark-mode .badge-rejected { background-color: #d9534f; color: #3d1b1a; }
        .dark-mode .modal-content {
            background-color: #36393e;
            color: #e0e0e0;
            border: 1px solid #585b63;
        }
        .dark-mode .modal-header { border-bottom: 1px solid #585b63; }
        .dark-mode .modal-footer { border-top: 1px solid #585b63; }
        .dark-mode .close { color: #fff !important; opacity: 1 !important; }
        .dark-mode .nav-tabs { border-bottom: 1px solid #585b63; }
        .dark-mode .nav-tabs .nav-link { color: #b0b8c0; background-color: #3a3f45; }
        .dark-mode .nav-tabs .nav-item .nav-link.active {
            background-color: #30343a !important; 
            color: #4da6ff !important;
            border-color: #585b63 #585b63 #30343a;
        }
        .dark-mode .tab-content-card { background-color: #30343a; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 30px; }
        .dark-mode .task-card {
            background-color: #36393e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .dark-mode .task-card .task-title { color: #4da6ff; }
        .dark-mode .task-card .task-description { color: #b0b8c0; }
        .dark-mode .task-card .task-meta { color: #f0ad4e; }
        .dark-mode .form-control { background-color: #40444b; border-color: #585b63; color: #e0e0e0; }

        /* === Beyaz Tema Stilleri === */
        body.light-mode {
            background-color: #f0f2f5; 
            color: #333;
        }
        .light-mode #sidebar { 
            background-color: #ffffff; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .light-mode #sidebar .nav-link { 
            color: #555; 
        }
        .light-mode #sidebar .nav-link:hover, .light-mode #sidebar .nav-link.active {
            background-color: #e3f2fd;
            color: #1e88e5; 
        }
        .light-mode .header-title { 
            color: #1e3c72;
        }
        .light-mode .lead { 
            color: #777; 
        }
        .light-mode .card { 
            background-color: #ffffff; 
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            color: #1e3c72;
        }
        .light-mode .stat-label { color: #777; }
        .light-mode .table-responsive {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode .table { color: #333; }
        .light-mode .table thead th { border-bottom: 2px solid #e9ecef; color: #1e3c72; }
        .light-mode .table tbody tr:hover { background-color: #f8f9fa; }
        .light-mode .badge-filed { background-color: #e3f2fd; color: #1e88e5; }
        .light-mode .badge-registered { background-color: #d4edda; color: #43a047; }
        .light-mode .badge-objection { background-color: #fff3e0; color: #fb8c00; }
        .light-mode .badge-rejected { background-color: #f8d7da; color: #e53935; }
        .light-mode .modal-content {
            background-color: #ffffff;
            color: #333;
            border: 1px solid #dee2e6;
        }
        .light-mode .modal-header { border-bottom: 1px solid #dee2e6; }
        .light-mode .modal-footer { border-top: 1px solid #dee2e6; }
        .light-mode .close { color: #555 !important; opacity: 1 !important; }
        .light-mode .nav-tabs { border-bottom: 1px solid #dee2e6; }
        .light-mode .nav-tabs .nav-link { color: #555; background-color: #f8f9fa; margin-right: 5px; }
        .light-mode .nav-tabs .nav-item .nav-link.active {
            background-color: #ffffff !important; 
            color: #1e3c72 !important;
            border-color: #dee2e6 #dee2e6 #ffffff;
        }
        .light-mode .tab-content-card { background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .light-mode .task-card {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .light-mode #task-detail-cards .card {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
        }
        .light-mode .task-card .task-title { color: #1e3c72; }
        .light-mode .task-card .task-description { color: #555; }
        .light-mode .task-card .task-meta { color: #fb8c00; }
        .light-mode .form-control { background-color: #fff; border-color: #ccc; color: #333; }

        /* === Genel Stiller (Temadan bağımsız) === */
        body { 
            font-family: 'Poppins', sans-serif; 
            transition: background-color 0.5s, color 0.5s;
        }
        #sidebar { 
            height: 100vh; 
            width: 250px; 
            position: fixed; 
            top: 0; 
            left: 0; 
            padding-top: 20px; 
        }
        #sidebar .nav-link { 
            font-weight: 500; 
            padding: 12px 15px; 
            margin-bottom: 5px; 
            border-radius: 8px; 
            transition: all 0.3s;
            transform-origin: left;
        }
        #sidebar .nav-link:hover, #sidebar .nav-link.active {
            transform: translateX(5px);
        }
        .content { 
            margin-left: 250px; 
            padding: 40px; 
        }
        .header-title { font-weight: 700; }
        .card { 
            border-radius: 12px; 
            border: none; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-8px);
        }
        .stat-icon { font-size: 2.5em; }
        .stat-value { font-size: 2.2em; font-weight: 700; line-height: 1; }
        .stat-label { font-size: 1em; }
        .table-responsive {
            border-radius: 12px;
            padding: 20px;
        }
        .table { font-size: 0.95rem; }
        .table thead th { border-bottom: 2px solid; font-weight: 600; }
        .table tbody tr:hover { cursor: pointer; }
        .modal-content { border-radius: 12px; }
        .nav-tabs .nav-link { border-radius: 8px 8px 0 0; font-weight: 600; }
        .btn-action { margin-right: 5px; transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-2px); }

        /* Yeni Eklenenler */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .task-card {
            border-left: 5px solid;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .task-card:hover {
            transform: translateY(-5px);
        }
        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .task-card:hover::before {
            opacity: 1;
        }
        .task-card .task-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .task-card .task-description {
            margin-bottom: 15px;
        }
        .task-card .task-meta {
            font-size: 0.9rem;
        }
        .task-card-success { border-color: #5cb85c; }
        .task-card-warning { border-color: #f0ad4e; }
        .task-card-danger { border-color: #d9534f; }
        
        .tab-content-card .nav-tabs .nav-link,
        .modal-content .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
        }
        .tab-content-card .nav-tabs .nav-link.active,
        .modal-content .nav-tabs .nav-link.active {
            border-bottom-color: transparent !important;
        }
        
        /* Akordeon stilleri */
        .accordion-item {
            background-color: inherit;
            border: none;
        }
        .accordion-header-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .accordion-header-row:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        .accordion-body-content {
            background-color: #3f444a;
            color: #e0e0e0;
            padding: 0 15px;
        }
        .table .accordion-body-row:hover {
            background-color: #495057;
        }
        .accordion-table td {
            border-top: 1px solid;
            text-align: center;
        }
        .accordion-table thead tr {
            display: table-row;
        }
        .accordion-table th {
            border-bottom: 2px solid;
            font-weight: 600;
            text-align: center; /* Kolon başlıklarını ortala */
        }
        
        /* Top bar styles */
        .top-header {
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: 0;
            left: 250px; /* Sidebar width */
            z-index: 1000;
            display: flex;
            justify-content: space-between; /* İki tarafı ayır */
            align-items: center;
            padding: 10px 20px;
            height: 60px;
            transition: all 0.5s;
        }
        .dark-mode .top-header {
            background-color: #36393e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #1e3c72;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .user-name, .user-role {
            font-weight: 500;
        }
        .user-role {
            color: #888;
            font-size: 0.8rem;
        }
        .dark-mode .user-role {
            color: #b0b8c0;
        }
        .logout-btn {
            background-color: #d9534f;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #c9302c;
        }
        .content-with-topbar {
            margin-top: 60px; /* Height of the top bar */
        }
    
/* === Client Portal | Marka listesi kolon dağılımı === */
#marka-list table { table-layout: auto; }
#marka-list th.col-index, #marka-list td.col-index { width: 56px; white-space: nowrap; }
#marka-list th.col-brand, #marka-list td.col-brand { width: 28%; }
#marka-list th.col-sample, #marka-list td.col-sample { width: 120px; text-align:center; }
#marka-list th.col-appno, #marka-list td.col-appno { width: 12%; white-space: nowrap; }
#marka-list th.col-regno, #marka-list td.col-regno { width: 12%; white-space: nowrap; }
#marka-list th.col-appdate, #marka-list td.col-appdate { width: 12%; white-space: nowrap; }
#marka-list th.col-status, #marka-list td.col-status { width: 10%; white-space: nowrap; }
#marka-list th.col-classes, #marka-list td.col-classes { 
    width: 16%; 
    white-space: normal; /* nowrap yerine normal */
    word-wrap: break-word;
    line-height: 1.4;
}
#marka-list td, #marka-list th { vertical-align: middle; }
</style>

<style>
/* Portföyüm alt menüsü kaldırıldı */
#portfoy-accordion { display: none !important; }
</style>


<style>
#portfolioTabsBar .nav-tabs .nav-link { white-space: nowrap; }
@media (max-width: 576px){
  #portfolioTabsBar { gap: .5rem; }
}
</style>


<style>
/* İşlem Geçmişi: Açıklama kolonunu sola yasla */
#modal-islemler table thead th:nth-child(2),
#modal-islemler table tbody td:nth-child(2){
  text-align: left !important;
}

/* İşlem Geçmişi: Akordeon alt (child) girdiler daha küçük puntoda */
#modal-islemler .accordion-table th,
#modal-islemler .accordion-table td{
  font-size: 0.875rem; /* ~14px */
  line-height: 1.35;
}
</style>


<style>
/* Tabs sola yaslansın, filtre yanında boşlukla dursun */
#portfolioTabsBar{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* sola yasla */
  flex-wrap:wrap;
  gap:.5rem 1rem; /* satırlar ve sütunlar arası boşluk */
  margin-bottom:.5rem;
}
#portfolioTabsBar #portfolioTopTabs{
  margin-bottom:0 !important;
}
#portfolioTabsBar #portfolioFilters{
  margin-left:1rem; /* tabların yanında boşluk */
}
/* Küçük ekranlarda filtre tabların altına geçebilir, boşlukları koru */
@media (max-width:576px){
  #portfolioTabsBar{ gap: .5rem; }
  #portfolioTabsBar #portfolioFilters{ margin-left:0; }
}
</style>


<style>
/* Portföy sekmeleri sola yaslı ve filtre yanında */
#portfolioTabsBar{
  display:flex !important;
  align-items:center !important;
  justify-content:flex-start !important; /* sola hizala */
  flex-wrap:wrap;
  width:100%;
}
#portfolioTabsBar #portfolioTopTabs{
  flex-grow:0;
  margin-right:1rem; /* sekmeler ile filtre arasında boşluk */
}
#portfolioTabsBar #portfolioFilters{
  flex-grow:0;
}
</style>


<style>
/* Force tabs to left; filter sits next with small space */
#portfolioTabsBar{
  display:flex !important;
  align-items:center !important;
  justify-content:flex-start !important;
  flex-wrap:wrap;
  gap:.5rem 1rem;
}
#portfolioTopTabs{
  margin:0 !important;
  margin-right:1rem !important; /* small gap before filter */
}
#portfolioFilters{
  margin:0 !important;
}
/* neutralize any justify-content utilities that might be applied */
#portfolioTabsBar .nav-tabs{
  justify-content:flex-start !important;
}
</style>


<style>
/* Menşe filtresi tabs listesinin sonunda nav-item olarak yer alır */
#portfolioTopTabs {
  display:flex;
  align-items:center;
}
#portfolioTopTabs #portfolioFiltersNavItem label{
  white-space: nowrap;
}
#portfolioTopTabs #portfolioFiltersNavItem select{
  min-height: calc(1.5em + .5rem + 2px);
}
/* Marka Örneği hover efekti */
#marka-list img.brand-thumb {
    height: 128px !important;
    width: auto;
    border-radius: 6px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

#marka-list img.brand-thumb:hover {
    transform: scale(2.2);
    z-index: 999;
    position: relative;
}

/* Görselin kendi hizası */
#marka-list td.col-sample {
  text-align: center;         /* İçindeki metin/görseli yatay ortala */
  vertical-align: middle;     /* İçeriği dikey ortala (Zaten default olabilir ama emin olmak için) */
  /* display: flex; ve align-items: center; satırlarını kaldır! */
}

/* Görselin kendi hizası */
#marka-list img.brand-thumb {
  display: block;
  margin: 0 auto;             /* Görseli yatay ortala */
}

/* Akordeon ok animasyonu */
.accordion-header-row .fa-chevron-right {
    transition: transform 0.3s;
}
.accordion-header-row[aria-expanded="true"] .fa-chevron-right {
    transform: rotate(90deg);
}
/* Yeni eklenen iş kartları için Dashboard stili */
#task-main-cards .card,
#task-detail-cards .card { 
    border-radius: 12px; 
    border: none; 
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
}
#task-main-cards .card:hover,
#task-detail-cards .card:hover {
    transform: translateY(-8px);
    cursor: pointer;
}
/* Koyu Tema uyumu */
.dark-mode #task-main-cards .card:hover,
.dark-mode #task-detail-cards .card:hover {
    box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}
.dark-mode #task-main-cards .card { 
    background-color: #36393e; 
    color: #e0e0e0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.dark-mode #task-detail-cards .card { 
    background-color: #4a4f57; 
    color: #e0e0e0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    border: 1px solid #585b63;
}
/* Aktif Kart Vurgusu */
.task-card-link.active-task-area .card {
    border: 2px solid #4da6ff; /* Mavi çerçeve (Koyu Tema) */
    transform: none; /* Hafif yukarı kalkmayı iptal et */
    box-shadow: 0 0 15px rgba(77, 166, 255, 0.5);
    opacity: 1;
}

.dark-mode .task-card-link:not(.active-task-area) {
    opacity: 0.5; /* Seçili olmayanları hafifçe soluklaştır */
    transition: opacity 0.3s;
}

.light-mode .task-card-link.active-task-area .card {
    border: 2px solid #1e88e5; /* Mavi çerçeve (Beyaz Tema) */
}
.light-mode .task-card-link:not(.active-task-area) {
    opacity: 0.6;
    transition: opacity 0.3s;
}
/* İŞLERİM filtre alanı font düzeltmeleri */
#task-list-filters label {
    font-size: 0.9rem; /* Portföy filtreleriyle aynı veya benzer yap */
    font-weight: 500;
}
#task-list-filters .form-control-sm {
    font-size: 0.9rem; 
    line-height: 1.5;
}
#task-list-filters .card-title {
    font-size: 1.1rem; /* Başlık fontu */
}
/* GÖREV KARTLARI İÇİN SIRALAMA NUMARASI VE STİLİ */
/* Bülten İzleme Kartı Kıyaslama Stilleri */
.comparison-area {
    border-top: 1px solid #4a4f57; /* Koyu temada ayırıcı */
}
.dark-mode .comparison-area {
    border-top: 1px solid #585b63;
}
.light-mode .comparison-area {
    border-top: 1px solid #e9ecef;
}
.task-card-comparison-item img {
    border: 1px solid #585b63;
}
/* Görev kartlarındaki marka görsellerine hover efekti */
.task-brand-image:hover {
    transform: scale(2.5) !important;
    z-index: 1000;
    position: relative;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
}
/* 1. Kartı pozisyonlamaya hazırla ve numara için üstten boşluk bırak */
.task-card {
    position: relative;          
    padding-top: 35px !important; /* Numara etiketi için yukarıdan boşluk */
    padding-left: 20px !important; /* Numaranın sola dayanmaması için boşluk */
}

/* 2. Numara etiketini kartın sol üst köşesine sabitle */
.task-number-tag {
    position: absolute;
    top: 8px;                    
    left: 15px;                  
    font-size: 1.3rem;
    font-weight: 700;
    line-height: 1;
    color: #4da6ff;              /* Mavi vurgu rengi */
    opacity: 0.9;
}

/* 3. Kart başlığını numaranın sağından başlat */
.task-card .task-title {
    margin-left: 30px;           
    margin-top: 0;
}

/* Tema uyumu için (Zaten eklemiştiniz ama tekrar edelim) */
.light-mode .task-number-tag { 
    color: #1e88e5; 
}
</style>

</head>
<body>
    <header class="top-header">
        <div class="theme-toggle custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="themeSwitch">
            <label class="custom-control-label" for="themeSwitch" style="color: #b0b8c0;">Koyu Tema</label>
        </div>
        <div class="user-section">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-info">
                <div class="user-name" id="userName">Yükleniyor...</div>
                <div class="user-role" id="userRole">Kullanıcı</div>
            </div>
            <button class="logout-btn" id="logoutBtn">Çıkış</button>
        </div>
    </header>

    <div id="sidebar">
        <h4 class="header-title text-center mb-4">Evreka Portalı</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link active" href="#dashboard" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="dashboard"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a></li>
            <li class="nav-item">
                <a class="nav-link" href="#portfolio-content" data-toggle="tab" role="tab" aria-selected="false" data-toggle="tab" role="tab" aria-controls="portfolio-content">
                    <i class="fas fa-folder-open mr-2"></i>Portföyüm
                </a>
                </li>
            <li class="nav-item"><a class="nav-link" href="#tasks" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="tasks"><i class="fas fa-tasks mr-2"></i>İşlerim</a></li>
            <li class="nav-item"><a class="nav-link" href="#invoices" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="invoices"><i class="fas fa-file-invoice-dollar mr-2"></i>Faturalarım</a></li>
            <li class="nav-item"><a class="nav-link" href="#reports" data-toggle="tab" data-toggle="tab" role="tab" aria-selected="false" aria-controls="reports"><i class="fas fa-chart-bar mr-2"></i>Raporlar</a></li>
        </ul>
    </div>

    <div class="content content-with-topbar">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="dashboard">
                <h1 class="header-title">Hoş Geldiniz, <span id="welcomeUserName">Müvekkil Adı</span></h1>
                <p class="lead">Portalınızda portföyünüzü, işlerinizi ve finansal bilgilerinizi yönetebilirsiniz.</p>
                <div class="row mt-5">
                    <div class="col-md-12 mb-4" id="card-portfolio" data-target-tab="portfolio-content">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-folder-open stat-icon text-info mr-4"></i>
                            <div>
                                <div id="dashPortfolio" class="stat-value">0</div>
                                <div class="stat-label">Portföy Kaydım</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4" id="card-tasks" data-target-tab="tasks">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-tasks stat-icon text-warning mr-4"></i>
                            <div>
                                <div id="dashPendingApprovals" class="stat-value">0</div>
                                <div class="stat-label">Onay Bekleyen İşlem</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4" id="card-invoices" data-target-tab="invoices">
                        <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center" style="cursor: pointer;">
                            <i class="fas fa-file-invoice-dollar stat-icon text-success mr-4"></i>
                            <div>
                                <div id="dashUnpaidInvoices" class="stat-value">0</div>
                                <div class="stat-label">Ödenmemiş Fatura</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>          
            <div class="tab-pane fade" id="portfolio-content">
                <h1 class="header-title">Portföyüm</h1>
                <p class="lead">Tüm portföy kayıtlarınızın detaylı listesi.</p>
                
                <div class="card p-4 mb-4">
                    <h5 class="card-title">Filtreleme ve Arama</h5>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="basvuruNo" class="text-muted">Başvuru No</label>
                            <input type="text" class="form-control" id="basvuruNo" placeholder="Örn: 2023/12345">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="durum" class="text-muted">Durum</label>
                            <select id="durum" class="form-control">
                                <option selected>Tümü</option>
                                <option>Başvuru</option>
                                <option>Tescilli</option>
                                <option>İtiraz</option>
                                <option>Reddedildi</option>
                            </select>
                        </div>
                        
                        <div class="form-group col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary btn-block">Filtrele</button>
                        </div>
                    </div>
                    <div class="form-row mt-3">
                        <div class="col-md-12 d-flex justify-content-end">
                            <button class="btn btn-secondary btn-sm mr-2"><i class="fas fa-file-excel mr-1"></i>Excel'e Aktar</button>
                            <button class="btn btn-secondary btn-sm"><i class="fas fa-file-pdf mr-1"></i>PDF'e Aktar</button>
                        </div>
                    </div>
                </div>

                

<div class="d-flex align-items-center justify-content-between flex-wrap mb-2" id="portfolioTabsBar">
<ul class="nav nav-tabs mb-2 mb-sm-0" id="portfolioTopTabs" role="tablist">
<li class="nav-item">
      <a class="nav-link active" id="tab-marka" data-toggle="tab" href="#marka-list" role="tab" aria-controls="marka-list" aria-selected="true">Marka</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-patent" data-toggle="tab" href="#patent-list" role="tab" aria-controls="patent-list" aria-selected="false">Patent</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-tasarim" data-toggle="tab" href="#tasarim-list" role="tab" aria-controls="tasarim-list" aria-selected="false">Tasarım</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-dava" data-toggle="tab" href="#dava-itiraz-list" role="tab" aria-controls="dava-itiraz-list" aria-selected="false">Dava/İtiraz</a>
    </li>
    <li class="nav-item d-flex align-items-center pl-2" id="portfolioFiltersNavItem" style="margin-left: .75rem;">
      <label for="menseFilter" class="mb-0 mr-2">Menşe:</label>
        <select id="menseFilter" class="form-control form-control-sm" style="max-width:220px">
        <option value="HEPSI">Hepsi</option>
        <option value="TÜRKPATENT" selected>TÜRKPATENT</option>
        <option value="YURTDISI">Yurtdışı</option>
        </select>
</li>
</ul>
</div>
<div class="tab-content table-responsive mt-3">
                    <div class="tab-pane fade show active" id="marka-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="col-index">#</th>
                                    <th class="col-origin">Menşe</th>
                                    <th class="col-sample text-center">Marka Örneği</th>
                                    <th class="col-brand">Marka</th>
                                    <th class="col-appno">Başvuru No</th>
                                    <th class="col-regno">Tescil No</th>
                                    <th class="col-appdate">Başvuru Tarihi</th>
                                    <th class="col-status">Durum</th>
                                    <th class="col-classes">Sınıflar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 1 (TR)</a></td>
                                    <td>2023/12345</td>
                                    <td><span class="badge badge-primary">Başvuru</span></td>
                                    <td>09, 35, 42</td>
                                    <td>25.10.2023</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 2 (TR)</a></td>
                                    <td>2023/11223</td>
                                    <td><span class="badge badge-success">Tescilli</span></td>
                                    <td>41</td>
                                    <td>01.07.2023</td>
                                </tr>
                                <tr class="accordion-header-row" data-toggle="collapse" data-target="#accordion-yurtdisi-1" aria-expanded="false" aria-controls="accordion-yurtdisi-1">
                                    <td><i class="fas fa-chevron-down mr-2"></i>3</td>
                                    <td><a href="#">Marka Adı 3 (WIPO)</a></td>
                                    <td>2023/IR001</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>09, 35</td>
                                    <td>15.08.2023</td>
                                </tr>
                                <tr>
                                    <td colspan="6" class="p-0">
                                        <div class="collapse" id="accordion-yurtdisi-1">
                                            <table class="table mb-0 accordion-table">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Marka Adı</th>
                                                        <th>Başvuru No</th>
                                                        <th>Durum</th>
                                                        <th>Sınıflar</th>
                                                        <th>Son İşlem</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>3.1</td>
                                                        <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 3 (Almanya)</a></td>
                                                        <td>2023/IR001</td>
                                                        <td><span class="badge badge-warning">İtiraz</span></td>
                                                        <td>09, 35</td>
                                                        <td>15.08.2023</td>
                                                    </tr>
                                                    <tr>
                                                        <td>3.2</td>
                                                        <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Marka Adı 3 (Çin)</a></td>
                                                        <td>2023/IR001</td>
                                                        <td><span class="badge badge-primary">Başvuru</span></td>
                                                        <td>09, 35</td>
                                                        <td>10.07.2023</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="markaPagination" class="mt-3"></div>
                    </div>
                    <div class="tab-pane fade" id="patent-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Patent Adı 1 (TR)</a></td>
                                    <td>2023/54321</td>
                                    <td><span class="badge badge-success">Tescilli</span></td>
                                    <td>-</td>
                                    <td>20.09.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="tasarim-list">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Tasarım Adı 1 (TR)</a></td>
                                    <td>2023/98765</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>25</td>
                                    <td>15.08.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="dava-itiraz-list">
                         <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Marka Adı</th>
                                    <th>Başvuru No</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                    <th>Son İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><a href="#" data-toggle="modal" data-target="#portfolioDetailModal">Dava Adı 1 (TR)</a></td>
                                    <td>2023/98765</td>
                                    <td><span class="badge badge-warning">İtiraz</span></td>
                                    <td>25</td>
                                    <td>15.08.2023</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tasks">
                <h1 class="header-title" id="tasksHeaderTitle">İşlerim</h1>
                <p class="lead" id="tasksLeadText">Lütfen incelemek istediğiniz fikri mülkiyet türünü seçin.</p>
                
                <div class="row mt-5" id="task-main-cards">
                    
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="marka-tasks" style="cursor: pointer;">
                    <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                        <i class="fas fa-registered stat-icon text-info mb-3"></i>
                        <div class="stat-label">Marka İşlemleri</div>
                        <div class="stat-value" id="taskCount-marka-total">0</div>
                    </div>
                    </div>
                   
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="patent-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-microchip stat-icon text-warning mb-3"></i>
                            <div class="stat-label">Patent İşlemleri</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-4 task-card-link" data-target-area="tasarim-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-palette stat-icon text-success mb-3"></i>
                            <div class="stat-label">Tasarım İşlemleri</div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4 task-card-link" data-target-area="dava-tasks" style="cursor: pointer;">
                        <div class="card p-4 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-gavel stat-icon text-danger mb-3"></i>
                            <div class="stat-label">Dava & İtiraz</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-5" id="task-detail-cards" style="display: none;">
                   
                    <div class="col-md-3 mb-4 detail-card-link" data-task-type="pending-approval" style="cursor: pointer;">
                        <div class="card p-3 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-tasks stat-icon text-warning mb-3"></i>
                            <div class="stat-label">Onay Bekleyen İşler</div>
                            <div class="stat-value" id="taskCount-pending-approval">0</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4 detail-card-link" data-task-type="renewal-approval" style="cursor: pointer;">
                        <div class="card p-3 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-sync-alt stat-icon text-info mb-3"></i>
                            <div class="stat-label">Yenileme Onayları</div>
                            <div class="stat-value" id="taskCount-renewal-approval">0</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4 detail-card-link" data-task-type="bulletin-watch" style="cursor: pointer;">
                        <div class="card p-3 text-center d-flex align-items-center flex-column justify-content-center h-100">
                            <i class="fas fa-eye stat-icon text-primary mb-3"></i>
                            <div class="stat-label">Bülten İzleme Bildirim Onayları</div>
                            <div class="stat-value" id="taskCount-bulletin-watch">0</div>
                        </div>
                    </div>
                        <div class="col-md-3 mb-4 detail-card-link" data-task-type="completed-tasks" style="cursor: pointer;">
                            <div class="card p-3 text-center d-flex align-items-center flex-column justify-content-center h-100">
                                <i class="fas fa-check-circle stat-icon text-success mb-3"></i>
                                <div class="stat-label">Talimat Verilen/Tamamlanan İşler</div>
                            </div>
                        </div>
                </div>
                <div class="row mt-4" id="task-list-filters" style="display: none;">
                    <div class="col-12">
                        <div class="card p-3">
                            <h6 class="card-title mb-3">İş Listesi Filtreleri</h6>
                            <div class="form-row align-items-end">
                                <div class="form-group col-md-5 mb-0">
                                    <label for="taskSearchText" class="text-muted">Başlıkta/ID'de Ara</label>
                                    <input type="text" class="form-control form-control-sm" id="taskSearchText" placeholder="İş Tipi, Başvuru No, Marka Adı veya ID...">
                                </div>
                                
                                <div class="form-group col-md-4 mb-0">
                                    <label for="taskStatusFilter" class="text-muted">Durum</label>
                                    <select id="taskStatusFilter" class="form-control form-control-sm">
                                        <option value="TÜMÜ" selected>Tümü</option>
                                        <option value="Açık">Açık</option>
                                        <option value="Devam Ediyor">Devam Ediyor</option>
                                        <option value="Tamamlandı">Tamamlandı</option>
                                        <option value="Beklemede">Beklemede</option>
                                        <option value="Müvekkil Onayı Bekliyor">Müvekkil Onayı Bekliyor</option>
                                        <option value="Müvekkil Onayı - Açıldı">Müvekkil Onayı - Açıldı</option>
                                        <option value="Müvekkil Onayı - Kapatıldı">Müvekkil Onayı - Kapatıldı</option>
                                        <option value="Müvekkil Cevaplamadı - Kapatıldı">Müvekkil Cevaplamadı - Kapatıldı</option>
                                        <option value="Kapalı">Kapalı</option>
                                    </select>
                                </div>
                                
                                <div class="form-group col-md-3 mb-0">
                                    <button class="btn btn-primary btn-sm btn-block" id="applyTaskFilters">Filtrele</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4" id="task-list-details" style="display: none;">
                    <div class="col-12" id="task-list-container">
                        </div>
                    <div class="col-12" id="taskPagination"></div>
                        </div>
                </div>
            </div>

            <div class="tab-pane fade" id="invoices">
                <h1 class="header-title">Faturalarım</h1>
                <p class="lead">Geçmiş ve ödenmemiş faturalarınızın listesi.</p>
                <div class="table-responsive mt-4">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fatura No</th>
                                <th>Tarih</th>
                                <th>Açıklama</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                                <th>Aksiyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>INV-2023-001</td>
                                <td>25.10.2023</td>
                                <td>Marka tescil başvuru hizmet bedeli</td>
                                <td>1.500 TL</td>
                                <td><span class="badge badge-warning">Ödenmemiş</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
                                    <button class="btn btn-success btn-sm btn-action"><i class="fas fa-lira-sign"></i> Öde</button>
                                </td>
                            </tr>
                            <tr>
                                <td>INV-2023-002</td>
                                <td>10.09.2023</td>
                                <td>Yıllık marka takip hizmeti</td>
                                <td>800 TL</td>
                                <td><span class="badge badge-success">Ödendi</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="reports">
                <h1 class="header-title">Raporlar</h1>
                <p class="lead">Portföyünüzle ilgili detaylı raporlara buradan ulaşabilirsiniz.</p>
                <div class="row mt-4">
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-chart-line mr-2"></i>Portföy Değerlendirme Raporu</h5>
                            <p class="text-muted">Portföyünüzdeki tüm varlıkların güncel durumunu ve gelecek süreçlerini içeren rapor.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-file-pdf mr-2"></i>Finansal Durum Raporu</h5>
                            <p class="text-muted">Ödenmiş ve bekleyen tüm tahakkuk ve faturalarınızın özeti.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4">
                        <div class="card p-4">
                            <h5 class="card-title text-info"><i class="fas fa-history mr-2"></i>İşlem Geçmişi Dökümü</h5>
                            <p class="text-muted">Tüm portföyünüzdeki tamamlanmış ve bekleyen işlemlerin detaylı listesi.</p>
                            <button class="btn btn-primary btn-sm mt-2"><i class="fas fa-download mr-1"></i>Raporu İndir</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="portfolioDetailModal" tabindex="-1" role="dialog" aria-labelledby="portfolioDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title header-title" id="portfolioDetailModalLabel">Marka Adı 1 Detayları</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Marka</div>
                        <div class="card-body text-center">
                            <img src="https://placehold.co/150x150/png" alt="Marka Örneği" style="max-width: 100%; height: auto; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Varlık Detayları</div>
                        <div class="card-body">
                            <p><strong>Tür:</strong> Marka</p>
                            <p><strong>Başvuru No:</strong> 2023/12345</p>
                            <p><strong>Tescil No:</strong> -</p>
                            <p><strong>Sınıf:</strong> 09, 35, 42</p>
                            <p><strong>Durum:</strong> <span class="badge badge-primary">Başvuru</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100">
                        <div class="card-header">Tarihler / Durum</div>
                        <div class="card-body">
                            <p><strong>Başvuru Tarihi:</strong> 25.10.2023</p>
                            <p><strong>Tescil Tarihi:</strong> -</p>
                            <p><strong>Yenileme Tarihi:</strong> -</p>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item"><a class="nav-link active" id="islemler-tab" data-toggle="tab" href="#modal-islemler" role="tab" aria-controls="modal-islemler" aria-selected="true">İşlemler</a></li>
              <li class="nav-item"><a class="nav-link" id="esya-tab" data-toggle="tab" href="#modal-esya" role="tab" aria-controls="modal-esya" aria-selected="false">Eşya Listesi</a></li>
              <li class="nav-item"><a class="nav-link" id="tahakkuklar-tab" data-toggle="tab" href="#modal-tahakkuklar" role="tab" aria-controls="modal-tahakkuklar" aria-selected="false">Tahakkuklar ve Faturalar</a></li>
              <li class="nav-item"><a class="nav-link" id="belgeler-tab" data-toggle="tab" href="#modal-belgeler" role="tab" aria-controls="modal-belgeler" aria-selected="false">Belgeler</a></li>
            </ul>
            <div class="tab-content tab-content-card mt-3">
              <div class="tab-pane fade" id="modal-islemler" role="tabpanel">
                <h5 class="header-title">İşlem Geçmişi</h5>
                <div class="table-responsive mt-3">
                    <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>İşlem Açıklaması</th>
                                        <th>Tarih</th>
                                        <th>Evrak</th>
                                    </tr>
                                </thead>
                        <tbody>
                            <tr class="accordion-header-row" data-toggle="collapse" data-target="#islem-1" aria-expanded="false" aria-controls="islem-1">
                                <td><i class="fas fa-chevron-down mr-2"></i>1</td>
                                <td>Marka Başvurusu Hazırlığı</td>
                                <td><span class="badge badge-success">Tamamlandı</span></td>
                                <td>15.01.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="islem-1">
                                        <table class="table mb-0 accordion-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>İşlem Açıklaması</th>
                                                    <th>Durum</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>1.1</td>
                                                    <td>Evrakların Toplanması</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>10.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                                <tr>
                                                    <td>1.2</td>
                                                    <td>Başvuru Formunun Doldurulması</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>12.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr class="accordion-header-row" data-toggle="collapse" data-target="#islem-2" aria-expanded="false" aria-controls="islem-2">
                                <td><i class="fas fa-chevron-down mr-2"></i>2</td>
                                <td>Marka Tescil Başvurusu</td>
                                <td><span class="badge badge-primary">Devam Ediyor</span></td>
                                <td>20.01.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="islem-2">
                                        <table class="table mb-0 accordion-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>İşlem Açıklaması</th>
                                                    <th>Durum</th>
                                                    <th>Tarih</th>
                                                    <th>Evrak</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>2.1</td>
                                                    <td>TÜRKPATENT'e Bildirim</td>
                                                    <td><span class="badge badge-success">Tamamlandı</span></td>
                                                    <td>21.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                                <tr>
                                                    <td>2.2</td>
                                                    <td>İnceleme Aşaması</td>
                                                    <td><span class="badge badge-primary">Beklemede</span></td>
                                                    <td>25.01.2023</td>
                                                    <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>

                            <tr class="accordion-header-row">
                                <td>3</td>
                                <td>Yenileme Hizmet Bedeli Tahakkuku</td>
                                <td><span class="badge badge-warning">Onay Bekliyor</span></td>
                                <td>10.03.2023</td>
                                <td><a href="#" class="btn btn-sm btn-info" target="_blank" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
              <div class="tab-pane fade" id="modal-esya" role="tabpanel">
                <h5 class="header-title">Mal ve Hizmet Sınıfları</h5>
                <div id="esyaListesiContent" class="mt-3">
                  <p class="text-muted">Yükleniyor...</p>
                </div>
              </div>
              <div class="tab-pane fade" id="modal-tahakkuklar" role="tabpanel">
                <h5 class="header-title">Tahakkuk ve Fatura Bilgileri</h5>
                <p>İlgili tahakkuklar ve faturalar burada listelenecektir.</p>
              </div>
              <div class="tab-pane fade" id="modal-belgeler" role="tabpanel">
                <h5 class="header-title">Dosya ve Belgeler</h5>
                <p>Bu kayda ait belgeler burada gösterilecektir.</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">Yeni İşlem Ekle</button>
          </div>
        </div>
      </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">

// --- Early globals to avoid TDZ/hoisting issues ---
window._ttCache = window._ttCache || { items: [], counts: {}, meta: {} };
const _ttCache = window._ttCache;

// taskPaginationData objesini doğru şekilde başlat
window.taskPaginationData = window.taskPaginationData || {
    allData: [],
    currentPage: 1,
    itemsPerPage: 10,
    pagination: null
};

window.fetchAndDisplayTasks = window.fetchAndDisplayTasks || (async function(){ /* will be defined below */ });
window.populateDashboardNumbers = window.populateDashboardNumbers || (function(){});

import { authService, db } from './firebase-config.js';
import { doc, getDoc, collection, getDocs, getDocsFromServer, query, where, updateDoc, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import PaginationModule from './js/pagination.js';

// Pagination'ı global yap
window.Pagination = PaginationModule;
const Pagination = PaginationModule;

// importların HEMEN ALTINA
window.authService = authService;
window.db = db;
window.doc = doc;
window.getDoc = getDoc;
window.collection = collection;
window.query = query;
window.where = where;
window.getDocs = getDocs;
window.updateDoc = updateDoc;
window.limit = limit;

// --- Dashboard sayaç kontrolü ---
// Destek varsa cache yerine sunucudan oku:
const runGetDocs = (typeof getDocsFromServer === 'function') ? getDocsFromServer : getDocs;
window.runGetDocs = runGetDocs;

// Sayfa ilk yüklenirken tüm sayaçları 0'a çek
function setDashboardZeros() {
  const map = {
    // Bu id'leri projendeki gerçek id'lerle eşleştir:
    '#dashPortfolio': 0,            // Toplam portföy
    '#dashPendingApprovals': 0,     // Onay bekleyen işlem
    '#dashUnpaidInvoices': 0        // Ödenmemiş fatura
  };
  Object.entries(map).forEach(([sel, val]) => {
    const el = document.querySelector(sel) || document.querySelector(`[data-dash-key="${sel.replace('#dash','').toLowerCase()}"]`);
    if (el) el.textContent = val;
  });
}

// Veriler tamamlanmadan gelen "erken" güncellemeleri yok saymak için
let DASH_LOADING = true;
function setDashboardLoading(v){ DASH_LOADING = !!v; }

// populateDashboardNumbers içinde güvenli yazım
function writeDashSafe(selector, value) {
  if (DASH_LOADING) return;  // erken çağrıları görmezden gel
  const el = document.querySelector(selector) || document.querySelector(`[data-dash-key="${selector.replace('#dash','').toLowerCase()}"]`);
  if (el) el.textContent = value;
}

// Kullanıcı bilgilerini üst çubuğa yerleştirme
function populateUserInfo() {
    const user = authService.getCurrentUser();
    if (user) {
        document.getElementById('userName').textContent = user.displayName || user.email;
        document.getElementById('userRole').textContent = (user.role ? user.role.toUpperCase() : 'CLIENT');
        document.getElementById('userAvatar').textContent = (user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase());
        document.getElementById('welcomeUserName').textContent = user.displayName || user.email;
    }
}

// Çıkış işlevi
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await authService.signOut();
});

// Tema yönetimi
function initTheme() {
    const themeSwitch = document.getElementById('themeSwitch');
    const body = document.body;
    const toggleLabel = document.querySelector('.theme-toggle .custom-control-label');
    const savedTheme = localStorage.getItem('theme') || 'dark';

    if (savedTheme === 'light') {
        body.classList.add('light-mode');
        themeSwitch.checked = false;
        toggleLabel.textContent = 'Beyaz Tema';
    } else {
        body.classList.add('dark-mode');
        themeSwitch.checked = true;
        toggleLabel.textContent = 'Koyu Tema';
    }

    themeSwitch.addEventListener('change', function () {
        if (this.checked) {
            body.classList.remove('light-mode');
            body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            toggleLabel.textContent = 'Koyu Tema';
        } else {
            body.classList.remove('dark-mode');
            body.classList.add('light-mode');
            localStorage.setItem('theme', 'light');
            toggleLabel.textContent = 'Beyaz Tema';
        }
    });
}

/**
 * Verilen HTML tablosunu, çekilen portföy verileriyle doldurur.
 * @param {string} tableId Doldurulacak tablonun ID'si (#marka-list, #patent-list vb.)
 * @param {Array<Object>} portfolioData Gösterilecek portföy verileri.
 */

function populatePortfolioTable(tableId, portfolioData, startIndex = 0) {
    const tableBody = document.querySelector(`${tableId} tbody`);
    if (!tableBody) return;
    tableBody.innerHTML = '';

    portfolioData.forEach((item, index) => {
        const actualIndex = startIndex + index; // Gerçek sıra numarası
        const mainRow = document.createElement('tr');

        const originRaw = (item.origin || 'TÜRKPATENT').toString().trim();
        const originUpper = originRaw.toUpperCase();

console.log('📍 Origin Debug:', item.title || 'İsimsiz', 'origin:', item.origin, 'raw:', originRaw, 'upper:', originUpper);

        const originBucket = (originUpper === 'TÜRKPATENT' || originUpper === 'TURKPATENT')
        ? 'TÜRKPATENT'
        : 'YURTDISI';

        // Parent-child ilişkisini transactionHierarchy'den belirle
        const isParent = item.transactionHierarchy === 'parent';
        const isChild = item.transactionHierarchy === 'child';
        
        // Child kayıtları hiç render etme
        if (isChild) {
            return; // Bu kayıt için hiçbir şey yapma, bir sonraki kayda geç
        }
        
        // Parent ise, child kayıtlarını bul (tüm listeden)
        let childRecords = [];
        if (isParent && window.markaPaginationData && window.markaPaginationData.allDataUnfiltered) {
            childRecords = window.markaPaginationData.allDataUnfiltered.filter(p => 
                p.parentId === item.id || 
                (p.transactionHierarchy === 'child' && p.title === item.title)
            );
        }
        
        const isInternational = isParent && childRecords.length > 0;
        
        mainRow.setAttribute('data-origin', originBucket);
        
        // Child kayıtları gizle (sadece parent'ın altında göstereceğiz)
        if (isChild) {
            mainRow.style.display = 'none';
            mainRow.setAttribute('data-is-child', 'true');
        }

        // Veritabanından gelen gerçek veri yapısına göre düzelt
        const title = item.title || item.brandText || 'İsimsiz';
        const appNumber = item.applicationNumber || item.applicationNo || '-';
        const statusText = item.status || item.statusText || 'Bilinmiyor';
        const classes = (() => {
            if (Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length) {
                try {
                    const arr = item.goodsAndServicesByClass
                        .map(c => parseInt(c.classNo,10))
                        .filter(n => !isNaN(n));
                    const uniq = Array.from(new Set(arr)).sort((a,b)=>a-b);
                    return uniq.join(', ');
                } catch(_) { /* fallthrough */ }
            }
            if (item.classes) {
                const norm = Array.isArray(item.classes) ? item.classes : String(item.classes).split(',');
                const uniq = Array.from(new Set(norm.map(x=>parseInt(String(x).trim(),10)).filter(n=>!isNaN(n)))).sort((a,b)=>a-b);
                return uniq.length ? uniq.join(', ') : '-';
            }
            return '-';
        })();
        const applicationDate = (() => {
            const rawDate = item.applicationDate || item.application_date || '';
            if (!rawDate || rawDate === '-') return '-';
            
            try {
                // Tarihi parse et (YYYY-MM-DD formatından)
                const date = new Date(rawDate);
                if (isNaN(date.getTime())) return rawDate; // Geçersiz tarihse orijinalini döndür
                
                // dd/mm/yyyy formatına çevir
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (error) {
                return rawDate; // Hata durumunda orijinal değeri döndür
            }
        })();
        // Menşe hesaplama
        const originDisplay = (() => {
            if (originBucket === 'TÜRKPATENT') {
                return 'TÜRKPATENT';
            } else if (item.origin === 'Yurtdışı Ulusal') {
                const countryCode = item.country || '';
                return window.countriesMap && window.countriesMap[countryCode] 
                    ? window.countriesMap[countryCode] 
                    : countryCode;
            } else {
                return item.origin || 'Bilinmiyor';
            }
        })();
        const badgeClass = {
            'Başvuru': 'primary',
            'application_filed': 'primary', 
            'Tescilli': 'success',
            'registered': 'success',
            'İtiraz': 'warning',
            'objection': 'warning',
            'Reddedildi': 'danger',
            'rejected': 'danger'
        }[statusText] || 'secondary';

        const brandImg = item.brandImageUrl || item.brandImage || '';
        const imgHtml = brandImg ? `<img src="${brandImg}" alt="marka" class="brand-thumb" style="height:128px !important;width:auto;border-radius:6px;object-fit:contain;"/>` : '-';
        const regNumber = item.registrationNumber || item.registrationNo || '-';
        
        const rowHtml = `
        <td class="col-index">${isInternational ? `<i class="fas fa-chevron-right mr-2"></i>` : ''}${actualIndex + 1}</td>
        <td class="col-origin">${originDisplay}</td>
        <td class="col-sample">${imgHtml}</td>
        <td class="col-brand"><a href="#" class="portfolio-detail-link" data-item-id="${item.id}" data-toggle="modal" data-target="#portfolioDetailModal">${title}</a></td>
        <td class="col-appno">${appNumber}</td>
        <td class="col-regno">${regNumber}</td>
        <td class="col-appdate">${applicationDate}</td>
        <td class="col-status"><span class="badge badge-${badgeClass}">${statusText}</span></td>
        <td class="col-classes">${classes}</td>
        `;

        mainRow.innerHTML = rowHtml;

        if (isInternational) {
        mainRow.classList.add('accordion-header-row');
        mainRow.setAttribute('data-toggle', 'collapse');
        mainRow.setAttribute('data-target', `#accordion-yurtdisi-${item.id}`);
        mainRow.setAttribute('aria-expanded', 'false');
        mainRow.setAttribute('aria-controls', `accordion-yurtdisi-${item.id}`);
        }

        tableBody.appendChild(mainRow);
        
        if (isInternational && childRecords.length > 0) {
            const detailRow = document.createElement('tr');
            detailRow.setAttribute('data-origin', originBucket);
            detailRow.innerHTML = `
                <td colspan="9" class="p-0">
                    <div class="collapse" id="accordion-yurtdisi-${item.id}">
                        <table class="table mb-0 accordion-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Menşe</th>
                                    <th>Başvuru No</th>
                                    <th>Tescil No</th>
                                    <th>Başvuru Tarihi</th>
                                    <th>Durum</th>
                                    <th>Sınıflar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${childRecords.map((subItem, subIndex) => {
                                    const subClasses = (() => {
                                        if (Array.isArray(subItem.goodsAndServicesByClass) && subItem.goodsAndServicesByClass.length) {
                                            const arr = subItem.goodsAndServicesByClass.map(c => parseInt(c.classNo,10)).filter(n => !isNaN(n));
                                            return Array.from(new Set(arr)).sort((a,b)=>a-b).join(', ');
                                        }
                                        return '-';
                                    })();
                                    
                                    const subAppDate = (() => {
                                        const rawDate = subItem.applicationDate || '';
                                        if (!rawDate || rawDate === '-') return '-';
                                        try {
                                            const date = new Date(rawDate);
                                            if (isNaN(date.getTime())) return rawDate;
                                            const day = String(date.getDate()).padStart(2, '0');
                                            const month = String(date.getMonth() + 1).padStart(2, '0');
                                            const year = date.getFullYear();
                                            return `${day}/${month}/${year}`;
                                        } catch (error) {
                                            return rawDate;
                                        }
                                    })();
                                    
                                    const subStatus = subItem.status || 'Bilinmiyor';
                                    const subBadgeClass = {
                                        'Başvuru': 'primary',
                                        'application_filed': 'primary', 
                                        'Tescilli': 'success',
                                        'registered': 'success',
                                        'İtiraz': 'warning',
                                        'objection': 'warning',
                                        'Reddedildi': 'danger',
                                        'rejected': 'danger'
                                    }[subStatus] || 'secondary';
                                    
                                    const childOrigin = window.countriesMap && window.countriesMap[subItem.country] 
                                        ? window.countriesMap[subItem.country] 
                                        : (subItem.country || 'Bilinmiyor');
                                    
                                    const subRegNo = subItem.registrationNumber || subItem.registrationNo || '-';                                  
                                    return `
                                        <tr>
                                            <td>${actualIndex + 1}.${subIndex + 1}</td>
                                            <td>${childOrigin}</td>
                                            <td>${subItem.applicationNumber || '-'}</td>
                                            <td>${subRegNo}</td>
                                            <td>${subAppDate}</td>
                                            <td><span class="badge badge-${subBadgeClass}">${subStatus}</span></td>
                                            <td>${subClasses}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            tableBody.appendChild(detailRow);
        }
    });
}

/**
 * Kullanıcı kimliğine göre portföy verilerini çeker ve tabloyu doldurur.
 */
async function fetchAndDisplayPortfolio() {
    const user = authService.getCurrentUser();
    const userId = user ? user.uid : null;
    
    if (!userId) {
        console.log("Kullanıcı giriş yapmamış veya UID alınamadı.");
        return;
    }
    
    if (!db) {
        console.error("Firestore başlatılamadı. firebase-config.js içindeki getFirestore kurulumunu kontrol edin.");
        return;
    }


    try {
        // 1. Kullanıcının kendi belgesini UID'si ile çekme
        const userDocRef = doc(db, "users", userId);
        const userSnapshot = await getDoc(userDocRef);

        if (!userSnapshot.exists()) {
            console.log("Kullanıcıya ait veri bulunamadı.");
            return;
        }

        const userData = userSnapshot.data();
        const linkedPersonIds = userData.linkedPersonIds;
        
        // Diğer fonksiyonların erişebilmesi için global sakla
        window.__linkedPersonIds = Array.isArray(linkedPersonIds) ? linkedPersonIds : [];

        if (!linkedPersonIds || linkedPersonIds.length === 0) {
            console.log("Kullanıcı ile ilişkili müvekkil bulunamadı.");
            return;
        }
        // Ülke verilerini çek
        const countriesDoc = await getDoc(doc(db, "common", "countries"));
        if (countriesDoc.exists()) {
            const countriesData = countriesDoc.data();
            // Array'i map'e çevir: {code: name}
            window.countriesMap = {};
            if (countriesData.list && Array.isArray(countriesData.list)) {
                countriesData.list.forEach(country => {
                    if (country.code && country.name) {
                        window.countriesMap[country.code] = country.name;
                    }
                });
            }
            console.log('✅ Ülkeler yüklendi:', Object.keys(window.countriesMap).length, 'ülke');
        } else {
            window.countriesMap = {};
            console.warn('⚠️ Ülke verileri bulunamadı');
        }
        // 2. İlgili müvekkillere ait tüm portföy verilerini çekme
        const portfolioRef = collection(db, "ipRecords");
        let allPortfolios = [];

        console.log("Portföy verilerini çekme başladı...", {
            linkedPersonIds,
            linkedPersonCount: linkedPersonIds.length
        });
        setDashboardLoading(true);
        setDashboardZeros();

        // Strateji 1: personsRelatedIds ile hızlı query dene (muhtemelen boş dönecek)
        try {
            const q1 = query(
                portfolioRef,
                where("personsRelatedIds", "array-contains-any", linkedPersonIds)
            );
            const snap1 = await runGetDocs(q1);
            snap1.forEach(doc => {
                allPortfolios.push({ id: doc.id, ...doc.data() });
            });
            
            console.log("✅ personsRelatedIds ile bulunan:", allPortfolios.length);
        } catch (error) {
            console.warn("❌ personsRelatedIds query hatası:", error.message);
        }

        // Ana strateji: applicants array'i ile client-side filtering
        console.log("🔄 Applicants array'i ile filtreleme başlatılıyor...");

        const allIpQuery = query(collection(db, "ipRecords"));
        const allIpSnap = await runGetDocs(allIpQuery);

        console.log(`📥 Toplam ${allIpSnap.size} ipRecord çekildi, filtreleme başlıyor...`);

        allIpSnap.forEach(doc => {
            const data = doc.data();
            
            // applicants array'ini kontrol et
            if (data.applicants && Array.isArray(data.applicants)) {
                const hasMatch = data.applicants.some(applicant => {
                    // applicant objesinin id'sini linkedPersonIds ile karşılaştır
                    return applicant && applicant.id && linkedPersonIds.includes(applicant.id);
                });
                
                if (hasMatch) {
                    allPortfolios.push({ id: doc.id, ...data });
                }
            }
        });

        console.log("📊 Final portföy istatistikleri:", {
            totalFound: allPortfolios.length,
            sampleTitles: allPortfolios.slice(0, 3).map(p => p.title || p.brandText || 'İsimsiz')
        });

        // Duplicate temizleme
        const seen = new Set();
        allPortfolios = allPortfolios.filter(p => {
            if (seen.has(p.id)) return false;
            seen.add(p.id);
            return true;
        });

        console.log("✅ Temizleme sonrası final:", allPortfolios.length);

        // 3. Doğru type değerleri ile filtreleme (veritabanında İngilizce değerler kullanılıyor)
        const markaList = allPortfolios.filter(p => 
            p.type === 'trademark' || p.type === 'Marka' || p.type === 'marka'
        );
        const patentList = allPortfolios.filter(p => 
            p.type === 'patent' || p.type === 'Patent'
        );
        const tasarimList = allPortfolios.filter(p => 
            p.type === 'design' || p.type === 'Tasarım' || p.type === 'tasarim'
        );
        const davaIItirazList = allPortfolios.filter(p => 
            p.type === 'litigation' || p.type === 'objection' || 
            p.type === 'Dava/İtiraz' || p.type === 'dava' || p.type === 'itiraz'
        );

        console.log("✅ Kategori dağılımı:", {
            marka: markaList.length,
            patent: patentList.length,
            tasarim: tasarimList.length,
            davaItiraz: davaIItirazList.length
        });

        // 4. Her bir sekmeyi kendi verisiyle doldurma
        console.log('🔍 Marka listesi origin dağılımı:', markaList.map(m => ({
            title: m.title || 'İsimsiz',
            origin: m.origin
        })).slice(0, 10));

        const __markaData = Array.isArray(markaList) ? markaList : [];

        // İlk önce tüm veriyi global olarak sakla
        window.markaPaginationData = window.markaPaginationData || {};
        window.markaPaginationData.allDataUnfiltered = __markaData;
        window.markaPaginationData.allData = __markaData;
        window.markaPaginationData.currentPage = 1;
        window.markaPaginationData.itemsPerPage = 10;

// Global data storage
        window.markaPaginationData = {
            allDataUnfiltered: __markaData,
            allData: __markaData,
            pagination: null
        };
        
        const __markaPag = new Pagination({
        itemsPerPage: 10,
        containerId: 'markaPagination',
        onPageChange: (page, perPage) => {
            const start = (page - 1) * perPage;
            const end   = start + perPage;
            const slice = window.markaPaginationData.allData.slice(start, end);
            populatePortfolioTable('#marka-list', slice, start);
            
            // Menşe kolonu görünürlüğü
            const currentFilter = $("#menseFilter").val() || 'TÜRKPATENT';
            if (currentFilter === 'TÜRKPATENT') {
                $("#marka-list th.col-origin, #marka-list td.col-origin").hide();
            } else {
                $("#marka-list th.col-origin, #marka-list td.col-origin").show();
            }
        }
        });
        
        window.markaPaginationData.pagination = __markaPag;
        
        // İlk yükleme - default TÜRKPATENT filtresi
        const filteredData = __markaData.filter(item => {
            var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
            return orig === 'TÜRKPATENT' || orig === 'TURKPATENT' || orig === '';
        });
        
        window.markaPaginationData.allData = filteredData;
        __markaPag.update(filteredData.length);
        populatePortfolioTable('#marka-list', filteredData.slice(0, 10), 0);
        
        // Menşe kolonunu gizle (varsayılan TÜRKPATENT)
        setTimeout(() => {
            $("#marka-list th.col-origin, #marka-list td.col-origin").hide();
        }, 100);

        populatePortfolioTable('#patent-list', patentList);
        populatePortfolioTable('#tasarim-list', tasarimList);
        populatePortfolioTable('#dava-itiraz-list', davaIItirazList);
        setDashboardLoading(false);

        // Dashboard sayaçlarını doldur
        await populateDashboardNumbers(linkedPersonIds, allPortfolios);

        // İşlerim sekmesini doldur
        await fetchAndDisplayTasks(linkedPersonIds);

        // Faturalarım sekmesini doldur
        await window.fetchAndDisplayInvoices(linkedPersonIds);

    } catch (error) {
        console.error("Portföy verileri çekilirken bir hata oluştu:", error);
    }
}

window.populateDashboardNumbers = async function (linkedPersonIds, allPortfolios){
    const portfolioCount = allPortfolios.length;

    // Firestore'daki gerçek değer: awaiting_client_approval
    const taskQ = query(
      collection(db, "tasks"),
      where("personsRelatedIds", "array-contains-any", linkedPersonIds),
      where("status","==","awaiting_client_approval")
    );
    const taskSnap = await runGetDocs(taskQ);
    const pendingTasks = taskSnap.size;

    const accrualQ = query(
      collection(db, "accruals"),
      where("personsRelatedIds", "array-contains-any", linkedPersonIds),
      where("isPaid","==", false)
    );
    const accrualSnap = await runGetDocs(accrualQ);
    const unpaidInvoices = accrualSnap.size;

    writeDashSafe('#dashPortfolio',        portfolioCount);
    writeDashSafe('#dashPendingApprovals', pendingTasks);
    writeDashSafe('#dashUnpaidInvoices',   unpaidInvoices);
}

// (DOMContentLoaded'dan ÖNCE)
window.fetchAndDisplayInvoices = async function (linkedPersonIds) {
  try {
    if (!Array.isArray(linkedPersonIds) || linkedPersonIds.length === 0) {
      console.warn('Fatura: linkedPersonIds boş, sorgu atlanıyor.');
      return;
    }

    const table = document.querySelector('#invoices table');
    if (!table) {
      console.warn('#invoices tablosu henüz DOM’da değil. Çağrı daha sonra tekrar denenecek.');
      return;
    }

    const tableBody = table.querySelector('tbody') || table.createTBody();
    tableBody.innerHTML = '';

    // Firestore sorgusu
    const q = query(
      collection(db, 'accruals'),
      where('personsRelatedIds', 'array-contains-any', linkedPersonIds)
    );
    const snap = await runGetDocs(q);

    snap.forEach((d) => {
      const a = d.data();
      const statusBadge = a.isPaid
        ? `<span class="badge badge-success">Ödendi</span>`
        : `<span class="badge badge-warning">Ödenmemiş</span>`;

      const actions = a.isPaid
        ? `<button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>`
        : `<button class="btn btn-primary btn-sm btn-action"><i class="fas fa-download"></i> İndir</button>
           <button class="btn btn-success btn-sm btn-action"><i class="fas fa-lira-sign"></i> Öde</button>`;

      tableBody.insertAdjacentHTML(
        'beforeend',
        `
        <tr>
          <td>${a.invoiceNo || '-'}</td>
          <td>${a.date || '-'}</td>
          <td>${a.description || '-'}</td>
          <td>${a.amount || '-'}</td>
          <td>${statusBadge}</td>
          <td>${actions}</td>
        </tr>
        `
      );
    });
  } catch (err) {
    console.error('Faturalar çekilirken hata:', err);
  }
};

// Sayfa yüklendiğinde tüm fonksiyonları başlat
document.addEventListener('DOMContentLoaded', function () {
    initTheme();
    populateUserInfo();
    fetchAndDisplayPortfolio();

// --- Sidebar tab click kontrolü ---
    const $ = window.jQuery; // bootstrap.bundle yüklü; jQuery globalde mevcut
    if ($) {
        // Sidebar içindeki tab linklerine tıklandığında sadece biri aktif kalsın
        $('#sidebar a[data-toggle="tab"]').on('show.bs.tab', function (e) {
            $('#sidebar .nav-link').removeClass('active');
            $(e.target).addClass('active');
        });
        
        // Portföy tab'ına her tıklandığında veriyi yenile
        $('#sidebar a[href="#portfolio-content"]').on('shown.bs.tab', function (e) {
            setTimeout(() => {
                // Marka tab'ını aktif yap
                $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                
                // Filtreyi uygula
                if (typeof window.applyMenseFilterToActivePane === 'function') {
                    window.applyMenseFilterToActivePane();
                }
                
                // Pagination'ı yenile
                if (window.markaPaginationData && window.markaPaginationData.allData.length > 0) {
                    if (window.renderMarkaPagination) {
                        window.renderMarkaPagination();
                    }
                }
            }, 100);
        });
    }
});

// Diğer tüm scriptler
(function(){

function getRowOrigin($row){
  // populate sırasında data-origin zaten kovaya çevrildi: 'TÜRKPATENT' | 'YURTDISI'
  var v = ($row.attr('data-origin') || '').toString().toUpperCase().trim();
  if (v === 'TÜRKPATENT' || v === 'TURKPATENT') return 'TÜRKPATENT';
  // Boş veya farklı her değer yabancı muamelesi görsün
  return 'YURTDISI';
}

  function toggleWipoGroup($headerRow, show){
    var $detailRow = $headerRow.next('tr');
    if(show){
      $headerRow.show();
      $detailRow.show();
    }else{
      var collapseId = $headerRow.attr('data-target');
      if(collapseId){ try { $(collapseId).collapse('hide'); } catch(e){} }
      $headerRow.hide();
      $detailRow.hide();
    }
  }

function filterPaneByMense(paneSelector, menseValue){
    var $tbody = $(paneSelector + " tbody");
    if($tbody.length === 0) return;
    var $rows = $tbody.children("tr");

    var isTR = (menseValue === 'TÜRKPATENT');
    var isYD = (menseValue === 'YURTDISI');
    var isALL = (menseValue === 'HEPSI');

    console.log('=== FILTER BAŞLADI ===');
    console.log('Seçilen menşe:', menseValue);
    console.log('Toplam satır sayısı:', $rows.length);

    $rows.each(function(){
        var $tr = $(this);
        var dataOriginAttr = $tr.attr('data-origin');
        var rowOrigin = getRowOrigin($tr);
        
        console.log('Satır:', {
            text: $tr.find('td:eq(2)').text().substring(0, 30),
            dataOriginAttr: dataOriginAttr,
            rowOrigin: rowOrigin,
            hasAccordionClass: $tr.hasClass('accordion-header-row')
        });

        // Basit mantık: TÜRKPATENT ise true, değilse false
        var isTurkpatent = (rowOrigin === 'TÜRKPATENT');
        var isYurtdisi = (rowOrigin && rowOrigin !== 'TÜRKPATENT');
    


        if($tr.hasClass('accordion-header-row')){
            // Akordeon Başlıklarını Yönet
            if (isALL) {
                toggleWipoGroup($tr, true);
            } else if (isTR) {
                toggleWipoGroup($tr, isTurkpatent);
            } else if (isYD) {
                toggleWipoGroup($tr, isYurtdisi);
            }
        } else {
            // Normal Satırları Yönet
            if (isALL) {
                $tr.show();
            } else if (isTR) {
                if (isTurkpatent) {
                    $tr.show();
                } else {
                    $tr.hide();
                }
            } else if (isYD) {
                if (isYurtdisi) {
                    $tr.show();
                } else {
                    $tr.hide();
                }
            }
        }
    });
        // Menşe kolonunu göster/gizle
    var $originHeaders = $(paneSelector + " th.col-origin");
    var $originCells = $(paneSelector + " td.col-origin");
    
    if (isTR) {
        $originHeaders.hide();
        $originCells.hide();
    } else {
        $originHeaders.show();
        $originCells.show();
    }
}

window.applyMenseFilterToActivePane = function(){
    var val = $("#menseFilter").val() || 'TÜRKPATENT';
    
    // Doğrudan portfolio-content içindeki aktif tab'ı bul
    var $portfolioContent = $("#portfolio-content");
    if (!$portfolioContent.hasClass('show') || !$portfolioContent.hasClass('active')) {
        return; // Portfolio sekmesi aktif değilse çık
    }
    
    // Aktif olan Portföy alt sekmesini bul (marka-list, patent-list vb.)
    var $activePortfolioTab = $('#portfolioTopTabs a.nav-link.active').attr('href');
    var activeTabId = $activePortfolioTab ? $activePortfolioTab.substring(1) : 'marka-list';
    
    // Önce DOM filtrelemesini uygula (Her zaman)
    filterPaneByMense("#" + activeTabId, val);
    
    // Eğer marka listesindeyse ve pagination aktifse, veriyi yeniden filtrele ve pagination'ı güncelle
    if (activeTabId === 'marka-list' && window.markaPaginationData && window.markaPaginationData.allDataUnfiltered) {
        var allData = window.markaPaginationData.allDataUnfiltered;
        var filteredData;
        
        if (val === 'HEPSI') {
            filteredData = allData.filter(item => item.transactionHierarchy !== 'child');
        } else if (val === 'TÜRKPATENT') {
            filteredData = allData.filter(item => {
                if (item.transactionHierarchy === 'child') return false; // Child kayıtları atla
                var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
                return orig === 'TÜRKPATENT' || orig === 'TURKPATENT' || orig === '';
            });
        } else if (val === 'YURTDISI') {
            filteredData = allData.filter(item => {
                if (item.transactionHierarchy === 'child') return false; // Child kayıtları atla
                var orig = (item.origin || 'TÜRKPATENT').toString().toUpperCase().trim();
                return orig !== 'TÜRKPATENT' && orig !== 'TURKPATENT' && orig !== '';
            });
            console.log('✅ Yurtdışı filtreleme sonucu:', filteredData.length, 'kayıt bulundu');
        }
        
        window.markaPaginationData.allData = filteredData;
        
        // Pagination nesnesini güncelle
        if (window.markaPaginationData.pagination) {
            window.markaPaginationData.pagination.update(filteredData.length);
            
            // İlk sayfayı göster
            var firstPage = filteredData.slice(0, 10);
            populatePortfolioTable('#marka-list', firstPage, 0);
            
            // Menşe kolonu görünürlüğü
            if (val === 'TÜRKPATENT') {
                $("#marka-list th.col-origin, #marka-list td.col-origin").hide();
            } else {
                $("#marka-list th.col-origin, #marka-list td.col-origin").show();
            }
        }
    }
};
// --- Olay Yöneticileri (Bu kısım zaten doğruydu, sadece bağlam için ekledim) ---

$(document).on('change', '#menseFilter', function(){
    applyMenseFilterToActivePane();
});

$(document).on('shown.bs.tab', '#portfolioTopTabs a[data-toggle="tab"]', function (e) {
    applyMenseFilterToActivePane();
});

$(function(){
    // Sayfa yüklendiğinde varsayılan filtreyi uygula
    applyMenseFilterToActivePane();
});

// Client Portal menü aktif durumu yönetimi
$(document).ready(function() {
    // Ana menü linklerine click event ekle (İşlerim, Faturalarım, Raporlar)
    $('.nav-link[data-toggle="tab"]:not(#portfoy-accordion .nav-link)').on('click', function() {
        // Tüm ana menü nav-link'lerden active sınıfını kaldır
        $('.sidebar .nav-link').removeClass('active');
        // Tıklanan linke active sınıfını ekle
        $(this).addClass('active');
    });
    
    // Portföyüm dropdown için özel yönetim
    $('a[data-target="#portfoy-accordion"]').on('click', function() {
        // Tüm ana menü nav-link'lerden active sınıfını kaldır
        $('.sidebar .nav-link').removeClass('active');
        // Portföyüm linkine active sınıfını ekle
        $(this).addClass('active');
        
        // Portfolio content'i göster
        $('.tab-pane').removeClass('show active');
        $('#portfolio-content').addClass('show active');
        
        // İlk tab'ı (Marka) aktif yap
        setTimeout(() => {
            $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
        }, 100);
        
        // Menşe filtresi uygula
        if (typeof applyMenseFilterToActivePane === 'function') {
          try { applyMenseFilterToActivePane(); } catch(_) {}
        }
    });
    
    // Portföy alt menüsü linklerine tıklandığında
    $('#portfoy-accordion a[data-toggle="tab"]').on('click', function() {
        // Ana portföyüm linkinin active durumunu koru
        $('a[data-target="#portfoy-accordion"]').addClass('active');
    });

    // Dashboard'daki kartlara tıklama işlevselliği ekleme
    $('[data-target-tab]').on('click', function() {
        const targetTabId = $(this).data('target-tab');

        // 1. Sidebar'daki ilgili linki bul ve içeriği göster
        const $targetLink = $(`a[href="#${targetTabId}"]`); // #sidebar ihtiyacı yok, href'e göre bulması yeterli

        if ($targetLink.length) {
            $targetLink.tab('show');

            // 2. Tıkladıktan sonra sidebar'daki aktiflik durumunu güncelle
            $('#sidebar .nav-link').removeClass('active');
            
            // Eğer Portföyüm ise portföy linkini, değilse direkt kartın hedefini aktif yap
            if (targetTabId === 'portfolio-content') {
                $('a[data-target="#portfoy-accordion"]').addClass('active');
            } else {
                $targetLink.addClass('active');
            }
            
            // Portföyüm sekmesine gidiliyorsa, içindeki Marka tab'ını da aktif et
            if (targetTabId === 'portfolio-content') {
                 // İlk tab'ı (Marka) aktif yap
                setTimeout(() => {
                    $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                }, 100);
            }
        }
    });
});

// Türkçe karakter normalize
function _normalizeTr(s){
  if(!s) return '';
  return String(s)
    .toLowerCase()
    .replaceAll('ı','i').replaceAll('ğ','g').replaceAll('ü','u')
    .replaceAll('ş','s').replaceAll('ö','o').replaceAll('ç','c');
}

// transactionTypes meta cache'i (zaten varsa tekrar tanımlama)
const __ttMeta = (window._ttMetaCache = window._ttMetaCache || new Map());
window._getTransactionTypeMeta = async function(typeId){
  if(!typeId) return null;
  const key = String(typeId);
  if(__ttMeta.has(key)) return __ttMeta.get(key);
  try{
    const snap = await getDoc(doc(db,'transactionTypes', key));
    const meta = snap.exists() ? (snap.data()||{}) : null;
    __ttMeta.set(key, meta);
    return meta;
  }catch(_){ return null; }
}

// Task başlığını/etiketlerini tek stringte topla
window._taskLabelGuess = function(t, meta){
  const pieces = [
    meta?.alias, meta?.name,
    t.subType, t.taskSubType, t.category,
    t.details?.category, t.details?.type,
    Array.isArray(t.tags) ? t.tags.join(' ') : '',
    t.title, t.description
  ].filter(Boolean);
  return _normalizeTr(pieces.join(' '));
}
window.RX_BULTEN = /(bulten|izleme|watch|yayin|yayim|yayima|yayıma|gazete)/;

window.fetchAndDisplayTasks = async function(){
  try{
    const user = authService.getCurrentUser();
    if (!user) return;
    
    const userDocRef = doc(db, "users", user.uid);
    const userSnapshot = await getDoc(userDocRef);
    
    if (!userSnapshot.exists()) return;
    
    const linkedPersonIds = userSnapshot.data().linkedPersonIds || [];
    
    if (linkedPersonIds.length === 0) return;
    
    // Sadece onay bekleyenleri çek
    const q = query(
      collection(db,'tasks'),
      where('status','==','awaiting_client_approval')
    );
    const snap = await runGetDocs(q);

    const awaitingTasks = [];
    snap.forEach(d => {
      const taskData = d.data();
      const relatedPartyId = taskData.details?.relatedParty?.id;
      
      // Müvekkil ile eşleşme kontrolü
      if (relatedPartyId && linkedPersonIds.includes(relatedPartyId)) {
        awaitingTasks.push({ id:d.id, ...taskData });
      }
    });
    
    window.__allClientTasks = awaitingTasks; // listelemede kullanılıyor

    let countPending   = 0; // Sadece yenileme ve bülten olmayanlar
    let countRenewal   = 0;
    let countBulletin  = 0;

    for(const t of awaitingTasks){
      const meta  = await _getTransactionTypeMeta(t.taskType);
      const label = _taskLabelGuess(t, meta);

      const isRenewal = /yenileme/.test(label);
      const isBulletin = RX_BULTEN.test(label);

      if (isRenewal) {
        countRenewal++;
      } else if (isBulletin) {
        countBulletin++;
      } else {
        countPending++; // Ne yenileme ne de bülten olanlar
      }
    }

    $('#taskCount-pending-approval').text(countPending);
    $('#taskCount-renewal-approval').text(countRenewal);
    $('#taskCount-bulletin-watch').text(countBulletin);
    $('#taskCount-marka-total').text(countPending + countRenewal + countBulletin);
  }catch(err){
    console.error('Tasks sayaclari doldurulurken hata:', err);
  }
};

// ============================================
// YENİ EKLEME: renderTaskPage fonksiyonu
// ============================================
window.renderTaskPage = function(page, perPage) {
    console.log('🎨 renderTaskPage çağrıldı - Sayfa:', page, 'PerPage:', perPage);
    
    const container = document.getElementById('task-list-container');
    if (!container) {
        console.error('❌ task-list-container bulunamadı!');
        return;
    }
    
    const allData = window.taskPaginationData.allData || [];
    console.log('📊 Render edilecek veri sayısı:', allData.length);
    
    const startIndex = (page - 1) * perPage;
    const tasksToRender = allData.slice(startIndex, startIndex + perPage);

    container.innerHTML = '';

    const taskListDetails = document.getElementById('task-list-details');
    const taskType = taskListDetails ? taskListDetails.dataset.currentType : '';
    const isCompletedView = (taskType === 'completed-tasks');
    
    Promise.all(tasksToRender.map(async (task, index) => {
        const taskId = task.id;
        const taskNumber = startIndex + index + 1; 
        
        let transactionAlias = 'İşlem';
        if (task.taskType) {
            try {
                const transactionDoc = await getDoc(doc(db, 'transactionTypes', String(task.taskType)));
                if (transactionDoc.exists()) {
                    transactionAlias = (transactionDoc.data().alias || transactionDoc.data().name || 'İşlem').toLocaleUpperCase('tr-TR');
                }
            } catch (e) { }
        }

        let taskTitle = transactionAlias;
        if (task.relatedIpRecordId) {
            try {
                const ipDoc = await getDoc(doc(db, 'ipRecords', task.relatedIpRecordId));
                if (ipDoc.exists()) {
                    const ipData = ipDoc.data();
                    const appNo = ipData.applicationNumber || ipData.applicationNo || '-';
                    const brandText = ipData.brandText || ipData.title || '-';
                    taskTitle = `${transactionAlias} - ${appNo} - ${brandText}`;
                }
            } catch (e) { }
        }

        const card = document.createElement('div');
        card.className = 'col-md-12 mb-4';

        const statusBadgeClass = {
            'open': 'primary', 'in_progress': 'info', 'completed': 'success', 'closed': 'secondary',
            'awaiting_client_approval': 'warning', 'müvekkil onayı - kapatıldı': 'danger'
        }[task.status] || 'secondary';
        
        const statusText = {
            'open': 'Açık', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'closed': 'Kapalı',
            'awaiting_client_approval': 'Onay Bekliyor', 'müvekkil onayı - kapatıldı': 'Reddedildi/Kapandı'
        }[task.status] || task.status;
        
        let assignedTo = '-'; 
        let actionButtons;
        
        if (isCompletedView) {
            actionButtons = `
                <button class="btn btn-info btn-sm btn-action task-detail" data-task-id="${taskId}"> <i class="fas fa-eye"></i> İncele </button>
                <button class="btn btn-success btn-sm btn-action task-reopen" data-task-id="${taskId}"> <i class="fas fa-folder-open"></i> İşi Aç </button>
            `;
        } else {
             actionButtons = `
                <button class="btn btn-success btn-sm btn-action task-approve" data-task-id="${taskId}"> <i class="fas fa-check"></i> Onayla </button>
                <button class="btn btn-danger btn-sm btn-action task-reject" data-task-id="${taskId}"> <i class="fas fa-times"></i> Reddet </button>
                <button class="btn btn-info btn-sm btn-action task-detail" data-task-id="${taskId}"> <i class="fas fa-eye"></i> İncele </button>
            `;
        }
        
        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            try {
                const date = new Date(timestamp);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return '-';
            }
        };
        
        const due = task.dueDate || task.officialDueDate || task.clientDueDate || task.deadline || null;
        
        if (isCompletedView) {
            card.innerHTML = `
                <div class="task-card task-card-success" data-task-id="${taskId}">
                    <div class="task-number-tag">${taskNumber}.</div> 
                    <h5 class="task-title">#${taskId} - ${taskTitle}</h5>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="task-meta">
                            <span class="badge badge-${statusBadgeClass}">${statusText}</span>
                            <span class="ml-2"><i class="fas fa-user"></i> ${assignedTo}</span>
                        </small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="task-meta">
                            <i class="fas fa-clock mr-1"></i>
                            Oluşturma Tarihi: ${formatDate(task.createdAt)}
                        </small>
                        <div>${actionButtons}</div>
                    </div>
                </div>`;
        } else {
            card.innerHTML = `
                <div class="task-card task-card-warning" data-task-id="${taskId}">
                    <div class="task-number-tag">${taskNumber}.</div> 
                    <h5 class="task-title">#${taskId} - ${taskTitle}</h5>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="task-meta">
                            <span class="badge badge-${statusBadgeClass}">${statusText}</span>
                        </small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="task-meta">
                            <i class="fas fa-clock mr-1"></i>
                            Son Onay Tarihi: ${formatDate(due)}
                        </small>
                        <div>${actionButtons}</div>
                    </div>
                </div>`;
        } 

        return card;
    })).then(taskCards => {
        taskCards.forEach(card => container.appendChild(card));
        
        $('html, body').animate({
            scrollTop: $('#task-list-details').offset().top - 100 
        }, 300);
    }).catch(err => {
        console.error("Task render hatası:", err);
        container.innerHTML = '<p class="lead text-danger text-center mt-5">Görevler oluşturulurken hata oluştu.</p>';
    });
};


// Modal açıldığında verileri set et
$(document).on('show.bs.modal', '#portfolioDetailModal', async function (e) {
    // Ana sayfanın mevcut durumunu kaydet
    window._savedPortfolioState = {
        activeTab: $('.content > .tab-content > .tab-pane.show.active').attr('id'),
        sidebarActive: $('#sidebar .nav-link.active').attr('href')
    };
    
    const triggerLink = $(e.relatedTarget);
    const itemId = triggerLink.data('item-id');
    
    if (!itemId) return;
    
    // Tüm verilerden ilgili kaydı bul
    const allData = window.markaPaginationData?.allDataUnfiltered || [];
    const item = allData.find(p => p.id === itemId);
    
    if (!item) return;
    
    // Modal başlığını set et
    $('#portfolioDetailModalLabel').text((item.title || item.brandText || 'Detaylar'));
    
    // Marka görseli
    const brandImg = item.brandImageUrl || item.brandImage || 'https://placehold.co/300x200?text=Logo';
    $('#portfolioDetailModal .card-body img').attr('src', brandImg);
    
    // Varlık Detayları
    const type = item.type === 'trademark' ? 'Marka' : 
                 item.type === 'patent' ? 'Patent' : 
                 item.type === 'design' ? 'Tasarım' : 'Diğer';
    const appNo = item.applicationNumber || item.applicationNo || '-';
    const regNo = item.registrationNumber || item.registrationNo || '-';
    const classes = (() => {
        if (Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length) {
            const arr = item.goodsAndServicesByClass.map(c => parseInt(c.classNo,10)).filter(n => !isNaN(n));
            return Array.from(new Set(arr)).sort((a,b)=>a-b).join(', ');
        }
        return item.classes || '-';
    })();
    const status = item.status || item.statusText || 'Bilinmiyor';
    const badgeClass = {
        'Başvuru': 'primary',
        'application_filed': 'primary',
        'Tescilli': 'success',
        'registered': 'success',
        'İtiraz': 'warning',
        'objection': 'warning',
        'Reddedildi': 'danger',
        'rejected': 'danger'
    }[status] || 'secondary';
    
    // Tarihleri formatla
    const formatDate = (dateValue) => {
        if (!dateValue || dateValue === '-') return '-';
        try {
            let date;
            // Firebase Timestamp objesi mi kontrol et
            if (dateValue && typeof dateValue === 'object' && typeof dateValue.toDate === 'function') {
                date = dateValue.toDate();
            } else if (typeof dateValue === 'string' || typeof dateValue === 'number') {
                date = new Date(dateValue);
            } else {
                return '-';
            }
            
            if (isNaN(date.getTime())) return '-';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        } catch (error) {
            console.warn('Tarih formatlama hatası:', error);
            return '-';
        }
    };
    
    const appDate = formatDate(item.applicationDate || item.application_date);
    const regDate = formatDate(item.registrationDate || item.registration_date);
    const renewalDate = formatDate(item.renewalDate || item.renewal_date);

    // Varlık Detayları kartını güncelle
    const detailsCard = $('#portfolioDetailModal .row .col-md-4:eq(1) .card-body');
    detailsCard.html(`
        <p><strong>Tür:</strong> ${type}</p>
        <p><strong>Başvuru No:</strong> ${appNo}</p>
        <p><strong>Tescil No:</strong> ${regNo}</p>
        <p><strong>Sınıf:</strong> ${classes}</p>
    `);
    
// Tarihler/Durum kartını güncelle
    const datesCard = $('#portfolioDetailModal .row .col-md-4:eq(2) .card-body');
    datesCard.html(`
        <p><strong>Başvuru Tarihi:</strong> ${appDate}</p>
        <p><strong>Tescil Tarihi:</strong> ${regDate}</p>
        <p><strong>Yenileme Tarihi:</strong> ${renewalDate}</p>
        <p><strong>Durum:</strong> <span class="badge badge-${badgeClass}">${status}</span></p>
    `);
    
// Eşya Listesi (Mal ve Hizmet Sınıfları)
    const esyaContent = $('#esyaListesiContent');
    if (item.goodsAndServicesByClass && Array.isArray(item.goodsAndServicesByClass) && item.goodsAndServicesByClass.length > 0) {
        let esyaHtml = '';
        item.goodsAndServicesByClass.forEach(cls => {
            const classNo = cls.classNo || '-';
            
            // items array'ini kontrol et ve birleştir
            let description = 'Açıklama yok';
            if (cls.items && Array.isArray(cls.items) && cls.items.length > 0) {
                description = cls.items.join('; ');
            }
            
            esyaHtml += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Sınıf ${classNo}</strong>
                    </div>
                    <div class="card-body">
                        <p>${description}</p>
                    </div>
                </div>
            `;
        });
        esyaContent.html(esyaHtml);
    } else {
        esyaContent.html('<p class="text-muted">Mal ve hizmet bilgisi bulunamadı.</p>');
    }
    
// İşlemler sekmesini doldur (transactions koleksiyonundan)
    await loadTransactions(item.id);
    
    // Modal açıldığında tab'ları sıfırla ve ilk tab'ı aktif yap
    $('#portfolioDetailModal #myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
    $('#portfolioDetailModal .tab-content .tab-pane').removeClass('show active');
    
    // İlk tab'ı aktif yap
    $('#myTab a[href="#modal-islemler"]').addClass('active').attr('aria-selected', 'true');
    $('#modal-islemler').addClass('show active');
});

// Modal kapatıldığında temizlik yap
$(document).on('hidden.bs.modal', '#portfolioDetailModal', function (e) {
    // Modal içindeki tab'ları sıfırla
    $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
    $('#portfolioDetailModal .tab-pane').removeClass('show active');
    
    // İlk tab'ı hazır hale getir (bir sonraki açılış için)
    $('#myTab a[href="#modal-islemler"]').addClass('active').attr('aria-selected', 'true');
    $('#modal-islemler').addClass('show active');
    
    // Ana sayfayı kayıtlı duruma geri yükle
    setTimeout(() => {
        if (window._savedPortfolioState) {
            const savedTab = window._savedPortfolioState.activeTab;
            const savedSidebar = window._savedPortfolioState.sidebarActive;
            
            // Ana content tab'larını sıfırla
            $('.content > .tab-content > .tab-pane').removeClass('show active');
            
            // Kaydedilmiş tab'ı aktif yap
            if (savedTab) {
                $('#' + savedTab).addClass('show active');
            }
            
            // Sidebar'ı güncelle
            $('#sidebar .nav-link').removeClass('active');
            if (savedSidebar) {
                $(`#sidebar a[href="${savedSidebar}"]`).addClass('active');
            }
            
            // Portföy içindeyse, marka listesini ve filtreleri yenile
            if (savedTab === 'portfolio-content') {
                setTimeout(() => {
                    $('#portfolioTopTabs a[href="#marka-list"]').tab('show');
                    
                    if (typeof window.applyMenseFilterToActivePane === 'function') {
                        window.applyMenseFilterToActivePane();
                    }
                    
                    if (window.renderMarkaPagination) {
                        window.renderMarkaPagination();
                    }
                }, 50);
            }
            
            // State'i temizle
            delete window._savedPortfolioState;
        }
    }, 50);
});

// Transactions yükleme fonksiyonu
async function loadTransactions(ipRecordId) {
    const transactionsRef = collection(db, 'ipRecords', ipRecordId, 'transactions');
    const q = query(transactionsRef);
    const snapshot = await getDocs(q);
    
    const transactions = [];
    snapshot.forEach(doc => {
        transactions.push({ id: doc.id, ...doc.data() });
    });
    
    // Transaction type'ın alias değerini al (fonksiyonu döngü dışında tanımla)
    const getTransactionTypeAlias = async (typeId) => {
        if (!typeId) return 'İşlem';
        try {
            const typeDoc = await getDoc(doc(db, 'transactionTypes', String(typeId)));
            if (typeDoc.exists()) {
                return typeDoc.data().alias || typeDoc.data().name || 'İşlem';
            }
        } catch (e) {
            console.warn('Type alias alınamadı:', e);
        }
        return 'İşlem';
    };
    
    // Tarih formatla (fonksiyonu döngü dışında tanımla)
    const formatDate = (timestamp) => {
        if (!timestamp) return '-';
        try {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        } catch (e) {
            return '-';
        }
    };
    
    // Parent transactions'ları filtrele
    const parentTransactions = transactions.filter(t => t.transactionHierarchy === 'parent');
    
    // Tabloyu doldur
    const tableBody = $('#modal-islemler table tbody');
    tableBody.empty();
    
    let rowIndex = 1;
    
    // forEach yerine for...of kullan (await çalışması için)
    for (const parent of parentTransactions) {
        // Child transactions'ları bul
        const children = transactions.filter(t => 
            t.transactionHierarchy === 'child' && t.parentId === parent.id
        );
        
        const hasChildren = children.length > 0;
        const accordionId = `transaction-${parent.id}`;
        
        const transactionAlias = await getTransactionTypeAlias(parent.type);
        
        // Parent satırı
        const parentRow = `
            <tr class="${hasChildren ? 'accordion-header-row' : ''}" ${hasChildren ? `data-toggle="collapse" data-target="#${accordionId}" aria-expanded="false" aria-controls="${accordionId}"` : ''}>
                <td>${hasChildren ? '<i class="fas fa-chevron-right mr-2"></i>' : ''}${rowIndex}</td>
                <td>${transactionAlias}</td>
                <td>${formatDate(parent.timestamp)}</td>
                <td><a href="#" class="btn btn-sm btn-info" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
            </tr>
        `;
        
        tableBody.append(parentRow);
        
        // Child satırları (akordeon içinde)
        if (hasChildren) {
            let childTableHtml = `
                <tr>
                    <td colspan="4" class="p-0">
                        <div class="collapse" id="${accordionId}">
                            <table class="table mb-0 accordion-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>İşlem Açıklaması</th>
                                        <th>Tarih</th>
                                        <th>Evrak</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            for (const [idx, child] of children.entries()) {
                const childAlias = await getTransactionTypeAlias(child.type);
                childTableHtml += `
                    <tr>
                        <td>${rowIndex}.${idx + 1}</td>
                        <td>${childAlias}</td>
                        <td>${formatDate(child.timestamp)}</td>
                        <td><a href="#" class="btn btn-sm btn-info" title="Evrakı Görüntüle"><i class="fas fa-file-pdf"></i></a></td>
                    </tr>
                `;
            }
            
            childTableHtml += `
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            `;
            
            tableBody.append(childTableHtml);
        }
        
        rowIndex++;
    }
}

    // Modal tab'ları için event handler (sadece bir kez tanımla)
    $(document).ready(function() {
    // Tab tıklamalarını düzelt
    $(document).on('click', '#myTab a[data-toggle="tab"]', function (e) {
        e.preventDefault();
        
        // Önce tüm tab'ları pasif yap
        $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
        $('#portfolioDetailModal .tab-pane').removeClass('show active');
        
        // Tıklanan tab'ı aktif yap
        $(this).addClass('active').attr('aria-selected', 'true');
        const target = $(this).attr('href');
        $(target).addClass('show active');
    });
    
    // Tab gösterildiğinde aria attribute'larını güncelle
    $(document).on('shown.bs.tab', '#myTab a[data-toggle="tab"]', function (e) {
        $('#myTab .nav-link').removeClass('active').attr('aria-selected', 'false');
        $(e.target).addClass('active').attr('aria-selected', 'true');
    });
});
})();

</script>
<script>
// --- Sidebar / Top-level tab behavior ---
(function(){
  var $ = window.jQuery;
  if (!$) return;
  // Click: show tab via Bootstrap and prevent default anchor jump scroll
  $('#sidebar a[data-toggle="tab"]').on('click', function(e){
    e.preventDefault();
    $(this).tab('show');
  });
  // When a top-level tab is shown, mark only it as active and update hash
  $('#sidebar a[data-toggle="tab"]').on('shown.bs.tab', function(e){
    $('#sidebar .nav-link').removeClass('active');
    $(e.target).addClass('active');
    var href = $(e.target).attr('href');
    if (href && href.startsWith('#')) {
      history.replaceState(null, '', href);
    }
  });
  // Open tab from URL hash on load / hashchange
  function openHashTab(){
    var hash = window.location.hash;
    if (hash && $('#sidebar a[data-toggle="tab"][href="'+hash+'"]').length) {
      $('#sidebar a[data-toggle="tab"][href="'+hash+'"]').tab('show');
    }
  }
  $(window).on('hashchange', openHashTab);
  // Initial: if no hash, show dashboard
  if (window.location.hash) openHashTab();
  else $('#sidebar a[data-toggle="tab"][href="#dashboard"]').tab('show');
})();
// --- İşlerim Sayfası Navigasyon Mantığı ---

const $tasksMain = $('#task-main-cards');
const $tasksDetail = $('#task-detail-cards');
const $tasksList = $('#task-list-details');
const $tasksHeader = $('#tasksHeaderTitle');
const $tasksLead = $('#tasksLeadText');

// Yeni Global State (Hangi IP türünün seçili olduğunu tutmak için)
window.activeTaskArea = null;

// Ana Kart Tıklaması: Marka, Patent, Tasarım, Dava
$(document).on('click', '.task-card-link', function() {
    const targetArea = $(this).data('target-area');
    window.activeTaskArea = targetArea; // Seçili alanı kaydet
    
    // Tüm ana kartlardan aktif sınıfını kaldır
    $('.task-card-link').removeClass('active-task-area');

    // Tıklanan karta aktif sınıfını ekle
    $(this).addClass('active-task-area');

    // 1. Başlığı ve açıklamayı güncelle
    const headerText = $(this).find('.stat-label').text();
    $tasksHeader.text(headerText); // Örn: Marka İşlemleri
    $tasksLead.text('İncelemek istediğiniz işlem türünü seçin.');
    
    // 2. Ana kartların altına alt kartları yerleştir (HTML yapısını dinamik olarak taşıyoruz)
    // Önce detay kartlarını gizleyelim ve task listesini temizleyelim
    $tasksDetail.hide();
    $tasksList.hide();
    $('#task-list-container').empty(); 

    // 3. Alt kartları ilgili ana kartın hemen altına taşı/göster

    if (targetArea === 'marka-tasks') {
        // Sadece Marka alt kartları için mantığı uyguluyoruz.
        
        // Marka kartının hemen altındaki bir sonraki row'da gösterim yapabiliriz. 
        // Ancak en basit yöntem, detay kartlarını task listesinin hemen üstünde sürekli tutmaktır.

        // Basitleştirilmiş çözüm: Ana kartlar ve alt kartlar aynı row'da değil,
        // alt kartları hemen aşağı kaydırıyoruz.

        // Eğer alt kartlar zaten açıksa kapat
        if ($tasksDetail.is(':visible') && $tasksDetail.data('current-area') === targetArea) {
             $tasksDetail.slideUp(300);
             $tasksDetail.data('current-area', '');
             $tasksHeader.text('İşlerim');
             $tasksLead.text('Lütfen incelemek istediğiniz fikri mülkiyet türünü seçin.');
        } else {
            // Eğer kapalıysa veya farklı bir alan seçilmişse aç
            $tasksDetail.data('current-area', targetArea);
            $tasksDetail.slideDown(300); // Yumuşakça aç
            
            // Eğer diğer kartlar tıklanırsa (Patent, Tasarım), detay kartlarını gizle.
            if (targetArea !== 'marka-tasks') {
                $tasksDetail.hide();
                // Yapım aşamasında mesajı
                $tasksHeader.text(headerText + ' - Yapım Aşamasında');
                $tasksLead.text('Bu kategoriye ait alt işlemler henüz tanımlanmadı. Lütfen Marka İşlemleri sekmesini kullanın.');
            } else {
                 // Marka seçiliyse, detay kartlarının başlığını uygun şekilde ayarla
                 $tasksHeader.text('Marka İşlemleri');
                 $tasksLead.text('İncelemek istediğiniz işlem türünü seçin.');
            }
            
            // Alt kartların sayılarını güncelle (Gerçek uygulamada Firebase çağrısı burada yapılır)
            // updateTaskDetailCounts(linkedPersonIds, 'marka');
        }
    } else {
        // Marka dışındaki kartlar tıklandığında alt kartları kapat
        $tasksDetail.slideUp(300);
        $tasksDetail.data('current-area', '');
        // Yapım aşamasında mesajı
        $tasksHeader.text(headerText + ' - Yapım Aşamasında');
        $tasksLead.text('Bu kategoriye ait alt işlemler henüz tanımlanmadı. Lütfen Marka İşlemleri sekmesini kullanın.');
    }
});

// Detay Kart Tıklaması: Onay Bekleyen İşler, Yenileme Onayları vb.
$(document).on('click', '.detail-card-link', function() {
    const taskType = $(this).data('task-type');
    
    // Filtre alanını seç
    const $tasksFilters = $('#task-list-filters'); // <--- YENİ TANIM

    // Eğer liste zaten açıksa ve aynı türe aitse, kapat
    if ($tasksList.is(':visible') && $tasksList.data('current-type') === taskType) {
        $tasksList.slideUp(300);
        $tasksFilters.slideUp(300); // <--- FİLTRE ALANINI DA KAPAT
        $tasksList.data('current-type', '');
        $tasksHeader.text('Marka İşlemleri'); 
        $tasksLead.text('İncelemek istediğiniz işlem türünü seçin.');
        $('#task-list-container').empty();  
        return;
    }
    
    // 1. Görünümü Detay İş Listesi'ne geçir
    $tasksList.data('current-type', taskType);
    $tasksFilters.slideDown(300); // <--- FİLTRE ALANINI GÖSTER
    $tasksList.slideDown(300); // Listeyi yumuşakça aç
    
    // 2. Başlığı, tıklanan karta göre güncelle
    const headerText = $(this).find('.stat-label').text();
    $tasksHeader.text('Detaylı İş Listesi: ' + headerText);
    $tasksLead.text('Aşağıda seçtiğiniz iş türüne ait tüm işlemler listelenmiştir.');
    
    // 3. İlgili işleri yükleme fonksiyonunu çağır
    loadSampleTaskDetails(taskType); // Bu fonksiyon listeyi doldurur.
    
    // Liste açıldığında listenin olduğu yere yumuşakça kay
    $('html, body').animate({
        scrollTop: $tasksList.offset().top - 100 // Başlık çubuğunun altından başla
    }, 500);
});

window.loadSampleTaskDetails = async function(taskType) {
    const container = document.getElementById('task-list-container');
    container.innerHTML = '<div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Yükleniyor...</p></div>';

    // ... (formatDate fonksiyonu burada kalabilir)
    const formatDate = (v) => {
        if (!v) return '-';
        try {
            if (v && typeof v === 'object' && typeof v.toDate === 'function') {
                const d = v.toDate();
                return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
            }
            const d = new Date(v);
            if (isNaN(d.getTime())) return '-';
            return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
        } catch (e) {
            return '-';
        }
    };
    // ...

    try {
        const user = authService.getCurrentUser();
        if (!user) {
            container.innerHTML = '<p class="lead text-muted text-center mt-5">Kullanıcı girişi yapılmamış.</p>';
            return;
        }

        const userDocRef = doc(db, 'users', user.uid);
        const userSnapshot = await getDoc(userDocRef);
        
        if (!userSnapshot.exists()) {
            container.innerHTML = '<p class="lead text-muted text-center mt-5">Kullanıcı bilgileri bulunamadı.</p>';
            return;
        }

        const linkedPersonIds = userSnapshot.data().linkedPersonIds || [];
        
        if (linkedPersonIds.length === 0) {
            container.innerHTML = '<p class="lead text-muted text-center mt-5">Bağlı müvekkil bulunamadı.</p>';
            return;
        }

        // TÜM TASKLARI ÇEK (Awaiting Client Approval olanlar)
        // Eğer completed-tasks değilse, sadece awaiting_client_approval olanları çekeceğiz.
        const tasksRef = collection(db, 'tasks');
        let tasksQuery;
        
        if (taskType === 'completed-tasks') {
            tasksQuery = query(tasksRef, where('status', '!=', 'awaiting_client_approval'));
        } else {
            tasksQuery = query(tasksRef, where('status', '==', 'awaiting_client_approval'));
        }
        
        const allTasksSnapshot = await runGetDocs(tasksQuery);
        console.log("DEBUG 1: Firestore'dan çekilen tüm görev sayısı (Status Filtresinden sonra):", allTasksSnapshot.size);
        const matchingTasks = [];

        for (const d of allTasksSnapshot.docs) {
            const taskData = d.data();
            
        // Müvekkil ile eşleşme kontrolü
            const relatedPartyId = taskData.details?.relatedParty?.id;
            const personsRelated = taskData.personsRelatedIds || [];
            const clientIdInTask = taskData.clientId || taskData.clientID; // İki varyasyonu da kontrol et

            let isRelatedToClient = false;
            
            // Yayına İtiraz işleri (taskType=20 veya objection_to_trademark_publication) için SADECE clientId kontrolü
            const isObjectionTask = (taskData.taskType === "20" || 
                                     taskData.taskType === 20 || 
                                     taskData.taskType === "objection_to_trademark_publication");
            
            if (isObjectionTask) {
                // Yayına İtiraz: Sadece clientId ile eşleştir
                isRelatedToClient = (clientIdInTask && linkedPersonIds.includes(clientIdInTask));
                console.log(`DEBUG - Yayına İtiraz Eşleştirme: Task ID: ${d.id}, clientId: ${clientIdInTask}, Eşleşti mi: ${isRelatedToClient}`);
            } else {
                // Diğer tüm görevler: Eski kural (relatedParty veya personsRelated)
                isRelatedToClient = 
                    (relatedPartyId && linkedPersonIds.includes(relatedPartyId)) ||
                    (Array.isArray(personsRelated) && personsRelated.some(id => linkedPersonIds.includes(id)));
            }
            
            if (!isRelatedToClient) {
                // Eşleşmeyen görevleri log'layın
                console.log(`DEBUG X: ELENEN GÖREV Task ID: ${d.id}, Task Type: ${taskData.taskType}, Eşleşme Başarısız.`);
                continue;
            }
            console.log("DEBUG 2: Müvekkil ile eşleşen Task ID:", d.id, "Task Type:", taskData.taskType, "Task Status:", taskData.status);
            const meta = await window._getTransactionTypeMeta(taskData.taskType);
            const label = window._taskLabelGuess(taskData, meta);
            const isRenewal = /yenileme/.test(label);
            const isBulletin = window.RX_BULTEN.test(label) || taskData.taskType === '20';
            // Task type'a göre filtreleme
            if (taskType === 'pending-approval') {
                if (!isRenewal && !isBulletin) {
                    matchingTasks.push({ id: d.id, ...taskData });
                }
            } else if (taskType === 'renewal-approval') {
                if (isRenewal) {
                    matchingTasks.push({ id: d.id, ...taskData });
                }
            } else if (taskType === 'bulletin-watch') {
                if (isBulletin) {
                    // Bülten olarak filtrelenen task'ları log'layın
                    console.log("DEBUG 3: Bülten olarak filtrelenen Task ID:", d.id);
                    matchingTasks.push({ id: d.id, ...taskData });
                }
            } else if (taskType === 'completed-tasks') {
                // Completed tasks için zaten where koşulu yukarıda ayarlandı.
                matchingTasks.push({ id: d.id, ...taskData });
            }
        }
        
        // ----------------------------------------------------
        // BÜLTEN İZLEME İÇİN ÖZEL LİSTELEME BAŞLANGIÇ
        // ----------------------------------------------------

        if (taskType === 'bulletin-watch') {
            const bulletinGroups = {};
            
            // Hata ayıklama satırını doğru parantezlerle kapatarak ekliyoruz:
            console.log("DEBUG 4: Bülten taskları gruplanıyor. İlk 5 görev detayı:", 
                matchingTasks.slice(0, 5).map(t => ({ id: t.id, bulletinNo: t.details?.bulletinNo }))
            );

            matchingTasks.forEach(task => {
                const bulletinNo = task.details?.bulletinNo || 'Bilinmeyen Bülten';
                if (!bulletinGroups[bulletinNo]) {
                    bulletinGroups[bulletinNo] = [];
                }
                bulletinGroups[bulletinNo].push(task);
            });

            const sortedBulletinNos = Object.keys(bulletinGroups).sort((a, b) => b - a); // En yeni bülten başta

            if (sortedBulletinNos.length === 0) {
                container.innerHTML = '<p class="lead text-muted text-center mt-5">Bu kategoride onay bekleyen bülten izleme işi bulunmamaktadır.</p>';
                if (window.taskPaginationData.pagination) window.taskPaginationData.pagination.update(0);
                return;
            }

            // Tab HTML yapısını oluştur
            let tabNavHtml = '<ul class="nav nav-tabs mb-3" id="bulletinTabs" role="tablist">';
            let tabContentHtml = '<div class="tab-content" id="bulletinTabContent">';

            sortedBulletinNos.forEach((bulletinNo, index) => {
                const isActive = index === 0;
                const tabId = `bulletin-${bulletinNo}`;
                const tabLinkClass = isActive ? 'active' : '';
                const tabPaneClass = isActive ? 'show active' : '';

                tabNavHtml += `
                    <li class="nav-item">
                        <a class="nav-link ${tabLinkClass}" id="${tabId}-tab" data-toggle="tab" href="#${tabId}-pane" role="tab" aria-controls="${tabId}-pane" aria-selected="${isActive}">
                            Bülten ${bulletinNo} (${bulletinGroups[bulletinNo].length})
                        </a>
                    </li>
                `;

                tabContentHtml += `
                    <div class="tab-pane fade ${tabPaneClass}" id="${tabId}-pane" role="tabpanel" aria-labelledby="${tabId}-tab">
                        <div class="row mt-4" id="bulletin-tasks-row-${bulletinNo}">
                            </div>
                    </div>
                `;
            });

            tabNavHtml += '</ul>';
            tabContentHtml += '</div>';

            // Ana konteynırı tab yapısıyla doldur
            container.innerHTML = tabNavHtml + tabContentHtml;
            
            // İlk tab'ın içeriğini tasklarla doldur (Sadece ilk tab'ı başlangıçta yükleyelim)
            const firstBulletinNo = sortedBulletinNos[0];
            const tasksToRender = bulletinGroups[firstBulletinNo];
            
            // Pagination'ı geçici olarak gizle/sıfırla
            $('#taskPagination').hide();
            
            // İlk bültenin tasklarını render et
            await window._renderTaskCardsToContainer(tasksToRender, `#bulletin-tasks-row-${firstBulletinNo}`, formatDate, taskType);
            
            // Tab click event'i ekle
            $(document).on('shown.bs.tab', '#bulletinTabs a[data-toggle="tab"]', async function (e) {
                const targetPaneId = $(e.target).attr('href'); // #bulletin-474-pane
                const targetBulletinNo = targetPaneId.split('-')[1]; // 474
                const targetRowId = `#bulletin-tasks-row-${targetBulletinNo}`;
                
                // Zaten yüklü olup olmadığını kontrol et
                if ($(targetRowId).html().trim() === '') {
                    const tasks = bulletinGroups[targetBulletinNo];
                    await window._renderTaskCardsToContainer(tasks, targetRowId, formatDate, taskType);
                }
            });

            return; // Bülten izleme için özel akışı tamamla
        }
        
        // ----------------------------------------------------
        // BÜLTEN İZLEME İÇİN ÖZEL LİSTELEME SONU
        // ----------------------------------------------------

        if (matchingTasks.length === 0) {
            container.innerHTML = '<p class="lead text-muted text-center mt-5">Bu kategoride iş bulunmamaktadır.</p>';
            if (window.taskPaginationData.pagination) {
                window.taskPaginationData.pagination.update(0);
            }
            return;
        }
        
        // Klasik pagination akışı (Bülten İzleme dışındaki tipler için)
        $('#taskPagination').show(); 
        window.taskPaginationData.allData = matchingTasks;
        const itemsPerPage = window.taskPaginationData.itemsPerPage || 10;
        
        if (!window.taskPaginationData.pagination) {
            window.taskPaginationData.pagination = new Pagination({
                itemsPerPage: itemsPerPage,
                containerId: 'taskPagination',
                onPageChange: (page, perPage) => {
                    renderTaskPage(page, perPage);
                }
            });
        }

        window.taskPaginationData.pagination.update(matchingTasks.length);
        renderTaskPage(1, itemsPerPage);
        
    } catch (error) {
        console.error('Task yükleme hatası:', error);
        container.innerHTML = '<p class="lead text-danger text-center mt-5">Veriler yüklenirken bir hata oluştu.</p>';
    }
};

const getNiceClasses = (data) => {
    // Önce niceClasses array'ini kontrol et
    if (data?.niceClasses && Array.isArray(data.niceClasses)) {
        return data.niceClasses.sort((a, b) => a - b).join(', ');
    }
    
    // Sonra monitoredNiceClasses
    if (data?.monitoredNiceClasses && Array.isArray(data.monitoredNiceClasses)) {
        return data.monitoredNiceClasses.sort((a, b) => a - b).join(', ');
    }
    
    // String ise parse et
    if (typeof data?.niceClasses === 'string') {
        const parsed = data.niceClasses.split(',').map(c => parseInt(c.trim(), 10)).filter(n => !isNaN(n));
        return parsed.sort((a, b) => a - b).join(', ');
    }
    
    return '-';
}

// Yeni Yardımcı Fonksiyon: Task Kartlarını Belirtilen Konteynere Render Etmek
window._renderTaskCardsToContainer = async function(tasksToRender, containerSelector, formatDate, taskType) {
    const container = document.querySelector(containerSelector);
    if (!container) return;
    
    // Yükleniyor mesajını daha rafine bir şekilde kullan
    container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
    
    const isCompletedView = (taskType === 'completed-tasks');
    const startIndex = 0;

    const taskCards = await Promise.all(tasksToRender.map(async (task, index) => {
        const taskId = task.id;
        const taskNumber = startIndex + index + 1; 
        
        // Varsayılanlar
        let transactionAlias = 'İşlem';
        let ipRecordTitle = '';
        let appNo = '';
        let monitoredMarkData = null;
        let competitorMark = null; // isSimilar: true olan rakip marka verisi

        // 1. Transaction Type Alias'ı Çekme
        if (task.taskType) {
            try {
                const transactionDoc = await getDoc(doc(db, 'transactionTypes', String(task.taskType)));
                if (transactionDoc.exists()) {
                    transactionAlias = (transactionDoc.data().alias || transactionDoc.data().name || 'İşlem').toLocaleUpperCase('tr-TR');
                }
            } catch (e) { }
        }

    // 2. Monitored Marka Bilgisini Çekme
        const monitoredMarkId = task.details?.monitoredMarkId || task.relatedIpRecordId;
        const bulletinNo = task.details?.bulletinNo;
        
        console.log(`🔍 Task ${taskId} - Veri çekme için gerekli bilgiler:`, {
            monitoredMarkId,
            bulletinNo
        });
        
        if (monitoredMarkId && bulletinNo) {
            try {
                // ✅ ADIM 1: trademarkBulletins'den bulletinDate'i al ve bulletinKey oluştur
                let bulletinKey = null;
                
                try {
                    const bulletinsQuery = query(
                        collection(db, 'trademarkBulletins'),
                        where('bulletinNo', '==', bulletinNo),
                        limit(1)
                    );
                    const bulletinSnapshot = await getDocs(bulletinsQuery);
                    
                    if (!bulletinSnapshot.empty) {
                        const bulletinData = bulletinSnapshot.docs[0].data();
                        const bulletinDate = bulletinData.bulletinDate; // "12/08/2025" formatında
                        
                        // bulletinDate'i "12/08/2025" → "12082025" formatına çevir
                        let formattedDate = bulletinDate;
                        if (bulletinDate && bulletinDate.includes('/')) {
                            formattedDate = bulletinDate.split('/').join(''); // "12082025"
                        }
                        
                        // bulletinKey formatı: "474_12082025"
                        bulletinKey = `${bulletinNo}_${formattedDate}`;
                        
                        console.log(`✅ Task ${taskId} - BulletinKey oluşturuldu:`, {
                            bulletinNo,
                            bulletinDate,
                            formattedDate,
                            bulletinKey
                        });
                    } else {
                        console.error(`❌ Task ${taskId} - trademarkBulletins'de bulletinNo bulunamadı:`, bulletinNo);
                    }
                } catch (bulletinQueryErr) {
                    console.error(`❌ Task ${taskId} - BulletinKey sorgu hatası:`, bulletinQueryErr);
                }
                
                if (!bulletinKey) {
                    console.error(`❌ Task ${taskId} - BulletinKey oluşturulamadı, işlem durduruluyor`);
                    throw new Error('BulletinKey bulunamadı');
                }
                
                // ✅ ADIM 2: Doğru path ile monitoringTrademarkRecords'dan belgeyi çek
                const monitoredMarkDoc = await getDoc(
                    doc(db, 'monitoringTrademarkRecords', bulletinKey, 'trademarks', monitoredMarkId)
                );
                
                console.log(`🔍 Task ${taskId} - Belge sorgusu:`, {
                    path: `monitoringTrademarkRecords/${bulletinKey}/trademarks/${monitoredMarkId}`,
                    exists: monitoredMarkDoc.exists()
                });
                
                if (monitoredMarkDoc.exists()) {
                    monitoredMarkData = monitoredMarkDoc.data();
                    console.log(`✅ Task ${taskId} - Monitored Mark Data:`, {
                        id: monitoredMarkId,
                        hasResults: !!monitoredMarkData.results,
                        resultsCount: monitoredMarkData.results?.length || 0
                    });
                    
                    // İzlenen Markanın Bilgilerini Al
                    let monitoredMarkAlias = monitoredMarkData.brandText || monitoredMarkData.markName || monitoredMarkData.title || 'İzlenen Marka';
                    ipRecordTitle = monitoredMarkAlias;
                    appNo = monitoredMarkData.applicationNumber || monitoredMarkData.applicationNo || '-';
                    
                    // ✅ İpRecords'dan ek bilgi çek
                    const ipRecordId = monitoredMarkData.monitoredTrademarkId || monitoredMarkData.ipRecordId || monitoredMarkData.sourceRecordId;
                    if (ipRecordId) {
                        try {
                            const ipDoc = await getDoc(doc(db, 'ipRecords', ipRecordId));
                            if (ipDoc.exists()) {
                                const ipData = ipDoc.data();
                                appNo = ipData.applicationNumber || ipData.applicationNo || appNo;
                                ipRecordTitle = ipData.brandText || ipData.title || ipRecordTitle;
                                
                                // Nice sınıfları ekle
                                if (!monitoredMarkData.niceClasses && ipData.goodsAndServicesByClass) {
                                    monitoredMarkData.niceClasses = ipData.goodsAndServicesByClass
                                        .map(item => item.classNo)
                                        .filter(Boolean);
                                }
                                
                                // Görsel ekle
                                if (!monitoredMarkData.imagePath && ipData.brandImageUrl) {
                                    monitoredMarkData.imagePath = ipData.brandImageUrl;
                                }
                                
                                console.log(`✅ Task ${taskId} - IP Record Data eklendi:`, {
                                    appNo,
                                    title: ipRecordTitle,
                                    niceClasses: monitoredMarkData.niceClasses
                                });
                            }
                        } catch (ipErr) {
                            console.warn(`⚠️ Task ${taskId} - IP kaydı çekilemedi:`, ipErr);
                        }
                    }
                    
                    // 💥 KRİTİK: Benzer (Rakip) Markayı Bul
                    const targetAppNo = task.details?.targetAppNo;

                    console.log(`🎯 Task ${taskId} - Rakip marka arama:`, {
                        targetAppNo,
                        hasResults: !!monitoredMarkData.results,
                        resultsCount: monitoredMarkData.results?.length || 0
                    });

                    // ✅ ÖNCE: monitoringTrademarkRecords/results array'inden targetAppNo ile eşleştir
                    if (targetAppNo && monitoredMarkData.results && Array.isArray(monitoredMarkData.results)) {
                        competitorMark = monitoredMarkData.results.find(res => 
                            String(res.applicationNo || '').trim() === String(targetAppNo).trim()
                        );
                        
                        if (competitorMark) {
                            console.log(`✅ Task ${taskId} - Rakip marka BULUNDU (results array):`, {
                                markName: competitorMark.markName,
                                applicationNo: competitorMark.applicationNo,
                                niceClasses: competitorMark.niceClasses,
                                imagePath: competitorMark.imagePath,
                                isSimilar: competitorMark.isSimilar
                            });
                        } else {
                            console.warn(`⚠️ Task ${taskId} - results array'de eşleşme bulunamadı:`, {
                                targetAppNo,
                                availableAppNos: monitoredMarkData.results.slice(0, 5).map(r => r.applicationNo)
                            });
                        }
                    }

                    // ✅ FALLBACK 1: isSimilar:true olan ilk kaydı al
                    if (!competitorMark && monitoredMarkData.results && Array.isArray(monitoredMarkData.results)) {
                        competitorMark = monitoredMarkData.results.find(res => res.isSimilar === true);
                        if (competitorMark) {
                            console.log(`✅ Task ${taskId} - Rakip marka BULUNDU (isSimilar fallback):`, {
                                markName: competitorMark.markName,
                                applicationNo: competitorMark.applicationNo
                            });
                        }
                    }

                    // ✅ FALLBACK 2: task.details'dan manuel oluştur (son çare)
                    if (!competitorMark && task.details?.objectionTarget) {
                        competitorMark = {
                            markName: task.details.objectionTarget,
                            applicationNo: task.details.targetAppNo || '-',
                            niceClasses: task.details.targetNiceClasses || [],
                            similarityScore: task.details.similarityScore || 0
                        };
                        console.log(`⚠️ Task ${taskId} - Rakip marka OLUŞTURULDU (task.details fallback):`, competitorMark);
                    }

                    if (!competitorMark) {
                        console.error(`❌ Task ${taskId} - Rakip marka BULUNAMADI!`, {
                            targetAppNo,
                            hasResults: !!monitoredMarkData.results,
                            hasDetails: !!task.details
                        });
                    }
                } else {
                    console.error(`❌ Task ${taskId} - Belge bulunamadı!`, {
                        path: `monitoringTrademarkRecords/${bulletinKey}/trademarks/${monitoredMarkId}`
                    });
                }
            } catch (e) {
                console.error(`❌ Task ${taskId} - Monitored Marka çekme hatası:`, e);
            }
        } else {
            console.warn(`⚠️ Task ${taskId} - Eksik veri!`, {
                hasMonitoredMarkId: !!monitoredMarkId,
                hasBulletinNo: !!bulletinNo
            });
        }
        
        // Başlık oluşturma - BENZER MARKANIN bilgilerini kullan
        let taskTitle = `${transactionAlias}`;
        
        if (competitorMark) {
            // Benzer marka varsa, onun bilgilerini kullan
            const competitorAppNo = competitorMark.applicationNo || competitorMark.applicationNumber || '-';
            const competitorName = competitorMark.markName || competitorMark.brandText || 'Benzer Marka';
            taskTitle += ` - ${competitorAppNo} - ${competitorName}`;
        } else if (ipRecordTitle) {
            // Yoksa izlenen markanın bilgilerini kullan (fallback)
            taskTitle += ` - ${appNo} - ${ipRecordTitle}`;
        } else {
            taskTitle += ` - #${taskId}`;
        }
        
        const card = document.createElement('div');
        // ... (Status, Badge, Due Date gibi atamalar)
        
        const statusBadgeClass = {
            'open': 'primary', 'in_progress': 'info', 'completed': 'success', 'closed': 'secondary',
            'awaiting_client_approval': 'warning', 'müvekkil onayı - kapatıldı': 'danger'
        }[task.status] || 'secondary';
        
        const statusText = {
            'open': 'Açık', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'closed': 'Kapalı',
            'awaiting_client_approval': 'Onay Bekliyor', 'müvekkil onayı - kapatıldı': 'Reddedildi/Kapandı'
        }[task.status] || task.status;
        
        let assignedTo = '-'; 
        let actionButtons;
        
        if (isCompletedView) {
            actionButtons = `
                <button class="btn btn-info btn-sm btn-action task-detail" data-task-id="${taskId}"> <i class="fas fa-eye"></i> İncele </button>
                <button class="btn btn-success btn-sm btn-action task-reopen" data-task-id="${taskId}"> <i class="fas fa-folder-open"></i> İşi Aç </button>
            `;
        } else {
             actionButtons = `
                <button class="btn btn-success btn-sm btn-action task-approve" data-task-id="${taskId}"> <i class="fas fa-check"></i> Onayla </button>
                <button class="btn btn-danger btn-sm btn-action task-reject" data-task-id="${taskId}"> <i class="fas fa-times"></i> Reddet </button>
                <button class="btn btn-info btn-sm btn-action task-detail" data-task-id="${taskId}"> <i class="fas fa-eye"></i> İncele </button>
            `;
        }
                // Kendi (İzlenen) Marka Bilgileri
        const myMarkHtml = monitoredMarkData ? `
            <div class="col-6 task-card-comparison-item">
                <h6 class="text-info" style="font-size: 0.9rem; font-weight: 600;">İZLENEN MARKANIZ</h6>
                <div class="d-flex align-items-center mb-2">
                    ${monitoredMarkData.imagePath ? `<img src="${monitoredMarkData.imagePath}" alt="Marka" class="task-brand-image" style="width: 100px; height: 100px; object-fit: contain; margin-right: 10px; border-radius: 4px; transition: transform 0.3s ease; cursor: pointer;">` : ''}
                    <div>
                        <p class="mb-0 text-truncate" style="font-size: 0.9rem;"><strong>Marka:</strong> ${monitoredMarkData.markName || monitoredMarkData.brandText || 'Adı Yok'}</p>
                        <p class="mb-0" style="font-size: 0.8rem;"><strong>B.No:</strong> ${monitoredMarkData.applicationNumber || monitoredMarkData.applicationNo || '-'}</p>
                    </div>
                </div>
                <p class="mb-0" style="font-size: 0.8rem;"><strong>Sınıflar:</strong> ${getNiceClasses(monitoredMarkData)}</p>
            </div>
        ` : `
            <div class="col-6 task-card-comparison-item">
                <h6 class="text-info" style="font-size: 0.9rem; font-weight: 600;">İZLENEN MARKANIZ</h6>
                <p class="text-muted mt-2" style="font-size: 0.8rem;">Portföy bilgisi bulunamadı.</p>
            </div>
        `;

        // Rakip (Benzer) Marka Bilgileri
        const competitorMarkHtml = competitorMark ? `
            <div class="col-6 task-card-comparison-item">
                <h6 class="text-danger" style="font-size: 0.9rem; font-weight: 600;">BENZER MARKA</h6>
                <div class="d-flex align-items-center mb-2">
                    ${competitorMark.imagePath ? `<img src="${competitorMark.imagePath}" alt="Marka" class="task-brand-image" style="width: 100px; height: 100px; object-fit: contain; margin-right: 10px; border-radius: 4px; transition: transform 0.3s ease; cursor: pointer;">` : ''}
                    <div>
                        <p class="mb-0 text-truncate" style="font-size: 0.9rem;"><strong>Marka:</strong> ${competitorMark.markName || 'Bilinmiyor'}</p>
                        <p class="mb-0" style="font-size: 0.8rem;"><strong>B.No:</strong> ${competitorMark.applicationNo || '-'}</p>
                    </div>
                </div>
                <p class="mb-0" style="font-size: 0.8rem;"><strong>Sınıflar:</strong> ${getNiceClasses(competitorMark)}</p>
            </div>
        ` : `
            <div class="col-6 task-card-comparison-item">
                <h6 class="text-danger" style="font-size: 0.9rem; font-weight: 600;">BENZER MARKA</h6>
                <p class="text-muted mt-2" style="font-size: 0.8rem;">İsim benzerliği (isSimilar: true) olan rakip marka bulunamadı.</p>
            </div>
        `;
        
        const due = task.dueDate || task.officialDueDate || task.clientDueDate || task.deadline || null;
        const bulletinInfo = task.details?.bulletinNo ? `<span class="badge badge-info mr-2">Bülten ${task.details.bulletenNo || task.details.bulletinNo}</span>` : '';       
        card.className = 'col-md-12 mb-4';      
        card.innerHTML = `
            <div class="task-card task-card-warning" data-task-id="${taskId}">
                <div class="task-number-tag">${taskNumber}.</div> 
                <h5 class="task-title">#${taskId} - ${taskTitle}</h5>
                
                ${taskType === 'bulletin-watch' ? `
                    <div class="row comparison-area mt-4 mb-3 pt-3">
                        ${myMarkHtml}
                        ${competitorMarkHtml}
                    </div>
                ` : ''}
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="task-meta">
                        ${bulletinInfo}
                        <span class="badge badge-${statusBadgeClass}">${statusText}</span>
                    </small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="task-meta">
                        <i class="fas fa-clock mr-1"></i>
                        ${isCompletedView ? 'Oluşturma Tarihi' : 'Son Onay Tarihi'}: ${formatDate(isCompletedView ? task.createdAt : due)}
                    </small>
                    <div>${actionButtons}</div>
                </div>
            </div>`;

        return card;
    }));
    
    // Konteyner içeriğini temizle ve yeni kartları ekle
    container.innerHTML = ''; 
    taskCards.forEach(card => container.appendChild(card));
};


// --- İŞ LİSTESİ FİLTRELEME MANTIĞI (Büyük/Küçük Harf Duyarsız Hali) ---
function applyTaskListFilters() {
    // 1. Filtre değerlerini al ve tamamen küçük harfe çevir
    const searchText = document.getElementById('taskSearchText').value.toLowerCase().trim();
    const statusFilter = document.getElementById('taskStatusFilter').value.toLowerCase();
    const container = document.getElementById('task-list-container');
    
    // Tüm görev kartlarını al
    const taskCards = container.querySelectorAll('.col-md-12.mb-4');
    
    taskCards.forEach(col => {
        const card = col.querySelector('.task-card');
        if (!card) return;

        // Karttaki arama kriterlerini topla ve tamamen küçük harfe çevir
        // Bu sayede arama her zaman duyarsız olacaktır.
        const taskTitle = card.querySelector('.task-title').textContent.toLowerCase();
        const taskId = card.getAttribute('data-task-id').toLowerCase();
        const currentStatusText = card.querySelector('.badge').textContent.toLowerCase();
        
        // Arama/Başlık kontrolü: Metin araması (İş Tipi, No, Marka Adı, ID)
        const isTextMatch = !searchText || taskTitle.includes(searchText) || taskId.includes(searchText);

        // Durum filtresi kontrolü
        let isStatusMatch = true;
        
        if (statusFilter !== 'tümü') {
            // Statü filtresi değerini, statü metninde arıyoruz.
            // Örneğin, "müvekkil onayı - kapatıldı" filtresi seçildiğinde, 
            // görev kartının metni "reddedildi/kapandı" olabilir. Tam eşleşme zorunlu değil, içeriyor olması yeterli.
            isStatusMatch = currentStatusText.includes(statusFilter);
        }
        
        // Sonuç: Hem metin aramasına hem de durum filtresine uyanları göster
        if (isTextMatch && isStatusMatch) {
            col.style.display = 'block';
        } else {
            col.style.display = 'none';
        }
    });
}

// Task onaylama fonksiyonu
async function approveTask(taskId) {
    try {
        const taskRef = doc(db, "tasks", String(taskId));
        await updateDoc(taskRef, {
            status: "open",
            approvalDate: new Date().toISOString(),
            approvedBy: authService.getCurrentUser()?.uid || null
        });
        
        // Başarı mesajı göster
        alert('İş başarıyla onaylandı!');
        
        // Task kartını DOM'dan kaldır
        $(`.task-card[data-task-id="${taskId}"]`).closest('.col-md-12').fadeOut(300, function() {
            $(this).remove();
            
            // Eğer hiç kart kalmadıysa bilgi mesajı göster
            const remainingCards = $('#task-list-container .task-card').length;
            if (remainingCards === 0) {
                $('#task-list-container').html('<p class="lead text-muted text-center mt-5">Bu kategoride onay bekleyen iş bulunmamaktadır.</p>');
            }
        });
        
        // Dashboard sayaçlarını güncelle
        updateDashboardTaskCount();
        
    } catch (error) {
        console.error('Task onaylama hatası:', error);
        alert('İş onaylanırken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}

// Task reddetme fonksiyonu
async function rejectTask(taskId) {
    // Kullanıcıdan red sebebini al
    const reason = prompt('Red sebebini belirtiniz (opsiyonel):');
    
    // İptal edilmişse işlemi durdur
    if (reason === null) return;
    
    try {
        const taskRef = doc(db, "tasks", String(taskId));
        await updateDoc(taskRef, {
            status: "müvekkil onayı - kapatıldı",
            rejectionDate: new Date().toISOString(),
            rejectedBy: authService.getCurrentUser()?.uid || null,
            rejectionReason: reason || ''
        });
        
        // Başarı mesajı göster
        alert('İş reddedildi.');
        
        // Task kartını DOM'dan kaldır
        $(`.task-card[data-task-id="${taskId}"]`).closest('.col-md-12').fadeOut(300, function() {
            $(this).remove();
            
            // Eğer hiç kart kalmadıysa bilgi mesajı göster
            const remainingCards = $('#task-list-container .task-card').length;
            if (remainingCards === 0) {
                $('#task-list-container').html('<p class="lead text-muted text-center mt-5">Bu kategoride onay bekleyen iş bulunmamaktadır.</p>');
            }
        });
        
        // Dashboard sayaçlarını güncelle
        updateDashboardTaskCount();
        
    } catch (error) {
        console.error('Task reddetme hatası:', error);
        alert('İş reddedilirken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}

// Dashboard task sayacını güncelle
async function updateDashboardTaskCount(){
  try{
    const q = query(collection(db,'tasks'), where('status','==','awaiting_client_approval'));
    const snap = await runGetDocs(q);
    const pendingCount = snap.size;
    $('#dashPendingApprovals').text(pendingCount);
    $('#taskCount-pending-approval').text(pendingCount);
  }catch(e){ console.error(e); }
}

// İşi yeniden aç butonu
$(document).on('click', '.task-reopen', async function() {
    const taskId = $(this).data('task-id');
    
    if (!confirm('Bu işi yeniden açmak istediğinizden emin misiniz?')) {
        return;
    }
    
    try {
        const taskRef = doc(db, "tasks", String(taskId));
        await updateDoc(taskRef, {
            status: "open",
            reopenedAt: new Date().toISOString(),
            reopenedBy: authService.getCurrentUser()?.uid || null
        });
        
        alert('İş başarıyla yeniden açıldı!');
        
        // Listeyi yenile
        const currentTaskType = $('#task-list-details').data('current-type');
        if (currentTaskType) {
            loadSampleTaskDetails(currentTaskType);
        }
        
    } catch (error) {
        console.error('İş açılırken hata:', error);
        alert('İş açılırken bir hata oluştu. Lütfen tekrar deneyin.');
    }
});

// Task butonları için event listener'lar
$(document).on('click', '.task-approve', function() {
    const taskId = $(this).data('task-id');
    if (confirm('Bu işi onaylamak istediğinizden emin misiniz?')) {
        approveTask(taskId);
    }
});

$(document).on('click', '.task-reject', function() {
    const taskId = $(this).data('task-id');
    rejectTask(taskId);
});

$(document).on('click', '.task-detail', async function() {
    const taskId = String($(this).data('task-id'));
    
    try {
        const taskDoc = await getDoc(doc(db, 'tasks', taskId));
        if (!taskDoc.exists()) {
            alert('Task bilgisi bulunamadı.');
            return;
        }
        
        const ipRecordId = taskDoc.data().relatedIpRecordId;
        if (!ipRecordId) {
            alert('Bu task ile ilişkili portföy kaydı bulunamadı.');
            return;
        }
        
        // Fake link elementi oluştur ve modal event'ini tetikle
        const $fakeLink = $('<a>', {
            'data-item-id': ipRecordId,
            'data-toggle': 'modal',
            'data-target': '#portfolioDetailModal'
        });
        
        // Modal'ı aç ve event'i tetikle
        $('#portfolioDetailModal').one('show.bs.modal', function(e) {
            e.relatedTarget = $fakeLink[0];
        }).modal('show');
        
    } catch (error) {
        console.error('Portföy detayı açılırken hata:', error);
        alert('Portföy kaydı yüklenirken bir hata oluştu.');
    }
});

// --- Filtre Event Listener'ları ---
$(document).ready(function() {
    // jQuery'nin yüklü olduğundan emin ol
    const $ = window.jQuery;
    if (!$) return;

    const applyButton = document.getElementById('applyTaskFilters');
    const searchInput = document.getElementById('taskSearchText');
    const statusSelect = document.getElementById('taskStatusFilter');

    // 1. Hızlı Arama (yazıldıkça anlık filtreleme)
    if (searchInput) {
        $(searchInput).on('keyup', function() {
            // Sadece arama metni değişince filtrele
            applyTaskListFilters();
        });
    }
    
    // 2. Statü Değişikliği
    if (statusSelect) {
        $(statusSelect).on('change', function() {
            // Statü değişince filtrele
            applyTaskListFilters();
        });
    }

    // 3. Filtrele Butonu (KeyUp/Change zaten anlık çalışıyor, bu sadece görsel amaçlı kalabilir)
    if (applyButton) {
        $(applyButton).on('click', function(e) {
            e.preventDefault();
            applyTaskListFilters();
        });
    }
});
</script>
</body>
</html>