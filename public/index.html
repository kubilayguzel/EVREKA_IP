<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giri≈ü - IP Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
    }
    
    .auth-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 420px;
      backdrop-filter: blur(10px);
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo {
      font-size: 2.5em;
      font-weight: 700;
      color: #1e3c72;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .logo-icon {
      width: 50px;
      height: 50px;
    }
    
    .subtitle {
      color: #666;
      font-size: 1.1em;
      font-weight: 500;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 30px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 5px;
    }
    
    .tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      background: linear-gradient(45deg, #1e3c72, #2a5298);
      color: #fff;
    }
    
    .form-section {
      display: none;
    }
    
    .form-section.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #1e3c72;
      box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
    }
    
    .error-message {
      color: #dc3545;
      font-size: 0.85em;
      margin-top: 5px;
      display: none;
    }
    
    .error-message.show {
      display: block;
    }
    
    .form-input.error {
      border-color: #dc3545;
    }
    
    .auth-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, #1e3c72, #2a5298);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      margin-bottom: 20px;
      position: relative;
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(30, 60, 114, 0.3);
    }
    
    .auth-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      display: none;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: translateY(-50%) rotate(360deg);
      }
    }
    
    .firebase-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      z-index: 1000;
    }
    
    .firebase-status.connected {
      background: #d4edda;
      color: #155724;
    }
    
    .firebase-status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .helper-links {
      display: flex;
      justify-content: flex-end;
      margin-top: -10px;
      margin-bottom: 20px;
      gap: 12px;
    }
    
    .link-btn {
      background: none;
      border: none;
      color: #1e3c72;
      cursor: pointer;
      font-size: 0.9em;
      text-decoration: underline;
      padding: 0;
    }
    
    @media (max-width: 480px) {
      .auth-container {
        margin: 20px;
        padding: 30px 25px;
      }
      .logo {
        font-size: 2em;
      }
    }
    
    /* NOTIFICATION STYLES - User Management sayfasƒ±ndan alƒ±nmƒ±≈ü */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
    }

    .notification {
        background-color: #fff;
        color: #333;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        min-width: 250px;
        max-width: 350px;
        pointer-events: auto;

        /* Yeni eklenen √ßer√ßeve stili */
        border-left: 5px solid;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), border-color 0.4s ease;
        transform: translateX(120%);
    }

    .notification.show {
        transform: translateX(0);
    }

    /* T√ºrlere g√∂re renk atamasƒ± */
    .notification.success {
        border-color: #28a745;
    }

    .notification.error {
        border-color: #dc3545;
    }

    .notification.warning {
        border-color: #ffc107;
    }

    .notification-icon {
        font-size: 1.5em;
        font-weight: bold;
        line-height: 1;
    }

    .notification.success .notification-icon { color: #28a745; }
    .notification.error .notification-icon { color: #dc3545; }
    .notification.warning .notification-icon { color: #ffc107; }

    .notification-message {
        flex-grow: 1;
        font-size: 0.95em;
        line-height: 1.4;
    }

    .notification-close-btn {
        background: none;
        border: none;
        font-size: 1.2em;
        color: #aaa;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .notification-close-btn:hover {
        color: #555;
    }
  </style>
</head>
<body>
  <div id="firebaseStatus" class="firebase-status">üîÑ Firebase baƒülanƒ±yor...</div>

  <!-- Notification Container - User Management tarzƒ±nda -->
  <div id="notification-container" class="notification-container"></div>

  <div class="auth-container">
    <div class="logo-section">
      <div class="logo">
        <img src="evreka-logo.png" alt="Evreka Logo" class="logo-icon">
        IP Manager
      </div>
      <div class="subtitle">Fikri M√ºlkiyet Y√∂netim Sistemi</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="signin">Giri≈ü Yap</div>
      <div class="tab" data-tab="signup">Kayƒ±t Ol</div>
    </div>

    <!-- Sign In -->
    <div class="form-section active" id="signin-section">
      <form id="signinForm">
        <div class="form-group">
          <label class="form-label" for="signin-email">E-posta Adresi</label>
          <input type="email" id="signin-email" class="form-input" required />
          <div class="error-message" id="signin-email-error"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="signin-password">≈ûifre</label>
          <input type="password" id="signin-password" class="form-input" required />
          <div class="error-message" id="signin-password-error"></div>
        </div>

        <div class="helper-links">
          <button type="button" class="link-btn" id="forgotPasswordBtn">≈ûifremi Unuttum</button>
        </div>

        <button type="submit" class="auth-btn" id="signinBtn">
          <span id="signinText">Giri≈ü Yap</span>
          <span class="loading" id="signinLoading"></span>
        </button>
      </form>
    </div>

    <!-- Sign Up -->
    <div class="form-section" id="signup-section">
      <form id="signupForm">
        <div class="form-group">
          <label class="form-label" for="signup-name">Ad Soyad</label>
          <input type="text" id="signup-name" class="form-input" required />
          <div class="error-message" id="signup-name-error"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="signup-email">E-posta Adresi</label>
          <input type="email" id="signup-email" class="form-input" required />
          <div class="error-message" id="signup-email-error"></div>
        </div>

        <div class="form-group">
          <label class="form-label" for="signup-password">≈ûifre (min. 6 karakter)</label>
          <input type="password" id="signup-password" class="form-input" required minlength="6" />
          <div class="error-message" id="signup-password-error"></div>
        </div>

        <button type="submit" class="auth-btn" id="signupBtn">
          <span id="signupText">Kayƒ±t Ol</span>
          <span class="loading" id="signupLoading"></span>
        </button>
      </form>
    </div>
  </div>

  <script type="module">
  import { authService, auth } from './firebase-config.js';
  import { sendPasswordResetEmail, sendEmailVerification, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // User Management sayfasƒ±ndaki notification sistemini kopyala
    function showNotification(message, type = 'success', duration = 4000) {
      const container = document.getElementById('notification-container');
      if (!container) return;

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const iconMap = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è'
      };

      notification.innerHTML = `
        <span class="notification-icon">${iconMap[type] || '‚úÖ'}</span>
        <span class="notification-message">${message}</span>
        <button class="notification-close-btn" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(notification);

      // Animasyon i√ßin setTimeout
      setTimeout(() => notification.classList.add('show'), 10);

      // Otomatik kaldƒ±rma
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
      }, duration);
    }

    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorEl = document.getElementById(fieldId + '-error');
      
      if (field) field.classList.add('error');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
    }

    function clearAllFieldErrors() {
      document.querySelectorAll('.form-input').forEach(input => {
        input.classList.remove('error');
      });
      document.querySelectorAll('.error-message').forEach(error => {
        error.classList.remove('show');
        error.textContent = '';
      });
    }

    class AuthController {
      constructor() {
        this.currentTab = 'signin';
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.setupAuthStateListener();
        this.checkFirebaseConnectionStatus();
        console.log('üîê Auth Controller initialized');
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            this.switchTab(e.target.dataset.tab);
          });
        });

        // Sign in
        document.getElementById('signinForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleSignIn();
        });

        // Sign up
        document.getElementById('signupForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleSignUp();
        });

        // Forgot password
        document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
          this.handlePasswordReset();
        });
      }

      setupAuthStateListener() {
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            console.log('‚ÑπÔ∏è No authenticated Firebase user.');
            return;
          }

          // Eƒüer kayƒ±t akƒ±≈üƒ± s√ºr√ºyorsa ve kullanƒ±cƒ± hen√ºz doƒürulanmadƒ±ysa:
          const inSignupFlow = sessionStorage.getItem('signup_flow') === '1';
          if (inSignupFlow && !user.emailVerified) {
            // Kayƒ±t akƒ±≈üƒ±nda "Giri≈ü ba≈üarƒ±lƒ±..." mesajƒ±nƒ± bastƒ±rƒ±yoruz.
            console.log('üü° Signup flow in progress, suppressing success notification.');
            return; // Bildirim ve y√∂nlendirme YOK
          }

          // Genel doƒürulama korumasƒ± (opsiyonel ama tavsiye):
          if (!inSignupFlow && !user.emailVerified) {
            showNotification('L√ºtfen e-posta adresinizi doƒürulayƒ±n. Doƒürulama e-postasƒ± az √∂nce g√∂nderilmi≈ü olabilir.', 'warning');
            await authService.signOut();
            return;
          }

          // Kullanƒ±cƒ± doƒürulanmƒ±≈ü ve kayƒ±t akƒ±≈üƒ±nda deƒüil ‚Üí Portfolio'ya git
          sessionStorage.removeItem('signup_flow');
          showNotification('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsunuz...', 'success');
          setTimeout(() => {
            window.location.href = 'portfolio.html';
          }, 1000);
        });
      }

      switchTab(tabName) {
        if (tabName === this.currentTab) return;

        // Tab butonlarƒ±nƒ± g√ºncelle
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Form b√∂l√ºmlerini g√ºncelle
        document.querySelectorAll('.form-section').forEach(section => {
          section.classList.toggle('active', section.id === `${tabName}-section`);
        });

        this.currentTab = tabName;
        clearAllFieldErrors();
      }

      checkFirebaseConnectionStatus() {
        const statusEl = document.getElementById('firebaseStatus');
        if (!statusEl) return;

        if (authService.isFirebaseAvailable) {
          statusEl.textContent = '‚úÖ Firebase baƒülandƒ±';
          statusEl.className = 'firebase-status connected';
          setTimeout(() => statusEl.style.display = 'none', 2000);
        } else {
          statusEl.textContent = '‚ùå Firebase baƒülanamadƒ±';
          statusEl.className = 'firebase-status error';
        }
      }

      async handleSignIn() {
        const email = document.getElementById('signin-email').value.trim();
        const password = document.getElementById('signin-password').value;

        if (!this.validateSignIn(email, password)) return;

        this.setLoading('signin', true);

        try {
          const result = await authService.signIn(email, password);
          if (result.success) {
            console.log('üü¢ Sign in successful, auth state will handle navigation');
          } else {
            showNotification(result.error || 'Giri≈ü ba≈üarƒ±sƒ±z.', 'error');
          }
          // onAuthStateChanged gerekli aksiyonlarƒ± alacak
        } catch (err) {
          console.error('Final sign in error catch:', err);
          showNotification('Giri≈ü sƒ±rasƒ±nda beklenmeyen bir hata olu≈ütu.', 'error');
        } finally {
          this.setLoading('signin', false);
        }
      }

      async handleSignUp() {
          const name = document.getElementById('signup-name').value.trim();
          const email = document.getElementById('signup-email').value.trim();
          const password = document.getElementById('signup-password').value;

          if (!this.validateSignUp(name, email, password)) return;

          this.setLoading('signup', true);
          sessionStorage.setItem('signup_flow', '1');

          try {
              const result = await authService.signUp(email, password, name, 'user');
              if (result.success) {
                  const user = auth.currentUser;
                  if (user) {
                      // Ad-soyad bilgisini Firebase Auth'a kaydet
                      await updateProfile(user, { displayName: name });

                      try {
                          await sendEmailVerification(user);
                          showNotification('Doƒürulama e-postasƒ± g√∂nderildi. L√ºtfen e-postanƒ±zƒ± doƒürulayƒ±p giri≈ü yapƒ±n.', 'success');
                      } catch (ve) {
                          console.error('sendEmailVerification error:', ve);
                          showNotification('Doƒürulama e-postasƒ± g√∂nderilemedi. Daha sonra tekrar deneyin.', 'error');
                      }
                      await authService.signOut();
                      this.switchTab('signin');
                  } else {
                      showNotification('Hesap olu≈üturuldu. L√ºtfen e-postanƒ±zƒ± doƒürulayƒ±n ve giri≈ü yapƒ±n.', 'success');
                      this.switchTab('signin');
                  }
              } else {
                  showNotification(result.error || 'Kayƒ±t ba≈üarƒ±sƒ±z.', 'error');
              }
          } catch (err) {
              console.error('Final sign up error catch:', err);
              showNotification('Kayƒ±t sƒ±rasƒ±nda beklenmeyen bir hata olu≈ütu.', 'error');
          } finally {
              this.setLoading('signup', false);
              sessionStorage.removeItem('signup_flow');
          }
      }

      async handlePasswordReset() {
        const email = prompt('≈ûifre sƒ±fƒ±rlama i√ßin e-posta adresinizi girin:');
        if (!email || !this.isValidEmail(email)) {
          showNotification('Ge√ßerli bir e-posta adresi girin.', 'error');
          return;
        }

        try {
          await sendPasswordResetEmail(auth, email);
          showNotification('≈ûifre sƒ±fƒ±rlama e-postasƒ± g√∂nderildi. Gelen kutunuzu kontrol edin.', 'success');
        } catch (err) {
          console.error('Password reset error:', err);
          let msg = 'ƒ∞≈ülem ger√ßekle≈ütirilemedi.';
          if (err?.code === 'auth/user-not-found') msg = 'Bu e-posta ile kullanƒ±cƒ± bulunamadƒ±.';
          else if (err?.code === 'auth/invalid-email') msg = 'Ge√ßersiz e-posta adresi.';
          showNotification(msg, 'error');
        }
      }

      validateSignIn(email, password) {
        clearAllFieldErrors();
        let isValid = true;
        if (!email) { showFieldError('signin-email','E-posta adresi gerekli'); isValid = false; }
        if (!password) { showFieldError('signin-password','≈ûifre gerekli'); isValid = false; }
        return isValid;
      }

      validateSignUp(name, email, password) {
        clearAllFieldErrors();
        let isValid = true;
        if (!name || name.length < 2) { showFieldError('signup-name','Ad soyad en az 2 karakter'); isValid = false; }
        if (!email) { showFieldError('signup-email','E-posta adresi gerekli'); isValid = false; }
        else if (!this.isValidEmail(email)) { showFieldError('signup-email','Ge√ßerli bir e-posta girin'); isValid = false; }
        if (!password) { showFieldError('signup-password','≈ûifre gerekli'); isValid = false; }
        else if (password.length < 6) { showFieldError('signup-password','≈ûifre en az 6 karakter'); isValid = false; }
        return isValid;
      }

      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      setLoading(form, isLoading) {
        const btn = document.getElementById(`${form}Btn`);
        const text = document.getElementById(`${form}Text`);
        const loading = document.getElementById(`${form}Loading`);
        if (btn) btn.disabled = isLoading;
        if (text) text.style.display = isLoading ? 'none' : 'inline';
        if (loading) loading.style.display = isLoading ? 'inline-block' : 'none';
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      new AuthController();
    });

  </script>
</body>
</html>