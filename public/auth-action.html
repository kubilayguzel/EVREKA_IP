<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Manager - Doğrulama & Şifre Sıfırlama</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fb;color:#1f2d3d}
    .wrap{max-width:560px;margin:6vh auto;background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.08);padding:28px}
    h1{font-size:1.35rem;margin:0 0 8px;color:#1e3c72}
    p{margin:8px 0 14px;color:#334e68}
    .muted{color:#6b7c93;font-size:.95rem}
    .ok{background:#e6fffa;color:#006d5b;border:1px solid #b2f5ea;border-radius:10px;padding:12px 14px;margin:10px 0}
    .err{background:#ffe6e6;color:#7a1e1e;border:1px solid #ffb3b3;border-radius:10px;padding:12px 14px;margin:10px 0}
    .form-group{margin:12px 0}
    .form-input{width:100%;padding:12px 14px;border:2px solid #e1e8ed;border-radius:10px;font-size:1rem}
    .form-input:focus{outline:none;border-color:#1e3c72;box-shadow:0 0 0 3px rgba(30,60,114,.1)}
    .btn{display:inline-block;background:linear-gradient(45deg,#1e3c72,#2a5298);color:#fff;border:none;border-radius:10px;padding:12px 16px;
         font-weight:700;cursor:pointer;text-decoration:none;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(30,60,114,.25)}
    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">İşlem Yürütülüyor…</h1>
    <p id="desc" class="muted">Lütfen bekleyin, isteğiniz işleniyor.</p>

    <div id="panel"></div>

    <div class="actions">
      <a class="btn" href="index.html">Giriş Sayfasına Dön</a>
      <a class="btn" href="mailto:support@evrekapatent.com">Destek Al</a>
    </div>
  </div>

  <script type="module">
    import { auth } from './firebase-config.js';
    import { applyActionCode, verifyPasswordResetCode, confirmPasswordReset } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { showNotification } from './utils.js';

    auth.languageCode = 'tr';

    const qs = new URLSearchParams(location.search);
    const mode   = qs.get('mode');     // 'verifyEmail' | 'resetPassword' | ...
    const oobCode= qs.get('oobCode');  // işlem kodu

    const $ = (id) => document.getElementById(id);
    const title = $('title');
    const desc  = $('desc');
    const panel = $('panel');

    function setStatus(html, ok=true){
      panel.innerHTML = `<div class="${ok?'ok':'err'}">${html}</div>`;
    }

    async function run(){
      try {
        if (!mode || !oobCode){
          setStatus('Geçersiz bağlantı. Lütfen e-postadaki linke tekrar tıklayın veya yeni bir istek oluşturun.', false);
          return;
        }

        if (mode === 'verifyEmail'){
          title.textContent = 'E-posta Doğrulama';
          desc.textContent  = 'Hesabınız doğrulanıyor…';
          try {
            await applyActionCode(auth, oobCode);
            setStatus('E-posta adresiniz başarıyla doğrulandı. Artık giriş yapabilirsiniz.');
            showNotification('E-posta doğrulandı. Şimdi giriş yapabilirsiniz.', 'success');
          } catch (e){
            setStatus('Doğrulama bağlantısı geçersiz veya süresi dolmuş.', false);
            showNotification('Bağlantı geçersiz veya süresi dolmuş.', 'error');
          }
          return;
        }

        if (mode === 'resetPassword'){
          title.textContent = 'Şifre Sıfırlama';
          desc.textContent  = 'Yeni şifrenizi belirleyin.';

          let email;
          try {
            email = await verifyPasswordResetCode(auth, oobCode);
          } catch (e){
            setStatus('Bu şifre sıfırlama bağlantısı geçersiz veya süresi dolmuş.', false);
            return;
          }

          panel.innerHTML = `
            <form id="resetForm">
              <p class="muted">Hesap: <strong>${email}</strong></p>
              <div class="form-group">
                <input id="newPass" type="password" class="form-input" placeholder="Yeni şifre (en az 6 karakter)" minlength="6" required autocomplete="new-password">
              </div>
              <div class="form-group">
                <input id="newPass2" type="password" class="form-input" placeholder="Yeni şifre (tekrar)" minlength="6" required autocomplete="new-password">
              </div>
              <button class="btn" type="submit">Şifreyi Kaydet</button>
            </form>
          `;

          document.getElementById('resetForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const p1 = (document.getElementById('newPass').value || '').trim();
            const p2 = (document.getElementById('newPass2').value || '').trim();
            if (p1.length < 6){
              showNotification('Şifre en az 6 karakter olmalı.', 'error'); return;
            }
            if (p1 !== p2){
              showNotification('Şifreler eşleşmiyor.', 'error'); return;
            }
            try {
              await confirmPasswordReset(auth, oobCode, p1);
              setStatus('Şifreniz başarıyla güncellendi. Giriş sayfasına dönebilirsiniz.');
              showNotification('Şifre güncellendi. Giriş yapabilirsiniz.', 'success');
            } catch (err){
              console.error(err);
              setStatus('Şifre güncellenemedi. Bağlantı süresi dolmuş olabilir.', false);
              showNotification('Şifre güncellenemedi.', 'error');
            }
          });

          return;
        }

        setStatus('Desteklenmeyen işlem türü.', false);
      } catch (err){
        console.error(err);
        setStatus('İşlem tamamlanamadı. Lütfen daha sonra tekrar deneyin.', false);
        showNotification('İşlem tamamlanamadı.', 'error');
      }
    }

    run();
  </script>

  <div id="notification-container" class="notification-container"></div>
</body>
</html>
