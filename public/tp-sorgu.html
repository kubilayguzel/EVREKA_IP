<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>TÜRKPATENT Sorgu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <style>
    .status-info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    .status-success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .status-error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .status-warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
    .debug-info { font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; }
    .screenshot-container { max-width: 100%; overflow: hidden; }
    .screenshot-container img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <h5 class="mb-3">🔍 TÜRKPATENT Sorgu Sonucu</h5>
        
        <!-- Status Display -->
        <div id="status" class="alert status-info">
          <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
            <span>Sorgulanıyor... Lütfen bekleyin.</span>
          </div>
        </div>

        <!-- Progress Steps -->
        <div id="progress" class="mb-3" style="display: none;">
          <small class="text-muted">İşlem Adımları:</small>
          <div class="progress mt-1" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
          </div>
          <ul id="stepsList" class="list-unstyled mt-2 small"></ul>
        </div>

        <!-- Result Display -->
        <div id="result"></div>
      </div>
      
      <!-- Debug Panel -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">🔧 Debug Bilgileri</h6>
          </div>
          <div class="card-body">
            <div id="debugInfo" class="debug-info small text-muted">
              Henüz veri yok...
            </div>
          </div>
        </div>
        
        <!-- Screenshot Display -->
        <div id="shotWrap" class="card mt-3" style="display: none;">
          <div class="card-header">
            <h6 class="mb-0">📸 Ekran Görüntüsü</h6>
          </div>
          <div class="card-body screenshot-container">
            <img id="shot" alt="screen" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const params = new URLSearchParams(location.search);
      const number = params.get('no');
      const type = params.get('type') || 'application';
      
      const statusEl = document.getElementById('status');
      const progressEl = document.getElementById('progress');
      const progressBar = progressEl.querySelector('.progress-bar');
      const stepsList = document.getElementById('stepsList');
      const resultEl = document.getElementById('result');
      const debugEl = document.getElementById('debugInfo');
      const shotWrap = document.getElementById('shotWrap');
      const shotImg = document.getElementById('shot');

      function updateStatus(message, type = 'info', showSpinner = false) {
        statusEl.className = `alert status-${type}`;
        statusEl.innerHTML = showSpinner 
          ? `<div class="d-flex align-items-center">
               <div class="spinner-border spinner-border-sm mr-2" role="status"></div>
               <span>${message}</span>
             </div>`
          : message;
      }

      function updateProgress(percentage, step = '') {
        progressEl.style.display = percentage > 0 ? 'block' : 'none';
        progressBar.style.width = `${percentage}%`;
        
        if (step) {
          const li = document.createElement('li');
          li.textContent = `✓ ${step}`;
          li.className = 'text-success';
          stepsList.appendChild(li);
        }
      }

      function updateDebug(data) {
        const debugText = JSON.stringify(data, null, 2);
        debugEl.innerHTML = `<pre>${debugText}</pre>`;
      }

      if (!number) {
        updateStatus('❌ URL\'de "no" parametresi bulunamadı.', 'error');
        return;
      }

      // Güncellenmiş fonksiyon URL'ini buraya yazın
      const FN_URL = 'https://europe-west1-ip-manager-production-aab4b.cloudfunctions.net/tpQueryV2';
      try {
        updateStatus('🚀 TÜRKPATENT sitesine bağlanılıyor...', 'info', true);
        updateProgress(10, 'Bağlantı başlatılıyor');

        const startTime = Date.now();
        const response = await fetch(FN_URL, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            applicationNumber: number,
            type: type 
          })
        });

        const data = await response.json();
        const duration = Date.now() - startTime;

        updateDebug({
          requestId: data.rid,
          duration: `${duration}ms`,
          inputSelector: data.usedInputSelector,
          buttonSelector: data.usedButtonSelector,
          tabActivated: data.tabActivated,
          networkResponses: data.net?.responses?.length || 0,
          networkFails: data.net?.fails?.length || 0,
          steps: data.steps?.length || 0
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${data.error || 'Bilinmeyen hata'}`);
        }

        if (!data.ok) {
          throw new Error(data.message || data.error || 'Sorgu başarısız');
        }

        updateProgress(100, 'Sorgu tamamlandı');
        updateStatus(`✅ Sorgu başarıyla tamamlandı (${duration}ms)`, 'success');

        // Sonucu göster
        if (data.html && data.html.trim()) {
          resultEl.innerHTML = `
            <div class="card">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">📋 Sorgu Sonucu</h6>
              </div>
              <div class="card-body">
                ${data.html}
              </div>
            </div>
          `;
        } else {
          resultEl.innerHTML = `
            <div class="alert alert-warning">
              <strong>⚠️ Uyarı:</strong> Sorgu tamamlandı ancak sonuç bulunamadı veya boş döndü.
            </div>
          `;
        }

        // Screenshot varsa göster
        if (data.screenshot) {
          shotImg.src = 'data:image/png;base64,' + data.screenshot;
          shotWrap.style.display = 'block';
        }

        // Adım bilgilerini göster
        if (data.steps && data.steps.length > 0) {
          stepsList.innerHTML = '';
          data.steps.forEach(step => {
            const li = document.createElement('li');
            li.innerHTML = `<small><code>${step.step}</code> ${step.ms ? `(${step.ms}ms)` : ''}</small>`;
            li.className = step.step.includes('fail') ? 'text-danger' : 'text-success';
            stepsList.appendChild(li);
          });
        }

      } catch (error) {
        console.error('Sorgu hatası:', error);
        updateProgress(0);
        updateStatus(`❌ Sorgu başarısız: ${error.message}`, 'error');
        
        updateDebug({
          error: error.message,
          stack: error.stack,
          timestamp: new Date().toISOString()
        });

        // Hata durumunda önerileri göster
        resultEl.innerHTML = `
          <div class="alert alert-danger">
            <h6>🚨 Hata Oluştu</h6>
            <p><strong>Hata:</strong> ${error.message}</p>
            <hr>
            <h6>💡 Çözüm Önerileri:</h6>
            <ul>
              <li>CAPTCHA tespit edildiyse, birkaç dakika bekleyip tekrar deneyin</li>
              <li>Başvuru numarasının doğru formatda olduğundan emin olun</li>
              <li>TÜRKPATENT sitesi geçici olarak erişilemez durumda olabilir</li>
              <li>Proxy/VPN kullanıyorsanız kapatmayı deneyin</li>
            </ul>
            <button class="btn btn-primary btn-sm mt-2" onclick="window.location.reload()">
              🔄 Tekrar Dene
            </button>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>