<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>TÜRKPATENT Sorgu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
</head>
<body class="p-3">
  <div class="container">
    <h5 class="mb-3">TÜRKPATENT Sorgu Sonucu</h5>
    <div id="status" class="alert alert-info">Sorgulanıyor…</div>
    <div id="result"></div>
    <div id="shotWrap" class="mt-3 d-none">
      <h6>Ekran Görüntüsü</h6>
      <img id="shot" class="img-fluid" alt="screen"/>
    </div>
  </div>

  <script>
    (async () => {
      const p = new URLSearchParams(location.search);
      const number = p.get('no');
      const type = p.get('type') || 'application';
      if (!number) {
        document.getElementById('status').className = 'alert alert-danger';
        document.getElementById('status').textContent = 'no parametresi yok.';
        return;
      }

      // Fonksiyon URL’inizi deploy sonrası buraya yazın:
      // Örn: https://europe-west1-<PROJECT_ID>.cloudfunctions.net/tpQueryV2
      const FN_URL = 'https://europe-west1-ip-manager-production-aab4b.cloudfunctions.net/tpQueryV2';

      try {
        const r = await fetch(FN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, number })
        });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'Hata');

        document.getElementById('status').className = 'alert alert-success';
        document.getElementById('status').textContent = 'Sonuç yüklendi.';

        // Gelen HTML’i göster
        const box = document.getElementById('result');
        box.innerHTML = data.html || '<div class="text-muted">Boş sonuç döndü.</div>';

        // Küçük ekran görüntüsü de varsa
        if (data.screenshot) {
          document.getElementById('shot').src = 'data:image/png;base64,' + data.screenshot;
          document.getElementById('shotWrap').classList.remove('d-none');
        }
      } catch (e) {
        document.getElementById('status').className = 'alert alert-danger';
        document.getElementById('status').textContent = 'Sorgu başarısız: ' + e.message;
      }
    })();
  </script>
</body>
</html>
